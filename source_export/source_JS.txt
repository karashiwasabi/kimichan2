----- C:\Users\wasab\OneDrive\デスクトップ\kimichan2\static\js\app.js -----
document.addEventListener('DOMContentLoaded', () => {
    const appContainer = document.getElementById('app-container');
    const navItems = document.querySelectorAll('.nav-item');

    function loadView(viewName) {
        // ナビゲーションの見た目を更新
        navItems.forEach(nav => {
            if (nav.dataset.view === viewName) {
                nav.classList.add('active');
            } else {
                nav.classList.remove('active');
            }
        });

        fetch(`views/${viewName}_view.html`)
            .then(response => {
                if (!response.ok) throw new Error('View not found');
                return response.text();
            })
            .then(html => {
                appContainer.innerHTML = html;
                
                if (viewName === 'catalog' && typeof initCatalog === 'function') {
                    initCatalog();
                } else if (viewName === 'inventory' && typeof initInventory === 'function') {
                    initInventory();
                } else if (viewName === 'seasoning' && typeof initSeasoning === 'function') {
                    initSeasoning();
                } else if (viewName === 'recipes' && typeof initRecipes === 'function') {
                    initRecipes(); // 追加
                }
            })
            .catch(err => {
                appContainer.innerHTML = '<p style="text-align:center; margin-top:50px;">読み込みエラー</p>';
                console.error(err);
            });
    }

    navItems.forEach(item => {
        item.addEventListener('click', (e) => {
            e.preventDefault();
            const viewName = item.dataset.view;
            loadView(viewName);
        });
    });

    // 初期表示
    loadView('inventory');
});

----- C:\Users\wasab\OneDrive\デスクトップ\kimichan2\static\js\catalog_edit.js -----
// --- UIセットアップ ---
function setupCatalogUI() {
    const fab = document.getElementById('fab-add');
    const overlay = document.getElementById('modal-overlay');
    const btnCancel = document.getElementById('btn-cancel');
    const btnSave = document.getElementById('btn-save');
    // HTML側に追加が必要な削除ボタン
    const btnDelete = document.getElementById('btn-delete-catalog');
    
    const tabSingle = document.getElementById('tab-single');
    const tabCsv = document.getElementById('tab-csv');
    const singleContainer = document.getElementById('form-single');
    const csvContainer = document.getElementById('form-csv');
    
    const searchInput = document.getElementById('catalog-search');
    const sortSelect = document.getElementById('sort-order');
    const noKanaCheck = document.getElementById('filter-no-kana');
    const nameInput = document.getElementById('input-name');

    const scrollLeft = document.getElementById('scroll-left');
    const scrollRight = document.getElementById('scroll-right');
    const scrollContainer = document.getElementById('category-filters');

    // 横スクロール制御
    if(scrollLeft && scrollContainer) {
        scrollLeft.onclick = () => scrollContainer.scrollBy({ left: -100, behavior: 'smooth' });
        scrollRight.onclick = () => scrollContainer.scrollBy({ left: 100, behavior: 'smooth' });
    }

    if (!fab) return;

    // 新規登録ボタン
    fab.addEventListener('click', () => {
        resetModal('アイテム登録');
        document.getElementById('edit-id').value = '';
        document.getElementById('original-name').value = ''; // 新規なので空
        
        // 削除ボタンは新規登録時は隠す
        if(btnDelete) btnDelete.style.display = 'none';

        // 現在のカテゴリを選択状態にする
        // currentCategoryは catalog_list.js のグローバル変数想定
        const currentCat = (typeof currentCategory !== 'undefined' && currentCategory !== 'すべて' && currentCategory !== '未分類') ? currentCategory : '';
        updateCategorySelect(currentCat);
        
        overlay.classList.add('active');
    });

    btnCancel.addEventListener('click', () => {
        overlay.classList.remove('active');
        removeConflictUI();
    });

    // 削除ボタンイベント
    if (btnDelete) {
        btnDelete.addEventListener('click', () => {
            const id = document.getElementById('edit-id').value;
            const name = document.getElementById('input-name').value;
            if(id) deleteCatalogItem(id, name);
        });
    }

    // リスト側のフィルタ関数を呼び出すイベント
    if (typeof filterAndRender === 'function') {
        searchInput.addEventListener('input', filterAndRender);
        sortSelect.addEventListener('change', filterAndRender);
        noKanaCheck.addEventListener('change', filterAndRender);
    }

    // 名前入力時の類似検索
    nameInput.addEventListener('input', (e) => {
        updateReferenceList(e.target.value);
    });

    // タブ切り替え
    tabSingle.addEventListener('click', () => switchTab('single'));
    tabCsv.addEventListener('click', () => switchTab('csv'));

    // 保存実行
    btnSave.addEventListener('click', () => {
        if (singleContainer.style.display !== 'none') {
            saveSingleItem();
        } else {
            saveCsvItem();
        }
    });
}

// --- モーダル制御・ヘルパー ---

function switchTab(mode) {
    const tabSingle = document.getElementById('tab-single');
    const tabCsv = document.getElementById('tab-csv');
    const singleContainer = document.getElementById('form-single');
    const csvContainer = document.getElementById('form-csv');

    if (mode === 'single') {
        tabSingle.classList.add('active');
        tabCsv.classList.remove('active');
        singleContainer.style.display = 'block';
        csvContainer.style.display = 'none';
    } else {
        tabCsv.classList.add('active');
        tabSingle.classList.remove('active');
        singleContainer.style.display = 'none';
        csvContainer.style.display = 'block';
    }
    removeConflictUI();
    document.getElementById('csv-result-area').style.display = 'none';
}

function resetModal(titleText) {
    document.getElementById('modal-title').textContent = titleText;
    document.getElementById('original-unit').value = '';
    document.getElementById('input-name').value = '';
    document.getElementById('input-kana').value = '';
    document.getElementById('input-unit').value = '';
    document.getElementById('input-csv-text').value = '';
    document.getElementById('reference-area').style.display = 'none';
    document.getElementById('csv-result-area').style.display = 'none';
    switchTab('single');
}

async function openCatalogEditModal(item) {
    resetModal('アイテム編集');
    
    const overlay = document.getElementById('modal-overlay');
    const btnDelete = document.getElementById('btn-delete-catalog');
    
    document.getElementById('edit-id').value = item.id;
    document.getElementById('original-unit').value = item.default_unit || '';
    document.getElementById('original-name').value = item.name || ''; 

    document.getElementById('input-classification').value = item.classification;
    updateCategorySelect(item.category);

    document.getElementById('input-name').value = item.name;
    document.getElementById('input-kana').value = item.kana || '';
    document.getElementById('input-unit').value = item.default_unit;

    // ★削除ボタンの制御 (使用状況チェック)
    if (btnDelete) {
        btnDelete.style.display = 'none'; // 一旦隠す
        try {
            const res = await fetch(`/api/catalog/usage?id=${item.id}`);
            const usage = await res.json();
            
            // レシピに使われていなければ削除ボタンを表示
            if (usage.recipe_count === 0) {
                btnDelete.style.display = 'inline-block';
            }
        } catch(e) {
            console.error('Usage check failed:', e);
        }
    }

    if (item.name) {
        updateReferenceList(item.name);
    }

    overlay.classList.add('active');
}

function removeConflictUI() {
    const conflictDiv = document.getElementById('conflict-resolution-area');
    if (conflictDiv) conflictDiv.remove();
    const btnSave = document.getElementById('btn-save');
    if (btnSave) {
        btnSave.style.display = 'block';
        btnSave.textContent = '保存';
    }
}

function updateCategorySelect(selectedCategory) {
    const select = document.getElementById('select-category');
    const input = document.getElementById('input-category');
    
    // catalogDataは catalog_list.js で定義されたグローバル変数
    const categories = new Set();
    if (typeof catalogData !== 'undefined') {
        catalogData.forEach(d => {
            if(d.category) categories.add(d.category);
        });
    }

    select.innerHTML = '<option value="">(新規入力)</option>';
    categories.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        select.appendChild(opt);
    });

    if (categories.has(selectedCategory)) {
        select.value = selectedCategory;
        input.style.display = 'none';
        input.value = selectedCategory;
    } else {
        select.value = "";
        input.style.display = 'block';
        input.value = selectedCategory || "";
    }

    select.onchange = () => {
        if (select.value === "") {
            input.style.display = 'block';
            input.value = "";
        } else {
            input.style.display = 'none';
            input.value = select.value;
        }
    };
}

// --- 類似・参考機能 ---

function updateReferenceList(name) {
    const refArea = document.getElementById('reference-area');
    const refList = document.getElementById('reference-list');
    
    if (!name || name.length < 1 || typeof catalogData === 'undefined') {
        refArea.style.display = 'none';
        return;
    }

    const term = name.toLowerCase();
    
    // 双方向部分一致
    const hits = catalogData.filter(d => {
        const targetName = d.name.toLowerCase();
        const targetKana = d.kana ? d.kana.toLowerCase() : '';
        
        const dbContainsInput = targetName.includes(term) || (targetKana && targetKana.includes(term));
        const inputContainsDb = term.includes(targetName) || (targetKana && term.includes(targetKana));

        return dbContainsInput || inputContainsDb;
    }).slice(0, 8); 

    if (hits.length === 0) {
        refArea.style.display = 'none';
        return;
    }

    refList.innerHTML = '';
    hits.forEach(hit => {
        const chip = document.createElement('div');
        chip.style.cssText = 'background:white; border:1px solid #ccc; padding:4px 8px; border-radius:12px; font-size:11px; cursor:pointer; display:flex; align-items:center; gap:5px;';
        chip.innerHTML = `
            <span style="color:#888;">[${hit.classification}/${hit.category||'-'}]</span>
            <strong>${hit.name}</strong>
        `;
        chip.onclick = () => applyReferenceItem(hit);
        refList.appendChild(chip);
    });
    refArea.style.display = 'block';
}

function applyReferenceItem(item) {
    if (!confirm(`この食材を「${item.name}」として設定（統合）しますか？\n\n※保存時に統合の確認が表示されます。`)) return;

    document.getElementById('input-name').value = item.name;
    document.getElementById('input-kana').value = item.kana || '';
    document.getElementById('input-classification').value = item.classification;
    
    updateCategorySelect(item.category);
    document.getElementById('input-unit').value = item.default_unit || '';
}

// --- 保存・削除処理 ---

async function saveSingleItem() {
    const id = document.getElementById('edit-id').value;
    const name = document.getElementById('input-name').value;
    const originalUnit = document.getElementById('original-unit').value;
    const originalName = document.getElementById('original-name').value;
    const newUnit = document.getElementById('input-unit').value;

    if (!name) return alert('名前を入力してください');

    // 影響範囲チェック
    if (id && name !== originalName) {
        try {
            const usageRes = await fetch(`/api/catalog/usage?id=${id}`);
            const usage = await usageRes.json();
            
            if (usage.recipe_count > 0) {
                const examples = usage.recipe_names.join('、') + (usage.recipe_count > 3 ? '...' : '');
                const msg = `⚠️ この食材は ${usage.recipe_count} 件のレシピで使用されています。\n` +
                            `（使用例: ${examples}）\n\n` +
                            `名前を「${originalName}」から「${name}」に変更すると、それらのレシピの表示も全て変わります。\n\n` +
                            `変更してよろしいですか？`;
                
                if (!confirm(msg)) return;
            }
        } catch(e) {
            console.error('Usage check failed', e);
        }
    }

    // 単位変更チェック
    if (id && originalUnit !== newUnit) {
        if (!confirm(`単位が「${originalUnit || '(なし)'}」から「${newUnit || '(なし)'}」に変更されています。\n在庫の数値（例: 3個 → 3${newUnit}）の意味が変わってしまいますが、よろしいですか？`)) {
            return;
        }
    }

    const item = {
        id: id ? parseInt(id) : 0,
        classification: document.getElementById('input-classification').value,
        category: document.getElementById('input-category').value,
        name: name,
        kana: document.getElementById('input-kana').value,
        default_unit: newUnit,
        force_merge: false
    };

    let method = 'POST';
    if (id) method = 'PUT';

    fetch('/api/catalog', {
        method: method,
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(id ? item : [item])
    })
    .then(async res => {
        const data = await res.json();
        
        if (res.status === 409 && data.error_code === 'merge_confirmation_required') {
            if (confirm(`${data.message}\n\n「OK」を押すとデータを統合します（元のデータは削除され、関連データは移動します）。`)) {
                item.force_merge = true;
                return fetch('/api/catalog', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(item)
                }).then(r => r.json());
            } else {
                throw new Error('キャンセルしました');
            }
        }

        if (!res.ok) throw new Error(data.error || 'Save failed');
        return data;
    })
    .then(() => {
        document.getElementById('modal-overlay').classList.remove('active');
        if (typeof fetchCatalog === 'function') fetchCatalog(); // リスト更新
        alert('保存しました');
    })
    .catch(err => {
        if (err.message !== 'キャンセルしました') alert('エラー: ' + err.message);
    });
}

function deleteCatalogItem(id, name) {
    if (!confirm(`本当に「${name}」をカタログから削除しますか？\n（この操作は取り消せません）`)) return;

    fetch(`/api/catalog?id=${id}`, { method: 'DELETE' })
    .then(res => {
        if (!res.ok) {
            // エラーハンドリング (API未実装など)
            return res.text().then(text => { throw new Error(text || res.statusText) });
        }
        return res.json();
    })
    .then(() => {
        alert('削除しました');
        document.getElementById('modal-overlay').classList.remove('active');
        if (typeof fetchCatalog === 'function') fetchCatalog();
    })
    .catch(err => {
        console.error(err);
        alert('削除できませんでした。\n(サーバー側で削除機能が許可されていない可能性があります)');
    });
}

function saveCsvItem() {
    const text = document.getElementById('input-csv-text').value;
    const resultArea = document.getElementById('csv-result-area');
    
    if (!text) return alert('CSVを入力してください');

    fetch('/import/catalog', {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: text
    })
    .then(async res => {
        if (!res.ok) {
             const errorData = await res.json().catch(() => ({ error: `サーバーエラー: ${res.status}` }));
             throw new Error(errorData.error || `サーバーエラー: ${res.status}`);
        }
        return res.json();
    })
    .then(result => {
        resultArea.style.display = 'block';
        resultArea.innerHTML = `
            <h3>処理結果</h3>
            <p>登録成功: <strong>${result.added}</strong> 件</p>
            <p>重複スキップ: <strong>${result.skipped}</strong> 件</p>
        `;

        if (result.errors && result.errors.length > 0) {
            resultArea.innerHTML += `
                <div style="color: red; margin-top:10px; border: 1px solid red; padding: 5px; border-radius: 4px;">
                    <h4>エラー詳細:</h4>
                    <ul>${result.errors.map(e => `<li>${e}</li>`).join('')}</ul>
                </div>
            `;
        }

        if (typeof fetchCatalog === 'function') fetchCatalog();
        document.getElementById('input-csv-text').value = '';
    })
    .catch(err => alert('エラー: ' + err.message));
}

----- C:\Users\wasab\OneDrive\デスクトップ\kimichan2\static\js\catalog_list.js -----
// グローバル変数
let catalogData = [];
let currentCategory = 'すべて';

// 初期化 (app.jsから呼ばれる)
function initCatalog() {
    fetchCatalog();
    // catalog_edit.js にあるセットアップ関数を呼ぶ
    if (typeof setupCatalogUI === 'function') {
        setupCatalogUI();
    }
}

// データ取得
function fetchCatalog() {
    fetch('/api/catalog')
        .then(res => res.json())
        .then(data => {
            catalogData = data;
            renderCategoryButtons(catalogData);
            filterAndRender();
        })
        .catch(err => console.error('Fetch error:', err));
}

// カテゴリフィルタボタンの描画
function renderCategoryButtons(items) {
    const container = document.getElementById('category-filters');
    if (!container) return;

    const categories = new Set(['すべて']);
    items.forEach(item => {
        if (item.category) categories.add(item.category);
        else if (item.classification === '調味料') categories.add('調味料');
        else categories.add('未分類');
    });

    container.innerHTML = '';
    categories.forEach(cat => {
        const displayCat = cat === '未分類' ? 'その他' : cat;
        const btn = document.createElement('div');
        btn.className = `cat-chip ${cat === currentCategory ? 'active' : ''}`;
        btn.textContent = displayCat;
        btn.onclick = () => {
            currentCategory = cat;
            document.querySelectorAll('.cat-chip').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            filterAndRender();
        };
        container.appendChild(btn);
    });
}

// フィルタリングとソートの実行
function filterAndRender() {
    const term = document.getElementById('catalog-search').value.toLowerCase();
    const sortOrder = document.getElementById('sort-order').value;
    const filterNoKana = document.getElementById('filter-no-kana').checked;
    
    let displayData = [...catalogData];
    
    // ソート処理
    if (sortOrder === 'id_desc') {
        displayData.sort((a, b) => b.id - a.id);
    } else {
        displayData.sort((a, b) => {
            const ka = a.kana || a.name;
            const kb = b.kana || b.name;
            return ka.localeCompare(kb, 'ja');
        });
    }

    // フィルタ処理
    const filtered = displayData.filter(item => {
        // カテゴリ
        let catMatch = true;
        if (currentCategory !== 'すべて') {
            const itemCat = item.category || (item.classification === '調味料' ? '調味料' : '未分類');
            catMatch = (itemCat === currentCategory);
        }

        // 検索語句
        let termMatch = true;
        if (term) {
            termMatch = 
                item.name.toLowerCase().includes(term) || 
                (item.kana && item.kana.toLowerCase().includes(term)) ||
                (item.category && item.category.toLowerCase().includes(term));
        }

        // よみがな未登録
        let noKanaMatch = true;
        if (filterNoKana) {
            noKanaMatch = !item.kana || item.kana.trim() === '';
        }

        return catMatch && termMatch && noKanaMatch;
    });

    renderCatalog(filtered);
}

// 一覧の描画
function renderCatalog(items) {
    const listEl = document.getElementById('catalog-list');
    if (!listEl) return;
    
    listEl.innerHTML = '';
    
    if (items.length === 0) {
        listEl.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">該当なし</div>';
        return;
    }

    items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'card';
        // catalog_edit.js の関数を呼ぶ
        div.onclick = () => {
            if (typeof openCatalogEditModal === 'function') {
                openCatalogEditModal(item);
            }
        };
        
        const tagText = `${item.classification} / ${item.category || (item.classification === '調味料' ? 'スパイス等' : '未分類')}`;
        
        const kanaHtml = item.kana 
            ? `<span style="font-size:11px; color:#999; font-weight:normal; margin-left:5px;">(${item.kana})</span>` 
            : `<span style="font-size:10px; color:#e74c3c; background:#ffebee; padding:1px 4px; border-radius:4px; margin-left:5px;">未登録</span>`;

        div.innerHTML = `
            <div class="card-content">
                <span class="tag">${tagText}</span>
                <div class="item-name">
                    ${item.name}
                    ${kanaHtml}
                </div>
            </div>
            <div class="item-unit">${item.default_unit || ''}</div>
        `;
        listEl.appendChild(div);
    });
}

----- C:\Users\wasab\OneDrive\デスクトップ\kimichan2\static\js\catalog.js -----
let catalogData = [];
let currentCategory = 'すべて';

function initCatalog() {
    fetchCatalog();
    setupCatalogUI();
}

function fetchCatalog() {
    fetch('/api/catalog')
        .then(res => res.json())
        .then(data => {
            catalogData = data;
            renderCategoryButtons(catalogData);
            filterAndRender();
        })
        .catch(err => console.error('Fetch error:', err));
}

function renderCategoryButtons(items) {
    const container = document.getElementById('category-filters');
    if (!container) return;

    const categories = new Set(['すべて']);
    items.forEach(item => {
        if (item.category) categories.add(item.category);
        else if (item.classification === '調味料') categories.add('調味料');
        else categories.add('未分類');
    });

    container.innerHTML = '';
    categories.forEach(cat => {
        const displayCat = cat === '未分類' ? 'その他' : cat;
        const btn = document.createElement('div');
        btn.className = `cat-chip ${cat === currentCategory ? 'active' : ''}`;
        btn.textContent = displayCat;
        btn.onclick = () => {
            currentCategory = cat;
            document.querySelectorAll('.cat-chip').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            filterAndRender();
        };
        container.appendChild(btn);
    });
}

function filterAndRender() {
    const term = document.getElementById('catalog-search').value.toLowerCase();
    const sortOrder = document.getElementById('sort-order').value;
    const filterNoKana = document.getElementById('filter-no-kana').checked;
    
    let displayData = [...catalogData];
    
    if (sortOrder === 'id_desc') {
        displayData.sort((a, b) => b.id - a.id);
    } else {
        displayData.sort((a, b) => {
            const ka = a.kana || a.name;
            const kb = b.kana || b.name;
            return ka.localeCompare(kb, 'ja');
        });
    }

    const filtered = displayData.filter(item => {
        let catMatch = true;
        if (currentCategory !== 'すべて') {
            const itemCat = item.category || (item.classification === '調味料' ? '調味料' : '未分類');
            catMatch = (itemCat === currentCategory);
        }

        let termMatch = true;
        if (term) {
            termMatch = 
                item.name.toLowerCase().includes(term) || 
                (item.kana && item.kana.toLowerCase().includes(term)) ||
                (item.category && item.category.toLowerCase().includes(term));
        }

        let noKanaMatch = true;
        if (filterNoKana) {
            noKanaMatch = !item.kana || item.kana.trim() === '';
        }

        return catMatch && termMatch && noKanaMatch;
    });

    renderCatalog(filtered);
}

function renderCatalog(items) {
    const listEl = document.getElementById('catalog-list');
    if (!listEl) return;
    
    listEl.innerHTML = '';
    
    if (items.length === 0) {
        listEl.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">該当なし</div>';
        return;
    }

    items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'card';
        div.onclick = () => openCatalogEditModal(item);
        
        const tagText = `${item.classification} / ${item.category || (item.classification === '調味料' ? 'スパイス等' : '未分類')}`;
        
        const kanaHtml = item.kana 
            ? `<span style="font-size:11px; color:#999; font-weight:normal; margin-left:5px;">(${item.kana})</span>` 
            : `<span style="font-size:10px; color:#e74c3c; background:#ffebee; padding:1px 4px; border-radius:4px; margin-left:5px;">未登録</span>`;

        div.innerHTML = `
            <div class="card-content">
                <span class="tag">${tagText}</span>
                <div class="item-name">
                    ${item.name}
                    ${kanaHtml}
                </div>
            </div>
            <div class="item-unit">${item.default_unit || ''}</div>
        `;
        listEl.appendChild(div);
    });
}

function openCatalogEditModal(item) {
    const overlay = document.getElementById('modal-overlay');
    const title = document.getElementById('modal-title');
    const tabSingle = document.getElementById('tab-single');
    const tabCsv = document.getElementById('tab-csv');
    const singleContainer = document.getElementById('form-single');
    const csvContainer = document.getElementById('form-csv');
    
    tabSingle.classList.add('active');
    tabCsv.classList.remove('active');
    singleContainer.style.display = 'block';
    csvContainer.style.display = 'none';
    document.getElementById('csv-result-area').style.display = 'none';
    document.getElementById('reference-area').style.display = 'none'; 
    
    title.textContent = 'アイテム編集';

    document.getElementById('edit-id').value = item.id;
    document.getElementById('original-unit').value = item.default_unit || '';
    document.getElementById('original-name').value = item.name || ''; 

    document.getElementById('input-classification').value = item.classification;
    
    updateCategorySelect(item.category);

    document.getElementById('input-name').value = item.name;
    document.getElementById('input-kana').value = item.kana || '';
    document.getElementById('input-unit').value = item.default_unit;

    if (item.name) {
        updateReferenceList(item.name);
    }

    overlay.classList.add('active');
}

function updateCategorySelect(selectedCategory) {
    const select = document.getElementById('select-category');
    const input = document.getElementById('input-category');
    
    const categories = new Set();
    catalogData.forEach(d => {
        if(d.category) categories.add(d.category);
    });

    select.innerHTML = '<option value="">(新規入力)</option>';
    categories.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        select.appendChild(opt);
    });

    if (categories.has(selectedCategory)) {
        select.value = selectedCategory;
        input.style.display = 'none';
        input.value = selectedCategory;
    } else {
        select.value = "";
        input.style.display = 'block';
        input.value = selectedCategory || "";
    }

    select.onchange = () => {
        if (select.value === "") {
            input.style.display = 'block';
            input.value = "";
        } else {
            input.style.display = 'none';
            input.value = select.value;
        }
    };
}

function updateReferenceList(name) {
    const refArea = document.getElementById('reference-area');
    const refList = document.getElementById('reference-list');
    
    if (!name || name.length < 1) {
        refArea.style.display = 'none';
        return;
    }

    const term = name.toLowerCase();
    
    // 双方向の部分一致検索 (DBが入力を含む OR 入力がDBを含む)
    const hits = catalogData.filter(d => {
        const targetName = d.name.toLowerCase();
        const targetKana = d.kana ? d.kana.toLowerCase() : '';

        // DBの名前が、入力文字を含んでいる
        const dbContainsInput = targetName.includes(term) || (targetKana && targetKana.includes(term));
        
        // 入力文字が、DBの名前を含んでいる
        const inputContainsDb = term.includes(targetName) || (targetKana && term.includes(targetKana));

        return dbContainsInput || inputContainsDb;
    }).slice(0, 8); 

    if (hits.length === 0) {
        refArea.style.display = 'none';
        return;
    }

    refList.innerHTML = '';
    hits.forEach(hit => {
        const chip = document.createElement('div');
        chip.style.cssText = 'background:white; border:1px solid #ccc; padding:4px 8px; border-radius:12px; font-size:11px; cursor:pointer; display:flex; align-items:center; gap:5px;';
        chip.innerHTML = `
            <span style="color:#888;">[${hit.classification}/${hit.category||'-'}]</span>
            <strong>${hit.name}</strong>
        `;
        chip.onclick = () => applyReferenceItem(hit);
        refList.appendChild(chip);
    });
    refArea.style.display = 'block';
}

function applyReferenceItem(item) {
    if (!confirm(`この食材を「${item.name}」として設定（統合）しますか？\n\n※保存時に統合の確認が表示されます。`)) return;

    document.getElementById('input-name').value = item.name;
    document.getElementById('input-kana').value = item.kana || '';
    document.getElementById('input-classification').value = item.classification;
    
    updateCategorySelect(item.category);
    document.getElementById('input-unit').value = item.default_unit || '';
}

function setupCatalogUI() {
    const fab = document.getElementById('fab-add');
    const overlay = document.getElementById('modal-overlay');
    const btnCancel = document.getElementById('btn-cancel');
    const btnSave = document.getElementById('btn-save');
    const tabSingle = document.getElementById('tab-single');
    const tabCsv = document.getElementById('tab-csv');
    const singleContainer = document.getElementById('form-single');
    const csvContainer = document.getElementById('form-csv');
    const searchInput = document.getElementById('catalog-search');

    const sortSelect = document.getElementById('sort-order');
    const noKanaCheck = document.getElementById('filter-no-kana');
    const nameInput = document.getElementById('input-name');

    const scrollLeft = document.getElementById('scroll-left');
    const scrollRight = document.getElementById('scroll-right');
    const scrollContainer = document.getElementById('category-filters');

    if(scrollLeft && scrollContainer) {
        scrollLeft.onclick = () => scrollContainer.scrollBy({ left: -100, behavior: 'smooth' });
        scrollRight.onclick = () => scrollContainer.scrollBy({ left: 100, behavior: 'smooth' });
    }

    if (!fab) return;

    fab.addEventListener('click', () => {
        document.getElementById('modal-title').textContent = 'アイテム登録';
        document.getElementById('edit-id').value = '';
        document.getElementById('original-unit').value = '';
        document.getElementById('original-name').value = '';
        document.getElementById('input-name').value = '';
        document.getElementById('input-kana').value = '';
        document.getElementById('input-unit').value = '';
        document.getElementById('input-csv-text').value = '';
        document.getElementById('reference-area').style.display = 'none';
        
        updateCategorySelect(currentCategory !== 'すべて' && currentCategory !== '未分類' ? currentCategory : '');

        document.getElementById('csv-result-area').style.display = 'none';
        
        tabCsv.classList.remove('active');
        tabSingle.classList.add('active');
        singleContainer.style.display = 'block';
        csvContainer.style.display = 'none';
        
        overlay.classList.add('active');
    });

    btnCancel.addEventListener('click', () => {
        overlay.classList.remove('active');
        removeConflictUI();
    });

    searchInput.addEventListener('input', filterAndRender);
    sortSelect.addEventListener('change', filterAndRender);
    noKanaCheck.addEventListener('change', filterAndRender);

    nameInput.addEventListener('input', (e) => {
        updateReferenceList(e.target.value);
    });

    tabSingle.addEventListener('click', () => {
        tabSingle.classList.add('active');
        tabCsv.classList.remove('active');
        singleContainer.style.display = 'block';
        csvContainer.style.display = 'none';
        removeConflictUI();
        document.getElementById('csv-result-area').style.display = 'none';
    });

    tabCsv.addEventListener('click', () => {
        tabCsv.classList.add('active');
        tabSingle.classList.remove('active');
        singleContainer.style.display = 'none';
        csvContainer.style.display = 'block';
        removeConflictUI();
    });

    btnSave.addEventListener('click', () => {
        if (singleContainer.style.display !== 'none') {
            saveSingleItem();
        } else {
            saveCsvItem();
        }
    });
}

function removeConflictUI() {
    const conflictDiv = document.getElementById('conflict-resolution-area');
    if (conflictDiv) conflictDiv.remove();
    const btnSave = document.getElementById('btn-save');
    if (btnSave) {
        btnSave.style.display = 'block';
        btnSave.textContent = '保存';
    }
}

async function saveSingleItem() {
    const id = document.getElementById('edit-id').value;
    const name = document.getElementById('input-name').value;
    const originalUnit = document.getElementById('original-unit').value;
    const originalName = document.getElementById('original-name').value;
    const newUnit = document.getElementById('input-unit').value;

    if (!name) return alert('名前を入力してください');

    // 名前が変更された場合、影響範囲（レシピ）を確認する
    if (id && name !== originalName) {
        try {
            const usageRes = await fetch(`/api/catalog/usage?id=${id}`);
            const usage = await usageRes.json();
            
            if (usage.recipe_count > 0) {
                const examples = usage.recipe_names.join('、') + (usage.recipe_count > 3 ? '...' : '');
                const msg = `⚠️ この食材は ${usage.recipe_count} 件のレシピで使用されています。\n` +
                            `（使用例: ${examples}）\n\n` +
                            `名前を「${originalName}」から「${name}」に変更すると、それらのレシピの表示も全て変わります。\n\n` +
                            `変更してよろしいですか？`;
                
                if (!confirm(msg)) return;
            }
        } catch(e) {
            console.error('Usage check failed', e);
        }
    }

    if (id && originalUnit !== newUnit) {
        if (!confirm(`単位が「${originalUnit || '(なし)'}」から「${newUnit || '(なし)'}」に変更されています。\n在庫の数値（例: 3個 → 3${newUnit}）の意味が変わってしまいますが、よろしいですか？`)) {
            return;
        }
    }

    const item = {
        id: id ? parseInt(id) : 0,
        classification: document.getElementById('input-classification').value,
        category: document.getElementById('input-category').value,
        name: name,
        kana: document.getElementById('input-kana').value,
        default_unit: newUnit,
        force_merge: false
    };

    let method = 'POST';
    if (id) method = 'PUT';

    fetch('/api/catalog', {
        method: method,
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(id ? item : [item])
    })
    .then(async res => {
        const data = await res.json();
        
        if (res.status === 409 && data.error_code === 'merge_confirmation_required') {
            if (confirm(`${data.message}\n\n「OK」を押すとデータを統合します（元のデータは削除され、関連データは移動します）。`)) {
                item.force_merge = true;
                return fetch('/api/catalog', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(item)
                }).then(r => r.json());
            } else {
                throw new Error('キャンセルしました');
            }
        }

        if (!res.ok) throw new Error(data.error || 'Save failed');
        return data;
    })
    .then(() => {
        document.getElementById('modal-overlay').classList.remove('active');
        fetchCatalog();
        alert('保存しました');
    })
    .catch(err => {
        if (err.message !== 'キャンセルしました') alert('エラー: ' + err.message);
    });
}

function saveCsvItem() {
    const text = document.getElementById('input-csv-text').value;
    const resultArea = document.getElementById('csv-result-area');
    
    if (!text) return alert('CSVを入力してください');

    fetch('/import/catalog', {
        method: 'POST',
        headers: {
            'Content-Type': 'text/plain'
        },
        body: text
    })
    .then(async res => {
        if (!res.ok) {
             const errorData = await res.json().catch(() => ({ error: `サーバーエラー: ${res.status}` }));
             throw new Error(errorData.error || `サーバーエラー: ${res.status}`);
        }
        return res.json();
    })
    .then(result => {
        resultArea.style.display = 'block';
        resultArea.innerHTML = `
            <h3>処理結果</h3>
            <p>登録成功: <strong>${result.added}</strong> 件</p>
            <p>重複スキップ: <strong>${result.skipped}</strong> 件</p>
        `;

        if (result.errors && result.errors.length > 0) {
            resultArea.innerHTML += `
                <div style="color: red; margin-top:10px; border: 1px solid red; padding: 5px; border-radius: 4px;">
                    <h4>エラー詳細:</h4>
                    <ul>${result.errors.map(e => `<li>${e}</li>`).join('')}</ul>
                </div>
            `;
        }

        fetchCatalog();
        document.getElementById('input-csv-text').value = '';
    })
    .catch(err => alert('エラー: ' + err.message));
}

----- C:\Users\wasab\OneDrive\デスクトップ\kimichan2\static\js\inventory_edit.js -----
let catalogListForInv = [];
let currentSelectorCategory = 'すべて';
const FIXED_LOCATIONS_EDIT = ["冷蔵室", "チルド", "冷凍室", "野菜室", "その他"];

function initInventoryEdit() {
    setupLocationSelects();
    fetchCatalogForInv();
    setupEditEventListeners();
}

function fetchCatalogForInv() {
    fetch('/api/catalog')
        .then(res => res.json())
        .then(data => {
            // 調味料は除外
            let filteredData = data.filter(item => item.classification !== '調味料');
            filteredData.sort((a, b) => {
                const ka = a.kana || a.name;
                const kb = b.kana || b.name;
                return ka.localeCompare(kb, 'ja');
            });
            catalogListForInv = filteredData;
        });
}

function setupLocationSelects() {
    const ids = ['inv-location', 'inv-edit-location'];
    ids.forEach(id => {
        const select = document.getElementById(id);
        if (!select) return;
        const current = select.value;
        select.innerHTML = '';
        FIXED_LOCATIONS_EDIT.forEach(loc => {
            const opt = document.createElement('option');
            opt.value = loc;
            opt.textContent = loc;
            select.appendChild(opt);
        });
        if (current && FIXED_LOCATIONS_EDIT.includes(current)) select.value = current;
        else select.value = FIXED_LOCATIONS_EDIT[0];
    });
}

function setupEditEventListeners() {
    // --- モーダルを開く (新規) ---
    const fab = document.getElementById('fab-add-inventory');
    if (fab) {
        fab.onclick = () => {
            // リセット処理
            document.getElementById('inv-detail-toggle').checked = false;
            document.getElementById('inv-detail-area').style.display = 'none';
            document.getElementById('inv-amount').value = 1; 
            document.getElementById('inv-unit').value = "";
            document.getElementById('inv-select-catalog-id').value = ""; // IDリセット
            
            const btn = document.getElementById('btn-open-selector');
            if(btn) {
                btn.textContent = "食材を選択してください...";
                btn.style.fontWeight = 'normal';
                btn.style.color = '#333';
            }
            setupLocationSelects();
            document.getElementById('modal-inventory').classList.add('active');
        };
    }

    // キャンセルボタン
    const btnCancel = document.getElementById('btn-inv-cancel');
    if (btnCancel) btnCancel.onclick = () => document.getElementById('modal-inventory').classList.remove('active');
    
    const btnEditCancel = document.getElementById('btn-inv-edit-cancel');
    if (btnEditCancel) btnEditCancel.onclick = () => document.getElementById('modal-inv-edit').classList.remove('active');

    // --- 保存ボタン (ここが重要！) ---
    const btnSave = document.getElementById('btn-inv-save');
    if (btnSave) {
        btnSave.onclick = () => {
            // IDを取得
            const idInput = document.getElementById('inv-select-catalog-id');
            const val = idInput ? idInput.value : "";
            
            if (!val) {
                alert('食材が選択されていません。「食材を選択してください」ボタンを押して選んでください。');
                return;
            }
            
            const catalogId = parseInt(val, 10);
            if (isNaN(catalogId)) {
                alert('食材IDが不正です。もう一度選び直してください。');
                return;
            }

            const location = document.getElementById('inv-location').value;
            const unit = document.getElementById('inv-unit').value;
            let amount = -1;
            let date = "";
            
            if (document.getElementById('inv-detail-toggle').checked) {
                amount = parseFloat(document.getElementById('inv-amount').value) || 1;
                date = document.getElementById('inv-date').value;
            }
            let expirationDate = date ? date + "T00:00:00Z" : "";

            const data = {
                catalog_id: catalogId,
                amount: amount,
                unit: unit,
                expiration_date: expirationDate,
                location: location
            };

            fetch('/api/ingredients', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(async res => {
                if (!res.ok) {
                    const txt = await res.text();
                    throw new Error(txt || res.statusText);
                }
                document.getElementById('modal-inventory').classList.remove('active');
                if(window.fetchInventory) window.fetchInventory(); // リスト更新
            })
            .catch(err => {
                console.error("Save Error:", err);
                alert('保存できませんでした: ' + err.message);
            });
        };
    }

    // 更新
    const btnUpdate = document.getElementById('btn-inv-update');
    if (btnUpdate) {
        btnUpdate.onclick = () => {
            const id = document.getElementById('inv-edit-id').value;
            const amount = parseFloat(document.getElementById('inv-edit-amount').value);
            const date = document.getElementById('inv-edit-date').value;
            const location = document.getElementById('inv-edit-location').value;

            const data = {
                id: parseInt(id),
                amount: amount,
                expiration_date: date ? date + "T00:00:00Z" : "",
                location: location
            };

            fetch('/api/ingredients', {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            }).then(async res => {
                if(!res.ok) throw new Error(await res.text());
                document.getElementById('modal-inv-edit').classList.remove('active');
                if(window.fetchInventory) window.fetchInventory();
            }).catch(err => alert('更新エラー: ' + err));
        };
    }

    // 削除
    const btnDelete = document.getElementById('btn-inv-delete');
    if (btnDelete) {
        btnDelete.onclick = () => {
            if(!confirm('削除しますか？')) return;
            const id = document.getElementById('inv-edit-id').value;
            fetch(`/api/ingredients?id=${id}`, { method: 'DELETE' })
            .then(async res => {
                if(!res.ok) throw new Error(await res.text());
                document.getElementById('modal-inv-edit').classList.remove('active');
                if(window.fetchInventory) window.fetchInventory();
            }).catch(err => alert('削除エラー: ' + err));
        };
    }

    setupItemSelector();
}

// 選択モーダル UI制御
function setupItemSelector() {
    const btnOpen = document.getElementById('btn-open-selector');
    const modal = document.getElementById('modal-item-selector');
    const btnClose = document.getElementById('btn-selector-close');
    const searchInput = document.getElementById('selector-search');

    if(!btnOpen || !modal) return;

    btnOpen.onclick = () => {
        modal.classList.add('active');
        renderSelectorCategories();
        renderSelectorList();
    };
    if(btnClose) btnClose.onclick = () => modal.classList.remove('active');
    
    if(searchInput) {
        searchInput.oninput = () => renderSelectorList();
    }
}

function renderSelectorCategories() {
    const container = document.getElementById('selector-tabs');
    if (!container) return;
    container.innerHTML = '';
    const categories = new Set(['すべて']);
    catalogListForInv.forEach(item => {
        if(item.category) categories.add(item.category);
        else categories.add('未分類');
    });
    categories.forEach(cat => {
        const div = document.createElement('div');
        div.className = `selector-tab ${cat === currentSelectorCategory ? 'active' : ''}`;
        div.textContent = cat;
        div.onclick = () => {
            currentSelectorCategory = cat;
            renderSelectorCategories();
            renderSelectorList();
        };
        container.appendChild(div);
    });
}

function renderSelectorList() {
    const container = document.getElementById('selector-list');
    const term = document.getElementById('selector-search').value.toLowerCase();
    container.innerHTML = '';

    const filtered = catalogListForInv.filter(item => {
        let catMatch = (currentSelectorCategory === 'すべて') || (item.category === currentSelectorCategory);
        let termMatch = true;
        if(term) {
            termMatch = item.name.toLowerCase().includes(term) || (item.kana && item.kana.toLowerCase().includes(term));
        }
        return catMatch && termMatch;
    });

    if (filtered.length === 0) {
        container.innerHTML = '<div style="padding:10px; color:#999;">該当なし</div>';
        return;
    }

    filtered.forEach(item => {
        const div = document.createElement('div');
        div.className = 'selector-item';
        div.innerHTML = `${item.name} <span class="selector-item-kana">${item.kana || ''}</span>`;
        
        // ★選択時の処理 (IDをセット)
        div.onclick = () => {
            document.getElementById('inv-select-catalog-id').value = item.id;
            
            const btn = document.getElementById('btn-open-selector');
            btn.textContent = item.name;
            btn.style.fontWeight = 'bold';
            btn.style.color = '#000';
            
            document.getElementById('inv-unit').value = item.default_unit || '';
            document.getElementById('modal-item-selector').classList.remove('active');
        };
        container.appendChild(div);
    });
}

window.openInventoryEdit = function(item) {
    const modal = document.getElementById('modal-inv-edit');
    if (!modal) return;
    document.getElementById('inv-edit-title').textContent = item.name;
    document.getElementById('inv-edit-id').value = item.id;
    document.getElementById('inv-edit-amount').value = item.amount;
    document.getElementById('inv-edit-unit').textContent = item.unit;
    document.getElementById('inv-edit-date').value = item.expiration_date.split('T')[0];

    setupLocationSelects();
    const locSelect = document.getElementById('inv-edit-location');
    let loc = item.location;
    if (!FIXED_LOCATIONS_EDIT.includes(loc)) loc = 'その他';
    locSelect.value = loc;
    
    modal.classList.add('active');
};

window.addAmount = function(val) {
    const input = document.getElementById('inv-amount');
    let current = parseFloat(input.value) || 0;
    let nextVal = current + val;
    if (nextVal < 0) nextVal = 0;
    input.value = Math.round(nextVal * 10) / 10;
};

----- C:\Users\wasab\OneDrive\デスクトップ\kimichan2\static\js\inventory_list.js -----
let inventoryData = [];
const FIXED_LOCATIONS = ["冷蔵室", "チルド", "冷凍室", "野菜室", "その他"];

function initInventory() {
    if (window.fetchFridgePhotos) window.fetchFridgePhotos();
    fetchInventory();
    
    // 編集・写真UIの初期化
    if (typeof initInventoryEdit === 'function') initInventoryEdit();
    if (typeof setupPhotoUI === 'function') setupPhotoUI();
}

window.fetchInventory = function() {
    return fetch('/api/ingredients')
        .then(res => res.json())
        .then(data => {
            inventoryData = data;
            const searchInput = document.getElementById('inventory-search');
            if (searchInput && searchInput.value) {
                const term = searchInput.value.toLowerCase().trim();
                const filtered = inventoryData.filter(item => 
                    item.name.toLowerCase().includes(term) || 
                    (item.kana && item.kana.toLowerCase().includes(term))
                );
                renderInventory(filtered);
            } else {
                renderInventory(inventoryData);
            }
        })
        .catch(err => console.error(err));
};

function renderInventory(items) {
    const listEl = document.getElementById('inventory-list');
    if (!listEl) return;
    listEl.innerHTML = '';

    const itemsByLoc = {};
    FIXED_LOCATIONS.forEach(loc => itemsByLoc[loc] = []);
    
    items.forEach(item => {
        let loc = item.location || 'その他';
        if (!FIXED_LOCATIONS.includes(loc)) loc = 'その他';
        itemsByLoc[loc].push(item);
    });

    FIXED_LOCATIONS.forEach(loc => {
        const locItems = itemsByLoc[loc] || [];

        // ヘッダー
        const header = document.createElement('div');
        header.className = 'loc-header-badge';
        header.textContent = loc;
        listEl.appendChild(header);

        // 写真エリア
        if (typeof window.renderLocationPhotos === 'function') {
            const photoStrip = window.renderLocationPhotos(loc);
            listEl.appendChild(photoStrip);
        }

        // アイテム
        if (locItems.length === 0) {
            const emptyMsg = document.createElement('div');
            emptyMsg.className = 'inventory-empty-msg';
            emptyMsg.textContent = '（在庫なし）';
            listEl.appendChild(emptyMsg);
        } else {
            locItems.forEach(item => {
                const div = document.createElement('div');
                div.className = 'card';
                div.onclick = (e) => {
                    // バッジ以外の場所をクリックしたら編集
                    if (!e.target.closest('.recipe-badge-btn')) {
                        if (typeof openInventoryEdit === 'function') {
                            openInventoryEdit(item);
                        }
                    }
                };
            
                const today = new Date();
                today.setHours(0,0,0,0);
                const expDate = new Date(item.expiration_date);
                expDate.setHours(0,0,0,0);
                const diffTime = expDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

                let dateClass = 'status-normal';
                let dateText = item.expiration_date.split('T')[0];

                if (diffDays < 0) {
                    dateClass = 'status-expired';
                    dateText += ' (期限切れ)';
                } else if (diffDays <= 2) {
                    dateClass = 'status-soon';
                    if (diffDays === 0) dateText += ' (今日)';
                    else dateText += ` (あと${diffDays}日)`;
                }

                let badgeHtml = '';
                if (item.recipe_count > 0) {
                    badgeHtml = `<button class="recipe-badge-btn" onclick="goToFilteredRecipes(${item.catalog_id}, '${item.name}')">🍳 ${item.recipe_count}</button>`;
                }

                let thumbHtml = item.image_path ? `<img src="/images/${item.image_path}" class="list-thumbnail">` : '';
                let amountDisplay = item.amount === -1 ? '<span class="stock-status-ok">在庫あり</span>' : `${item.amount} ${item.unit}`;

                div.innerHTML = `
                    <div class="card-content-wrapper">
                        ${thumbHtml}
                        <div class="card-text-area">
                            <div class="card-tag-row">
                                <span class="tag date-tag ${dateClass}">期限: ${dateText}</span>
                            </div>
                            <div class="card-name-row">
                                <span class="item-name">${item.name}</span>
                                ${badgeHtml}
                            </div>
                        </div>
                    </div>
                    <div class="item-unit">${amountDisplay}</div>
                `;
                listEl.appendChild(div);
            });
        }
    });
}

document.addEventListener('input', (e) => {
    if (e.target.id === 'inventory-search') {
        const term = e.target.value.toLowerCase().trim();
        if (!term) {
            renderInventory(inventoryData);
            return;
        }
        const filtered = inventoryData.filter(item => {
            const nameMatch = item.name.toLowerCase().includes(term);
            const kanaMatch = item.kana && item.kana.toLowerCase().includes(term);
            return nameMatch || kanaMatch;
        });
        renderInventory(filtered);
    }
});

window.goToFilteredRecipes = function(catalogId, itemName) {
    sessionStorage.setItem('recipe_filter_id', catalogId);
    sessionStorage.setItem('recipe_filter_name', itemName);
    const recipeTab = document.querySelector('a[data-view="recipes"]');
    if(recipeTab) recipeTab.click();
};

----- C:\Users\wasab\OneDrive\デスクトップ\kimichan2\static\js\inventory_locations.js -----
let locations = []; 
// グローバルから呼べるようにwindowに登録
window.fetchLocations = function() {
    return fetch('/api/locations')
        .then(res => res.json())
        .then(data => {
            locations = data;
            // 読み込み完了時にプルダウンを更新
            renderLocationSelects(); 
        })
        .catch(err => console.error(err));
};

window.renderLocationSelects = function() {
    const selects = [document.getElementById('inv-location'), document.getElementById('inv-edit-location')]; 
    selects.forEach(sel => {
        if (!sel) return;
        const currentVal = sel.value;
        sel.innerHTML = '';
        locations.forEach(loc => {
            const opt = document.createElement('option');
            opt.value = loc.name;
            opt.textContent = loc.name;
            sel.appendChild(opt);
  
        }); 
        if (currentVal && locations.some(l => l.name === currentVal)) {
            sel.value = currentVal;
        } else if (locations.length > 0) {
            const other = locations.find(l => l.name === 'その他');
            sel.value = other ? other.name : locations[0].name;
        }
    });
};

window.setupLocationUI = function() {
    const btnManageLoc = document.getElementById('btn-manage-loc');
    const btnLocClose = document.getElementById('btn-loc-close');
    const btnAddLoc = document.getElementById('btn-add-loc'); 
    const locManageOverlay = document.getElementById('modal-loc-manage');

    if(btnManageLoc) {
        btnManageLoc.addEventListener('click', () => {
            renderLocationManageList(); 
            locManageOverlay.classList.add('active');
        });
    }
    if(btnLocClose) {
        btnLocClose.addEventListener('click', () => {
            locManageOverlay.classList.remove('active');
            renderLocationSelects(); 
            // 在庫リスト再描画（グローバル関数を呼ぶ）
            if(typeof fetchInventory === 'function') fetchInventory();
        });
    }
    if(btnAddLoc) {
        btnAddLoc.addEventListener('click', () => {
            const name = document.getElementById('new-loc-name').value;
            if(!name) return;
            fetch('/api/locations', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
        
                body: JSON.stringify({name: name}) 
            })
            .then(res => res.json())
            .then(() => {
                document.getElementById('new-loc-name').value = '';
                window.fetchLocations().then(renderLocationManageList); 
            });
    
        });
    }
};

function renderLocationManageList() {
    const ul = document.getElementById('loc-manage-list');
    ul.innerHTML = ''; 
    locations.forEach((loc, index) => {
        const li = document.createElement('li');
        li.className = 'location-manage-item';
        li.innerHTML = `
            <span>${loc.name}</span>
            <div class="loc-actions">
                ${index > 0 ? `<button onclick="moveLocation(${loc.id}, -1)">↑</button>` : ''}
                ${index 
< locations.length - 1 ? `<button onclick="moveLocation(${loc.id}, 1)">↓</button>` : ''} 
                <button onclick="deleteLocation(${loc.id})" style="color:red;">×</button>
            </div>
        `;
        ul.appendChild(li); 
    });
}

window.moveLocation = function(id, direction) {
    const idx = locations.findIndex(l => l.id === id); 
    if (idx < 0) return;
    const newIdx = idx + direction;
    if (newIdx < 0 || newIdx >= locations.length) return; 
    const temp = locations[idx];
    locations[idx] = locations[newIdx];
    locations[newIdx] = temp; 
    fetch('/api/locations', {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(locations) 
    }).then(() => {
        window.fetchLocations().then(renderLocationManageList); 
    });
};

window.deleteLocation = function(id) {
    if(!confirm('削除しますか？')) return; 
    fetch(`/api/locations?id=${id}`, { method: 'DELETE' }) 
    .then(() => {
        window.fetchLocations().then(renderLocationManageList); 
    });
};

----- C:\Users\wasab\OneDrive\デスクトップ\kimichan2\static\js\inventory_photos.js -----
let fridgePhotos = [];
let uploadTargetLocation = 'その他';

// 写真データの取得
window.fetchFridgePhotos = function() {
    return fetch('/api/fridge_photos')
        .then(res => res.json())
        .then(data => {
            fridgePhotos = data;
        })
        .catch(err => console.error(err));
};

// 場所ごとの写真エリア生成 (inventory_list.jsから呼ばれる)
window.renderLocationPhotos = function(locationName) {
    const photos = fridgePhotos.filter(p => {
        const pLoc = p.location || 'その他';
        return pLoc === locationName;
    });

    const container = document.createElement('div');
    container.className = 'fridge-snapshot-area';

    // 撮るボタン
    const addBtn = document.createElement('div');
    addBtn.className = 'btn-add-snapshot';
    addBtn.innerHTML = '<span style="font-size:20px;">📷</span><br>撮る';
    addBtn.onclick = () => {
        uploadTargetLocation = locationName;
        const fileInput = document.getElementById('snapshot-file');
        if (fileInput) {
            fileInput.value = ''; 
            fileInput.click();
        } else {
            console.error("snapshot-file element not found");
        }
    };
    container.appendChild(addBtn);

    // 写真リスト
    photos.forEach(photo => {
        const div = document.createElement('div');
        div.className = 'snapshot-card';
        
        const img = document.createElement('img');
        img.src = `/images/${photo.image_path}`;
        img.className = 'snapshot-img';
        img.onclick = () => openPhotoView(photo.image_path);
        
        const delBtn = document.createElement('button');
        delBtn.className = 'btn-delete-snapshot';
        delBtn.textContent = '×';
        delBtn.onclick = (e) => deleteFridgePhoto(photo.id, e);

        div.appendChild(img);
        div.appendChild(delBtn);
        container.appendChild(div);
    });

    return container;
};

function openPhotoView(path) {
    const modal = document.getElementById('modal-photo-view');
    const img = document.getElementById('photo-view-img');
    if (modal && img) {
        img.src = `/images/${path}`;
        modal.classList.add('active');
    }
}

window.deleteFridgePhoto = function(id, e) {
    e.stopPropagation();
    if (!confirm('この写真を削除しますか？')) return;
    fetch(`/api/fridge_photos?id=${id}`, { method: 'DELETE' })
    .then(() => {
        return window.fetchFridgePhotos();
    })
    .then(() => {
        if (typeof renderInventory === 'function') {
             // データを再描画（inventory_list.jsの関数）
             // 引数がないとエラーになる場合があるので、現在のデータを渡すかリロード
             // ここでは簡易的に window.fetchInventory を呼ぶ
             if(window.fetchInventory) window.fetchInventory();
        }
    });
};

// UIセットアップ (app.js または initInventory から呼ばれる)
window.setupPhotoUI = function() {
    const snapshotFile = document.getElementById('snapshot-file');
    const btnPhotoClose = document.getElementById('btn-photo-close');
    const photoViewOverlay = document.getElementById('modal-photo-view');

    if (snapshotFile) {
        snapshotFile.addEventListener('change', async () => {
            const files = snapshotFile.files;
            if (!files || files.length === 0) return;

            // 複数枚対応（最大2枚まで処理）
            const filesToUpload = Array.from(files).slice(0, 2);

            for (const file of filesToUpload) {
                try {
                    // リサイズ (最大800px, 品質0.7)
                    const resizedBlob = await resizeImage(file, 800, 0.7);
                    
                    const formData = new FormData();
                    formData.append('photo', resizedBlob, file.name);

                    const uploadRes = await fetch('/api/upload', { method: 'POST', body: formData });
                    const uploadData = await uploadRes.json();
                    
                    if (uploadData.status === 'success') {
                        await fetch('/api/fridge_photos', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ 
                                image_path: uploadData.filename,
                                location: uploadTargetLocation
                            })
                        });
                    }
                } catch(e) {
                    console.error("アップロード失敗", e);
                    alert(`写真 ${file.name} の処理に失敗しました。`);
                }
            }

            // 更新
            window.fetchFridgePhotos().then(() => {
                if(window.fetchInventory) window.fetchInventory();
            });
        });
    }

    if(btnPhotoClose) {
        btnPhotoClose.addEventListener('click', () => photoViewOverlay.classList.remove('active'));
    }
    if(photoViewOverlay) {
        photoViewOverlay.addEventListener('click', (e) => {
            if(e.target === photoViewOverlay) photoViewOverlay.classList.remove('active');
        });
    }
    
    // アイテム編集用などもセットアップ
    setupImageUpload('inv-file', 'inv-preview', 'inv-image-path');
    setupImageUpload('inv-edit-file', 'inv-edit-preview', 'inv-edit-image-path');
};

// 画像リサイズ関数 (共通で使用)
function resizeImage(file, maxWidth, quality) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                let width = img.width;
                let height = img.height;

                if (width > maxWidth) {
                    height = Math.round(height * (maxWidth / width));
                    width = maxWidth;
                }

                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                canvas.toBlob((blob) => {
                    resolve(blob);
                }, 'image/jpeg', quality);
            };
            img.onerror = reject;
            img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

function setupImageUpload(inputId, previewId, pathInputId) {
    const input = document.getElementById(inputId);
    const preview = document.getElementById(previewId);
    const pathInput = document.getElementById(pathInputId);

    if(!input) return;

    input.addEventListener('change', async () => {
        const file = input.files[0];
        if (!file) return;

        try {
            const resizedBlob = await resizeImage(file, 600, 0.7);
            const formData = new FormData();
            formData.append('photo', resizedBlob, file.name);

            // プレビュー即時表示
            const reader = new FileReader();
            reader.onload = (e) => {
                if(preview) {
                    preview.src = e.target.result;
                    preview.style.display = 'block'; // activeクラスではなくdisplay制御の方が確実
                }
            };
            reader.readAsDataURL(resizedBlob);

            fetch('/api/upload', { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    if(pathInput) pathInput.value = data.filename;
                } else {
                    alert('画像のアップロードに失敗しました');
                }
            })
            .catch(err => {
                console.error(err);
                alert('通信エラー');
            });
        } catch(e) {
            console.error(e);
        }
    });
}

----- C:\Users\wasab\OneDrive\デスクトップ\kimichan2\static\js\recipe_edit.js -----
// --- 編集画面 ---

function openRecipeEditModal() {
    // 詳細画面を閉じる
    document.getElementById('modal-recipe-detail').classList.remove('active');
    
    // タイトル変更
    document.getElementById('modal-recipe-title').textContent = 'レシピ編集';
    
    // 既存データをフォームにセット
    document.getElementById('rec-id').value = currentRecipeDetail.id;
    document.getElementById('rec-name').value = currentRecipeDetail.name;
    document.getElementById('rec-yield').value = currentRecipeDetail.yield || '';
    document.getElementById('rec-url').value = currentRecipeDetail.url;
    document.getElementById('rec-process').value = currentRecipeDetail.process;

    // 材料リストをCSVテキストに変換してセット
    let csvText = "";
    if (currentIngredients && currentIngredients.length > 0) {
        csvText = currentIngredients.map(ing => {
            // 形式: 名前,分量,単位
            return `${ing.name},${ing.amount},${ing.unit}`;
        }).join('\n');
    }
    document.getElementById('rec-csv').value = csvText;

    // 登録モーダルを開く
    document.getElementById('modal-recipe').classList.add('active');
}

// --- UIイベント設定 ---

function setupRecipeUI() {
    const fab = document.getElementById('fab-add-recipe');
    const overlay = document.getElementById('modal-recipe');
    const detailOverlay = document.getElementById('modal-recipe-detail');
    const missingOverlay = document.getElementById('modal-missing-ing');

    const btnCancel = document.getElementById('btn-rec-cancel');
    const btnSave = document.getElementById('btn-rec-save');
    const btnDetailClose = document.getElementById('btn-detail-close');
    const btnDetailEdit = document.getElementById('btn-detail-edit');
    
    const btnMissingCancel = document.getElementById('btn-missing-cancel');
    const btnMissingRegister = document.getElementById('btn-missing-register');

    if (!fab) return;

    // 新規登録ボタン
    fab.addEventListener('click', () => {
        document.getElementById('modal-recipe-title').textContent = 'レシピ登録';
        document.getElementById('rec-id').value = ''; 
        document.getElementById('rec-name').value = '';
        document.getElementById('rec-yield').value = '';
        document.getElementById('rec-url').value = '';
        document.getElementById('rec-process').value = '';
        document.getElementById('rec-csv').value = '';
        overlay.classList.add('active');
    });
    
    // キャンセル・閉じる
    btnCancel.addEventListener('click', () => overlay.classList.remove('active'));
    btnDetailClose.addEventListener('click', () => detailOverlay.classList.remove('active'));
    
    // 編集ボタン
    btnDetailEdit.addEventListener('click', () => openRecipeEditModal());

    // 保存実行
    btnSave.addEventListener('click', () => saveRecipe());

    // 不足食材モーダル
    btnMissingCancel.addEventListener('click', () => missingOverlay.classList.remove('active'));
    btnMissingRegister.addEventListener('click', () => registerMissingItemsAndRetry());
}

// --- 保存処理 ---

function saveRecipe() {
    const id = document.getElementById('rec-id').value;
    const name = document.getElementById('rec-name').value;
    const yieldVal = document.getElementById('rec-yield').value;
    const url = document.getElementById('rec-url').value;
    const process = document.getElementById('rec-process').value;
    const csvData = document.getElementById('rec-csv').value;

    if (!name) return alert('レシピ名は必須です');
    if (!csvData) return alert('材料CSVを入力してください');

    const payload = {
        name: name,
        yield: yieldVal,
        url: url,
        process: process,
        csv_data: csvData
    };

    let method = 'POST';
    let endpoint = '/api/recipes';
    if (id) {
        method = 'PUT';
        endpoint = `/api/recipes?id=${id}`;
    }

    fetch(endpoint, {
        method: method,
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
    })
    .then(async res => {
        const data = await res.json();
        
        // エラーハンドリング: 不足食材がある場合
        if (!res.ok && data.error_code === 'missing_ingredients') {
            showMissingIngredientsModal(data.items);
            throw new Error('missing_ingredients');
        }

        if (!res.ok) throw new Error(data.error || '登録エラー');
        return data;
    })
    .then(() => {
        alert(id ? 'レシピを更新しました！' : 'レシピを登録しました！');
        document.getElementById('modal-recipe').classList.remove('active');
        fetchRecipes();
    })
    .catch(err => {
        if (err.message !== 'missing_ingredients') {
            alert(err.message);
        }
    });
}

// --- 不足食材のクイック登録 ---

function showMissingIngredientsModal(items) {
    const overlay = document.getElementById('modal-missing-ing');
    const listArea = document.getElementById('missing-list-area');
    listArea.innerHTML = '';

    items.forEach((name, index) => {
        const div = document.createElement('div');
        div.className = 'form-group';
        div.style.background = '#f9f9f9';
        div.style.padding = '10px';
        div.style.borderRadius = '8px';
        
        div.innerHTML = `
            <div style="font-weight:bold; margin-bottom:5px;">${name}</div>
            <div style="display:flex; gap:10px;">
                <select id="missing-class-${index}" class="input-field" style="padding:8px; font-size:12px;">
                    <option value="食材">食材</option>
                    <option value="調味料">調味料</option>
                </select>
                <input type="hidden" id="missing-name-${index}" value="${name}">
            </div>
        `;
        listArea.appendChild(div);
    });

    overlay.classList.add('active');
}

function registerMissingItemsAndRetry() {
    const listArea = document.getElementById('missing-list-area');
    const itemsToRegister = [];
    
    const divs = listArea.querySelectorAll('.form-group');
    divs.forEach((div, index) => {
        const name = document.getElementById(`missing-name-${index}`).value;
        const cls = document.getElementById(`missing-class-${index}`).value;
        
        itemsToRegister.push({
            name: name,
            classification: cls,
            category: cls === '調味料' ? '' : 'その他',
            default_unit: cls === '調味料' ? '' : '個'
        });
    });

    // カタログへの一括登録
    fetch('/api/catalog', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(itemsToRegister)
    })
    .then(res => {
        if (!res.ok) throw new Error('カタログ登録に失敗しました');
        return res.json();
    })
    .then(() => {
        // 成功したらモーダルを閉じて、レシピ保存を再試行
        document.getElementById('modal-missing-ing').classList.remove('active');
        saveRecipe(); 
    })
    .catch(err => alert(err.message));
}

----- C:\Users\wasab\OneDrive\デスクトップ\kimichan2\static\js\recipe_list.js -----
// グローバル変数（edit.jsでも使用）
let recipeData = [];
let currentRecipeDetail = null;
let currentIngredients = [];

// --- 初期化とデータ取得 ---

function initRecipes() {
    // フィルタ情報（冷蔵庫からの遷移など）があるか確認
    const filterId = sessionStorage.getItem('recipe_filter_id');
    const filterName = sessionStorage.getItem('recipe_filter_name');
    
    // ★追加: レシピ検索イベントの設定
    const searchInput = document.getElementById('recipe-search');
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase().trim();
            if (!term) {
                renderRecipes(recipeData);
                return;
            }
            const filtered = recipeData.filter(item => 
                item.name.toLowerCase().includes(term)
            );
            renderRecipes(filtered);
        });
    }
    
    if (filterId) {
        fetchFilteredRecipes(filterId, filterName);
    } else {
        fetchRecipes();
    }
    
    // 編集機能のセットアップ（recipe_edit.jsの関数）
    if (typeof setupRecipeUI === 'function') {
        setupRecipeUI();
    }
}

function fetchRecipes() {
    showFilterHeader(null); // フィルタ表示をクリア
    fetch('/api/recipes')
        .then(res => res.json())
        .then(data => {
            recipeData = data;
            renderRecipes(recipeData);
        })
        .catch(err => console.error(err));
}

function fetchFilteredRecipes(catalogId, itemName) {
    showFilterHeader(itemName); // 「〇〇のレシピ」ヘッダー表示
    fetch(`/api/recipes?ingredient_id=${catalogId}`)
        .then(res => res.json())
        .then(data => {
            recipeData = data;
            renderRecipes(recipeData);
        })
        .catch(err => console.error(err));
}

// フィルタ解除バーの表示
function showFilterHeader(itemName) {
    const listEl = document.getElementById('recipe-list');
    const existing = document.getElementById('filter-status-bar');
    if (existing) existing.remove();

    if (!itemName) return;

    const bar = document.createElement('div');
    bar.id = 'filter-status-bar';
    bar.style.cssText = 'background:#fff3e0; padding:10px 15px; margin-bottom:15px; border-radius:8px; display:flex; justify-content:space-between; align-items:center; color:#e67e22; font-weight:bold; font-size:14px;';
    bar.innerHTML = `
        <span>🔍 ${itemName} のレシピ</span>
        <button id="btn-clear-filter" style="background:#ddd; border:none; padding:5px 10px; border-radius:15px; font-size:12px; cursor:pointer;">解除</button>
    `;
    listEl.parentNode.insertBefore(bar, listEl);

    document.getElementById('btn-clear-filter').addEventListener('click', () => {
        sessionStorage.removeItem('recipe_filter_id');
        sessionStorage.removeItem('recipe_filter_name');
        fetchRecipes(); // 全件再取得
    });
}

// --- リスト描画 ---

function renderRecipes(items) {
    const listEl = document.getElementById('recipe-list');
    if (!listEl) return;
    listEl.innerHTML = '';

    if (items.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color:#999; margin-top:20px;">レシピが見つかりません</p>';
        return;
    }

    items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'card';
        div.onclick = () => openRecipeDetail(item);
        
        // 在庫状況アイコン (クラスを使って視認性を制御)
        const ingIcon = item.has_ingredients ? '<span class="icon-strong">🥦</span>' : '<span class="icon-faint">🥦</span>';
        const seasIcon = item.has_seasonings ? '<span class="icon-strong">🧂</span>' : '<span class="icon-faint">🧂</span>';

        div.innerHTML = `
            <div class="card-content">
                <div style="display:flex; align-items:center; gap:8px;">
                    <span class="item-name">${item.name}</span>
                    <span>${ingIcon} ${seasIcon}</span>
                </div>
                <div style="font-size:11px; color:#666;">${item.yield || ''}</div>
            </div>
            <div style="font-size:20px; color:#ccc;">›</div>
        `;
        listEl.appendChild(div);
    });
}

// --- 詳細画面表示 ---

// --- 詳細画面表示 ---
function openRecipeDetail(recipe) {
    currentRecipeDetail = recipe;
    
    const modal = document.getElementById('modal-recipe-detail');
    const title = document.getElementById('detail-title');
    const yieldDisplay = document.getElementById('detail-yield');
    const link = document.getElementById('detail-link');
    const process = document.getElementById('detail-process');
    const ingArea = document.getElementById('detail-ingredients');
    const missingAlert = document.getElementById('detail-missing-alert');

    title.textContent = recipe.name;
    yieldDisplay.textContent = recipe.yield ? `(${recipe.yield})` : '';
    process.textContent = recipe.process || '（作り方の登録なし）';

    if (recipe.url) {
        link.style.display = 'inline-block';
        link.href = recipe.url;
    } else {
        link.style.display = 'none';
    }

    ingArea.innerHTML = '<div style="text-align:center; color:#999;">読み込み中...</div>';
    if (missingAlert) missingAlert.style.display = 'none';

    fetch(`/api/recipes/ingredients?id=${recipe.id}`)
        .then(res => res.json())
        .then(ingredients => {
            currentIngredients = ingredients || [];

            if (!ingredients || ingredients.length === 0) {
                ingArea.innerHTML = '<div style="color:#999;">材料登録なし</div>';
                return;
            }

            let html = '<ul style="list-style:none; padding:0;">';
            let missingItems = [];
            let currentGroup = "";

            ingredients.forEach(ing => {
                const statusIcon = ing.in_stock ? '✅' : '❌';
                const statusClass = ing.in_stock ? 'ing-status-ok' : 'ing-status-missing';
                
                // ★追加: 在庫がない場合に「＋」ボタンを表示
                let addBtnHtml = '';
                if (!ing.in_stock) {
                    missingItems.push(ing.name);
                    // catalog_id と 名前 を渡す
                    addBtnHtml = `<button class="btn-quick-add" onclick="quickAddToInventory(${ing.catalog_id}, '${ing.name}')">＋在庫へ</button>`;
                }

                if (ing.group_name && ing.group_name !== currentGroup) {
                    currentGroup = ing.group_name;
                    html += `<li class="recipe-group-header">${currentGroup}</li>`;
                } else if (!ing.group_name && currentGroup !== "") {
                    currentGroup = "";
                }

                html += `
                <li style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px dashed #eee; padding:8px 0;">
                    <div style="display:flex; align-items:center;">
                        <span class="${statusClass}">
                            ${statusIcon} ${ing.name}
                        </span>
                        ${addBtnHtml} </div>
                    <span style="font-weight:bold; font-size:13px;">${ing.amount}${ing.unit}</span>
                </li>`;
            });
            html += '</ul>';
            ingArea.innerHTML = html;

            if (missingItems.length > 0 && missingAlert) {
                missingAlert.style.display = 'block';
                missingAlert.innerHTML = `
                    <strong>⚠️ 足りないもの (${missingItems.length})</strong><br>
                    ${missingItems.join('、')}
                `;
            }
        })
        .catch(err => {
            console.error(err);
            ingArea.innerHTML = '<div style="color:red;">読み込みエラー</div>';
        });
        
    modal.classList.add('active');
}

// ★修正: クイック追加機能 (400エラー対策)
window.quickAddToInventory = function(catalogId, name) {
    if (!confirm(`「${name}」を在庫(その他)に追加しますか？`)) return;

    // 数値型に変換（これが重要）
    const catId = parseInt(catalogId, 10);

    if (isNaN(catId) || catId <= 0) {
        alert("エラー: 食材IDが不正です");
        return;
    }

    const data = {
        catalog_id: catId,
        amount: -1, // 在庫ありマーク
        unit: "",
        expiration_date: "", // 空文字でOK
        location: "その他"
    };

    fetch('/api/ingredients', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(async res => {
        if (!res.ok) {
            // エラー内容をテキストで取得して表示
            const errorText = await res.text();
            throw new Error(errorText || res.statusText);
        }
        alert(`「${name}」を追加しました！`);
        
        // 詳細モーダルを閉じる
        const modal = document.getElementById('modal-recipe-detail');
        if(modal) modal.classList.remove('active');
        
        // 在庫リスト画面なら更新
        if (typeof fetchInventory === 'function') fetchInventory();
    })
    .catch(err => {
        console.error("Quick Add Error:", err);
        alert('追加できませんでした: ' + err.message);
    });
};

----- C:\Users\wasab\OneDrive\デスクトップ\kimichan2\static\js\seasoning_fetch.js -----
// グローバル変数として window に公開
window.seasoningData = [];
let catalogListForSeas = [];

function initSeasoning() {
    // 初回: 在庫取得 -> カタログ取得(フィルタリング) の順で実行
    window.fetchSeasoning().then(() => window.fetchCatalogForSeas());
    if (typeof setupSeasoningUI === 'function') {
        setupSeasoningUI();
    }
}

window.fetchSeasoning = function() {
    return fetch('/api/seasonings')
        .then(res => res.json())
        .then(data => {
            window.seasoningData = data; // windowに保存
            if (typeof renderSeasoning === 'function') {
                renderSeasoning(window.seasoningData);
            }
        })
        .catch(err => console.error(err));
};

// グローバルから呼べるようにwindowに登録
window.fetchCatalogForSeas = function() {
    return fetch('/api/catalog')
        .then(res => res.json())
        .then(data => {
            // 1. 在庫に含まれる catalog_id のセットを作成
            const inventoryCatalogIds = new Set(
                window.seasoningData.map(item => item.catalog_id)
            );
            
            // 2. 調味料であり、かつ在庫にないものをフィルタリング
            let filteredData = data.filter(item => {
                const isSeasoning = item.classification === '調味料';
                const isInInventory = inventoryCatalogIds.has(item.id);
                return isSeasoning && !isInInventory;
            });

            // 3. 分類 -> カテゴリ -> 名前/よみがな 順でソート
            filteredData.sort((a, b) => {
                const compare = (keyA, keyB) => keyA.localeCompare(keyB, 'ja');

                let result = compare(a.classification || '', b.classification || '');
                if (result !== 0) return result;

                result = compare(a.category || '', b.category || '');
                if (result !== 0) return result;

                const ka = a.kana || a.name;
                const kb = b.kana || b.name;
                return compare(ka, kb);
            });
            
            catalogListForSeas = filteredData;
            
            // UI側のプルダウン更新関数を呼び出し
            if (typeof updateSeasSelect === 'function') {
                updateSeasSelect();
            }
        });
};

----- C:\Users\wasab\OneDrive\デスクトップ\kimichan2\static\js\seasoning_ui.js -----
function updateSeasSelect() {
    const select = document.getElementById('seas-select-catalog');
    if (!select) return;
    
    select.innerHTML = '<option value="">カタログから選択...</option>';
    // catalogListForSeas は seasoning_fetch.js 内の変数ですが、
    // ここでは単純化のため window.fetchCatalogForSeas 内で代入された変数を利用する前提
    // もしくは window.catalogListForSeas にするか、fetchCatalogForSeas 内で描画までやるのが安全ですが、
    // 既存構造を維持しつつ、catalogListForSeasへのアクセスが必要なら
    // seasoning_fetch.js 側で window.catalogListForSeas = ... としていると仮定、
    // あるいはスコープが共有されている(連結ファイル)前提ならそのままでOK。
    // ※今回は安全策として、前のファイルで変数は閉じていたため、
    // seasoning_fetch.js で `window.catalogListForSeas` に書き換えるか、
    // UI更新をあちらで呼んでいるので、DOM操作だけここに書きます。
    
    // 前回の修正で catalogListForSeas は seasoning_fetch.js のローカル変数でした。
    // ただ updateSeasSelect は seasoning_fetch.js から呼ばれるので、
    // データ引数を受け取る形にするのがベストですが、
    // ここでは `seasoning_fetch.js` の `catalogListForSeas` が参照できない可能性があるため
    // 本来は引数で渡すべきです。
    // ただし、ユーザー様の環境（連結されるか個別か）によります。
    // ★修正: seasoning_fetch.js の変数が参照できない場合を考慮し、
    // updateSeasSelect は DOM生成のみに徹し、データは引数またはwindowから取れるようにすべきですが
    // 一旦、seasoning_fetch.js 内の変数がグローバルスコープにある（scriptタグ並列）と仮定します。
    // もしエラーになる場合は seasoning_fetch.js で window.catalogListForSeas = ... としてください。
    
    // (補足: 今回の提示では seasoning_fetch.js 内の catalogListForSeas はローカル変数のままですが
    //  別ファイルの場合はアクセスできません。fetchCatalogForSeas内で updateSeasSelect(catalogListForSeas) と呼ぶよう変更するのが正しいです。
    //  しかし変更範囲を最小にするため、前回提示の構造に従います)

    // ★修正: リスト構築ロジック
    // グローバル変数が参照できないリスクを回避するため、
    // 本来なら fetchCatalogForSeas で updateSeasSelect(list) と呼ぶべき。
    // ここでは「既存コードが動く前提」で記述しますが、
    // もし動かない場合は seasoning_fetch.js の最後で window.catalogListForSeas = catalogListForSeas; を追加してください。
    
    if (typeof catalogListForSeas !== 'undefined') {
        catalogListForSeas.forEach(item => {
            const opt = document.createElement('option');
            const classification = item.classification || '分類なし';
            const category = item.category || 'カテゴリなし';
            const kana = item.kana ? ` (${item.kana})` : '';
            
            opt.value = item.id;
            opt.textContent = `${classification} / ${category} - ${item.name}${kana}`;
            select.appendChild(opt);
        });
    }
}

function renderSeasoning(items) {
    const listEl = document.getElementById('seasoning-list');
    if (!listEl) return;
    listEl.innerHTML = '';
    
    if (items.length === 0) {
        listEl.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">該当なし</div>';
        return;
    }

    items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'card';
        div.onclick = () => openSeasoningEdit(item);
        
        let statusColor = '#2ecc71'; // 緑
        if (item.status === '少なめ') statusColor = '#f1c40f';
        if (item.status === 'なし') statusColor = '#e74c3c';

        div.innerHTML = `
            <div class="card-content">
                <span class="item-name">${item.name}</span>
            </div>
            <div class="item-unit" style="font-weight:bold; color:${statusColor};">
                ${item.status}
            </div>
        `;
        listEl.appendChild(div);
    });
}

function openSeasoningEdit(item) {
    const overlay = document.getElementById('modal-seasoning-edit');
    document.getElementById('seas-edit-title').textContent = item.name;
    document.getElementById('seas-edit-id').value = item.id;
    overlay.classList.add('active');
}

function setupSeasoningUI() {
    const fab = document.getElementById('fab-add-seasoning');
    const overlay = document.getElementById('modal-seasoning');
    const editOverlay = document.getElementById('modal-seasoning-edit');
    const btnCancel = document.getElementById('btn-seas-cancel');
    const btnSave = document.getElementById('btn-seas-save');
    const select = document.getElementById('seas-select-catalog');
    const searchInput = document.getElementById('seasoning-search'); // ★追加

    // ★調味料検索ロジック
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase().trim();
            if (!window.seasoningData) return;
            
            if (!term) {
                renderSeasoning(window.seasoningData);
                return;
            }
            const filtered = window.seasoningData.filter(item => 
                item.name.toLowerCase().includes(term)
            );
            renderSeasoning(filtered);
        });
    }

    const btnEditCancel = document.getElementById('btn-seas-edit-cancel');
    const btnDelete = document.getElementById('btn-seas-delete');
    if (!fab) return;

    fab.addEventListener('click', () => overlay.classList.add('active'));
    btnCancel.addEventListener('click', () => overlay.classList.remove('active'));
    if (btnEditCancel) {
        btnEditCancel.addEventListener('click', (e) => {
            e.preventDefault();
            editOverlay.classList.remove('active');
        });
    }

    // 追加処理
    btnSave.addEventListener('click', () => {
        const catalogId = parseInt(select.value);
        const status = document.getElementById('seas-status').value;

        if (!catalogId) return alert('調味料を選んでください');

        const data = {
            catalog_id: catalogId,
            status: status
        };

        fetch('/api/seasonings', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        })
        .then(res => {
            if (!res.ok) throw new Error('Failed');
            overlay.classList.remove('active');
            
            // 在庫更新後に、カタログ(プルダウン)も更新する
            return window.fetchSeasoning().then(() => window.fetchCatalogForSeas());
        })
        .catch(err => alert('エラー: ' + err));
    });

    // 削除処理
    if (btnDelete) {
        btnDelete.addEventListener('click', () => {
            const id = document.getElementById('seas-edit-id').value;
            if(!confirm('ストックから外しますか？')) return;

            fetch(`/api/seasonings?id=${id}`, {
                method: 'DELETE'
            })
            .then(res => {
                if (!res.ok) throw new Error('Delete failed');
                editOverlay.classList.remove('active');
                
                // 在庫更新後に、カタログ(プルダウン)も更新する
                return window.fetchSeasoning().then(() => window.fetchCatalogForSeas());
            })
            .catch(err => alert('削除エラー: ' + err));
        });
    }
}

