----- C:\Users\wasab\OneDrive\ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—\kimichan2\static\js\app.js -----
document.addEventListener('DOMContentLoaded', () => {
    const appContainer = document.getElementById('app-container');
    const navItems = document.querySelectorAll('.nav-item');

    function loadView(viewName) {
        // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã®è¦‹ãŸç›®ã‚’æ›´æ–°
        navItems.forEach(nav => {
            if (nav.dataset.view === viewName) {
                nav.classList.add('active');
            } else {
                nav.classList.remove('active');
            }
        });

        fetch(`views/${viewName}_view.html`)
            .then(response => {
                if (!response.ok) throw new Error('View not found');
                return response.text();
            })
            .then(html => {
                appContainer.innerHTML = html;
                
                if (viewName === 'catalog' && typeof initCatalog === 'function') {
                    initCatalog();
                } else if (viewName === 'inventory' && typeof initInventory === 'function') {
                    initInventory();
                } else if (viewName === 'seasoning' && typeof initSeasoning === 'function') {
                    initSeasoning();
                } else if (viewName === 'recipes' && typeof initRecipes === 'function') {
                    initRecipes(); // è¿½åŠ 
                }
            })
            .catch(err => {
                appContainer.innerHTML = '<p style="text-align:center; margin-top:50px;">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</p>';
                console.error(err);
            });
    }

    navItems.forEach(item => {
        item.addEventListener('click', (e) => {
            e.preventDefault();
            const viewName = item.dataset.view;
            loadView(viewName);
        });
    });

    // åˆæœŸè¡¨ç¤º
    loadView('inventory');
});

----- C:\Users\wasab\OneDrive\ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—\kimichan2\static\js\catalog.js -----
let catalogData = [];
let currentCategory = 'ã™ã¹ã¦';

function initCatalog() {
    fetchCatalog();
    setupCatalogUI();
}

function fetchCatalog() {
    fetch('/api/catalog')
        .then(res => res.json())
        .then(data => {
            catalogData = data;
            renderCategoryButtons(catalogData);
            filterAndRender();
        })
        .catch(err => console.error('Fetch error:', err));
}

function renderCategoryButtons(items) {
    const container = document.getElementById('category-filters');
    if (!container) return;

    const categories = new Set(['ã™ã¹ã¦']);
    items.forEach(item => {
        if (item.category) categories.add(item.category);
        else if (item.classification === 'èª¿å‘³æ–™') categories.add('èª¿å‘³æ–™');
        else categories.add('æœªåˆ†é¡');
    });

    container.innerHTML = '';
    categories.forEach(cat => {
        const displayCat = cat === 'æœªåˆ†é¡' ? 'ãã®ä»–' : cat;
        const btn = document.createElement('div');
        btn.className = `cat-chip ${cat === currentCategory ? 'active' : ''}`;
        btn.textContent = displayCat;
        btn.onclick = () => {
            currentCategory = cat;
            document.querySelectorAll('.cat-chip').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            filterAndRender();
        };
        container.appendChild(btn);
    });
}

function filterAndRender() {
    const term = document.getElementById('catalog-search').value.toLowerCase();
    
    let displayData = [...catalogData];

    // ã‚½ãƒ¼ãƒˆãƒ­ã‚¸ãƒƒã‚¯ã®ä¿®æ­£
    if (currentCategory === 'ã™ã¹ã¦') {
        // å…¨ã¦è¡¨ç¤º: IDé™é †ï¼ˆæ–°ç€é †ï¼‰
        displayData.sort((a, b) => b.id - a.id);
    } else {
        // ãã®ä»–ã‚«ãƒ†ã‚´ãƒª: ã‹ãª(åå‰)æ˜‡é †
        displayData.sort((a, b) => {
            const ka = a.kana || a.name;
            const kb = b.kana || b.name;
            return ka.localeCompare(kb, 'ja');
        });
    }

    const filtered = displayData.filter(item => {
        let catMatch = true;
        if (currentCategory !== 'ã™ã¹ã¦') {
            const itemCat = item.category || (item.classification === 'èª¿å‘³æ–™' ? 'èª¿å‘³æ–™' : 'æœªåˆ†é¡');
            catMatch = (itemCat === currentCategory);
        }

        let termMatch = true;
        if (term) {
            termMatch = 
                item.name.toLowerCase().includes(term) || 
                (item.kana && item.kana.toLowerCase().includes(term)) ||
                (item.category && item.category.toLowerCase().includes(term));
        }

        return catMatch && termMatch;
    });
    renderCatalog(filtered);
}

function renderCatalog(items) {
    const listEl = document.getElementById('catalog-list');
    if (!listEl) return;
    
    listEl.innerHTML = '';
    items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'card';
        div.onclick = () => openCatalogEditModal(item);
        
        const tagText = `${item.classification} / ${item.category || (item.classification === 'èª¿å‘³æ–™' ? 'ã‚¹ãƒ‘ã‚¤ã‚¹ç­‰' : 'æœªåˆ†é¡')}`;

        div.innerHTML = `
            <div class="card-content">
                <span class="tag">${tagText}</span>
                <div class="item-name">
                    ${item.name}
                    ${item.kana ? `<span style="font-size:11px; color:#999; font-weight:normal; margin-left:5px;">(${item.kana})</span>` : ''}
                </div>
            </div>
            <div class="item-unit">${item.default_unit || ''}</div>
        `;
        listEl.appendChild(div);
    });
}

function openCatalogEditModal(item) {
    const overlay = document.getElementById('modal-overlay');
    const title = document.getElementById('modal-title');
    const tabSingle = document.getElementById('tab-single');
    const tabCsv = document.getElementById('tab-csv');
    const singleContainer = document.getElementById('form-single');
    const csvContainer = document.getElementById('form-csv');
    
    tabSingle.classList.add('active');
    tabCsv.classList.remove('active');
    singleContainer.style.display = 'block';
    csvContainer.style.display = 'none';
    document.getElementById('csv-result-area').style.display = 'none';
    
    title.textContent = 'ã‚¢ã‚¤ãƒ†ãƒ ç·¨é›†';

    document.getElementById('edit-id').value = item.id;
    document.getElementById('original-unit').value = item.default_unit || '';
    document.getElementById('input-classification').value = item.classification;
    
    updateCategorySelect(item.category);
    
    document.getElementById('input-name').value = item.name;
    document.getElementById('input-kana').value = item.kana || '';
    document.getElementById('input-unit').value = item.default_unit;

    overlay.classList.add('active');
}

function updateCategorySelect(selectedCategory) {
    const select = document.getElementById('select-category');
    const input = document.getElementById('input-category');
    
    const categories = new Set();
    catalogData.forEach(d => {
        if(d.category) categories.add(d.category);
    });

    select.innerHTML = '<option value="">(æ–°è¦å…¥åŠ›)</option>';
    categories.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        select.appendChild(opt);
    });

    if (categories.has(selectedCategory)) {
        select.value = selectedCategory;
        input.style.display = 'none';
        input.value = selectedCategory;
    } else {
        select.value = "";
        input.style.display = 'block';
        input.value = selectedCategory || "";
    }

    select.onchange = () => {
        if (select.value === "") {
            input.style.display = 'block';
            input.value = "";
        } else {
            input.style.display = 'none';
            input.value = select.value;
        }
    };
}

function setupCatalogUI() {
    const fab = document.getElementById('fab-add');
    const overlay = document.getElementById('modal-overlay');
    const btnCancel = document.getElementById('btn-cancel');
    const btnSave = document.getElementById('btn-save');
    const tabSingle = document.getElementById('tab-single');
    const tabCsv = document.getElementById('tab-csv');
    const singleContainer = document.getElementById('form-single');
    const csvContainer = document.getElementById('form-csv');
    const searchInput = document.getElementById('catalog-search');

    const scrollLeft = document.getElementById('scroll-left');
    const scrollRight = document.getElementById('scroll-right');
    const scrollContainer = document.getElementById('category-filters');

    if(scrollLeft && scrollContainer) {
        scrollLeft.onclick = () => scrollContainer.scrollBy({ left: -100, behavior: 'smooth' });
        scrollRight.onclick = () => scrollContainer.scrollBy({ left: 100, behavior: 'smooth' });
    }

    if (!fab) return;

    fab.addEventListener('click', () => {
        document.getElementById('modal-title').textContent = 'ã‚¢ã‚¤ãƒ†ãƒ ç™»éŒ²';
        document.getElementById('edit-id').value = '';
        document.getElementById('original-unit').value = '';
        document.getElementById('input-name').value = '';
        document.getElementById('input-kana').value = '';
        document.getElementById('input-unit').value = '';
        document.getElementById('input-csv-text').value = '';
        
        updateCategorySelect(currentCategory !== 'ã™ã¹ã¦' && currentCategory !== 'æœªåˆ†é¡' ? currentCategory : '');

        document.getElementById('csv-result-area').style.display = 'none';
        
        tabCsv.classList.remove('active');
        tabSingle.classList.add('active');
        singleContainer.style.display = 'block';
        csvContainer.style.display = 'none';
        
        overlay.classList.add('active');
    });

    btnCancel.addEventListener('click', () => {
        overlay.classList.remove('active');
        removeConflictUI();
    });
    searchInput.addEventListener('input', () => {
        filterAndRender();
    });
    tabSingle.addEventListener('click', () => {
        tabSingle.classList.add('active');
        tabCsv.classList.remove('active');
        singleContainer.style.display = 'block';
        csvContainer.style.display = 'none';
        removeConflictUI();
        document.getElementById('csv-result-area').style.display = 'none';
    });
    tabCsv.addEventListener('click', () => {
        tabCsv.classList.add('active');
        tabSingle.classList.remove('active');
        singleContainer.style.display = 'none';
        csvContainer.style.display = 'block';
        removeConflictUI();
    });
    btnSave.addEventListener('click', () => {
        if (singleContainer.style.display !== 'none') {
            saveSingleItem();
        } else {
            saveCsvItem();
        }
    });
}

function removeConflictUI() {
    const conflictDiv = document.getElementById('conflict-resolution-area');
    if (conflictDiv) conflictDiv.remove();
    const btnSave = document.getElementById('btn-save');
    if (btnSave) {
        btnSave.style.display = 'block';
        btnSave.textContent = 'ä¿å­˜';
    }
}

function saveSingleItem() {
    const id = document.getElementById('edit-id').value;
    const name = document.getElementById('input-name').value;
    const originalUnit = document.getElementById('original-unit').value;
    const newUnit = document.getElementById('input-unit').value;

    if (!name) return alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');

    if (id && originalUnit !== newUnit) {
        if (!confirm(`å˜ä½ãŒã€Œ${originalUnit || '(ãªã—)'}ã€ã‹ã‚‰ã€Œ${newUnit || '(ãªã—)'}ã€ã«å¤‰æ›´ã•ã‚Œã¦ã„ã¾ã™ã€‚\nåœ¨åº«ã®æ•°å€¤ï¼ˆä¾‹: 3å€‹ â†’ 3${newUnit}ï¼‰ã®æ„å‘³ãŒå¤‰ã‚ã£ã¦ã—ã¾ã„ã¾ã™ãŒã€ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
            return;
        }
    }

    const item = {
        id: id ? parseInt(id) : 0,
        classification: document.getElementById('input-classification').value,
        category: document.getElementById('input-category').value,
        name: name,
        kana: document.getElementById('input-kana').value,
        default_unit: newUnit,
        force_merge: false
    };

    let method = 'POST';
    if (id) method = 'PUT';

    fetch('/api/catalog', {
        method: method,
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(id ? item : [item])
    })
    .then(async res => {
        const data = await res.json();
        
        if (res.status === 409 && data.error_code === 'merge_confirmation_required') {
            if (confirm(`${data.message}\n\nã€ŒOKã€ã‚’æŠ¼ã™ã¨ãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆã—ã¾ã™ï¼ˆå…ƒã®ãƒ‡ãƒ¼ã‚¿ã¯å‰Šé™¤ã•ã‚Œã€é–¢é€£ãƒ‡ãƒ¼ã‚¿ã¯ç§»å‹•ã—ã¾ã™ï¼‰ã€‚`)) {
                item.force_merge = true;
                return fetch('/api/catalog', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(item)
                }).then(r => r.json());
            } else {
                throw new Error('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
            }
        }

        if (!res.ok) throw new Error(data.error || 'Save failed');
        return data;
    })
    .then(() => {
        document.getElementById('modal-overlay').classList.remove('active');
        fetchCatalog();
        alert('ä¿å­˜ã—ã¾ã—ãŸ');
    })
    .catch(err => {
        if (err.message !== 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ') alert('ã‚¨ãƒ©ãƒ¼: ' + err.message);
    });
}

function saveCsvItem() {
    const text = document.getElementById('input-csv-text').value;
    const resultArea = document.getElementById('csv-result-area');
    
    if (!text) return alert('CSVã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');

    fetch('/import/catalog', {
        method: 'POST',
        headers: {
            'Content-Type': 'text/plain'
        },
        body: text
    })
    .then(async res => {
        if (!res.ok) {
             const errorData = await res.json().catch(() => ({ error: `ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ${res.status}` }));
             throw new Error(errorData.error || `ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ${res.status}`);
        }
        return res.json();
    })
    .then(result => {
        resultArea.style.display = 'block';
        resultArea.innerHTML = `
            <h3>å‡¦ç†çµæœ</h3>
            <p>ç™»éŒ²æˆåŠŸ: <strong>${result.added}</strong> ä»¶</p>
            <p>é‡è¤‡ã‚¹ã‚­ãƒƒãƒ—: <strong>${result.skipped}</strong> ä»¶</p>
        `;

        if (result.errors && result.errors.length > 0) {
            resultArea.innerHTML += `
                <div style="color: red; margin-top:10px; border: 1px solid red; padding: 5px; border-radius: 4px;">
                    <h4>ã‚¨ãƒ©ãƒ¼è©³ç´°:</h4>
                    <ul>${result.errors.map(e => `<li>${e}</li>`).join('')}</ul>
                </div>
            `;
        }

        fetchCatalog();
        document.getElementById('input-csv-text').value = ''; 
    })
    .catch(err => alert('ã‚¨ãƒ©ãƒ¼: ' + err.message));
}

----- C:\Users\wasab\OneDrive\ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—\kimichan2\static\js\inventory_locations.js -----
let locations = []; 
// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‹ã‚‰å‘¼ã¹ã‚‹ã‚ˆã†ã«windowã«ç™»éŒ²
window.fetchLocations = function() {
    return fetch('/api/locations')
        .then(res => res.json())
        .then(data => {
            locations = data;
            // èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã«ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
            renderLocationSelects(); 
        })
        .catch(err => console.error(err));
};

window.renderLocationSelects = function() {
    const selects = [document.getElementById('inv-location'), document.getElementById('inv-edit-location')]; 
    selects.forEach(sel => {
        if (!sel) return;
        const currentVal = sel.value;
        sel.innerHTML = '';
        locations.forEach(loc => {
            const opt = document.createElement('option');
            opt.value = loc.name;
            opt.textContent = loc.name;
            sel.appendChild(opt);
  
        }); 
        if (currentVal && locations.some(l => l.name === currentVal)) {
            sel.value = currentVal;
        } else if (locations.length > 0) {
            const other = locations.find(l => l.name === 'ãã®ä»–');
            sel.value = other ? other.name : locations[0].name;
        }
    });
};

window.setupLocationUI = function() {
    const btnManageLoc = document.getElementById('btn-manage-loc');
    const btnLocClose = document.getElementById('btn-loc-close');
    const btnAddLoc = document.getElementById('btn-add-loc'); 
    const locManageOverlay = document.getElementById('modal-loc-manage');

    if(btnManageLoc) {
        btnManageLoc.addEventListener('click', () => {
            renderLocationManageList(); 
            locManageOverlay.classList.add('active');
        });
    }
    if(btnLocClose) {
        btnLocClose.addEventListener('click', () => {
            locManageOverlay.classList.remove('active');
            renderLocationSelects(); 
            // åœ¨åº«ãƒªã‚¹ãƒˆå†æç”»ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã‚’å‘¼ã¶ï¼‰
            if(typeof fetchInventory === 'function') fetchInventory();
        });
    }
    if(btnAddLoc) {
        btnAddLoc.addEventListener('click', () => {
            const name = document.getElementById('new-loc-name').value;
            if(!name) return;
            fetch('/api/locations', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
        
                body: JSON.stringify({name: name}) 
            })
            .then(res => res.json())
            .then(() => {
                document.getElementById('new-loc-name').value = '';
                window.fetchLocations().then(renderLocationManageList); 
            });
    
        });
    }
};

function renderLocationManageList() {
    const ul = document.getElementById('loc-manage-list');
    ul.innerHTML = ''; 
    locations.forEach((loc, index) => {
        const li = document.createElement('li');
        li.className = 'location-manage-item';
        li.innerHTML = `
            <span>${loc.name}</span>
            <div class="loc-actions">
                ${index > 0 ? `<button onclick="moveLocation(${loc.id}, -1)">â†‘</button>` : ''}
                ${index 
< locations.length - 1 ? `<button onclick="moveLocation(${loc.id}, 1)">â†“</button>` : ''} 
                <button onclick="deleteLocation(${loc.id})" style="color:red;">Ã—</button>
            </div>
        `;
        ul.appendChild(li); 
    });
}

window.moveLocation = function(id, direction) {
    const idx = locations.findIndex(l => l.id === id); 
    if (idx < 0) return;
    const newIdx = idx + direction;
    if (newIdx < 0 || newIdx >= locations.length) return; 
    const temp = locations[idx];
    locations[idx] = locations[newIdx];
    locations[newIdx] = temp; 
    fetch('/api/locations', {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(locations) 
    }).then(() => {
        window.fetchLocations().then(renderLocationManageList); 
    });
};

window.deleteLocation = function(id) {
    if(!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return; 
    fetch(`/api/locations?id=${id}`, { method: 'DELETE' }) 
    .then(() => {
        window.fetchLocations().then(renderLocationManageList); 
    });
};

----- C:\Users\wasab\OneDrive\ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—\kimichan2\static\js\inventory_photos.js -----
let fridgePhotos = [];
let uploadTargetLocation = 'ãã®ä»–';

window.fetchFridgePhotos = function() {
    return fetch('/api/fridge_photos')
        .then(res => res.json())
        .then(data => {
            fridgePhotos = data;
        })
        .catch(err => console.error(err));
};

window.renderLocationPhotos = function(locationName) {
    const photos = fridgePhotos.filter(p => {
        const pLoc = p.location || 'ãã®ä»–';
        return pLoc === locationName;
    });

    const container = document.createElement('div');
    container.className = 'fridge-snapshot-area';

    // æ’®ã‚‹ãƒœã‚¿ãƒ³
    const addBtn = document.createElement('div');
    addBtn.className = 'btn-add-snapshot';
    addBtn.innerHTML = '<span style="font-size:20px;">ğŸ“·</span><br>æ’®ã‚‹';
    addBtn.onclick = () => {
        uploadTargetLocation = locationName;
        const fileInput = document.getElementById('snapshot-file');
        fileInput.value = ''; 
        fileInput.click();
    };
    container.appendChild(addBtn);

    // å†™çœŸãƒªã‚¹ãƒˆ
    photos.forEach(photo => {
        const div = document.createElement('div');
        div.className = 'snapshot-card';
        
        const img = document.createElement('img');
        img.src = `/images/${photo.image_path}`;
        img.className = 'snapshot-img';
        img.onclick = () => openPhotoView(photo.image_path);
        
        const delBtn = document.createElement('button');
        delBtn.className = 'btn-delete-snapshot';
        delBtn.textContent = 'Ã—';
        delBtn.onclick = (e) => deleteFridgePhoto(photo.id, e);

        div.appendChild(img);
        div.appendChild(delBtn);
        container.appendChild(div);
    });

    return container;
};

function openPhotoView(path) {
    const modal = document.getElementById('modal-photo-view');
    const img = document.getElementById('photo-view-img');
    img.src = `/images/${path}`;
    modal.classList.add('active');
}

window.deleteFridgePhoto = function(id, e) {
    e.stopPropagation();
    if (!confirm('ã“ã®å†™çœŸã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    fetch(`/api/fridge_photos?id=${id}`, { method: 'DELETE' })
    .then(() => {
        // å†å–å¾—ã¨å†æç”»ã¯ inventory.js å´ã§åˆ¶å¾¡ã™ã‚‹ãŸã‚ã€ã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œã¾ãŸã¯ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã®ã¿
        return window.fetchFridgePhotos();
    })
    .then(() => {
        if (typeof renderInventory === 'function') {
             // ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªå…¨ä½“ã‚’å†æç”»ã—ã¦å†™çœŸã‚‚æ›´æ–°
             renderInventory(inventoryData);
        }
    });
};

window.setupPhotoUI = function() {
    const snapshotFile = document.getElementById('snapshot-file');
    const btnPhotoClose = document.getElementById('btn-photo-close');
    const photoViewOverlay = document.getElementById('modal-photo-view');

    if (snapshotFile) {
        snapshotFile.addEventListener('change', () => {
            const file = snapshotFile.files[0];
            if (!file) return;
            const formData = new FormData();
            formData.append('photo', file);
            fetch('/api/upload', { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    return fetch('/api/fridge_photos', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ 
                            image_path: data.filename,
                            location: uploadTargetLocation
                        })
                    });
                }
            })
            .then(() => window.fetchFridgePhotos())
            .then(() => {
                if (typeof renderInventory === 'function') {
                     renderInventory(inventoryData);
                }
            })
            .catch(err => alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—'));
        });
    }

    if(btnPhotoClose) {
        btnPhotoClose.addEventListener('click', () => photoViewOverlay.classList.remove('active'));
        photoViewOverlay.addEventListener('click', () => photoViewOverlay.classList.remove('active'));
    }
    
    // å„ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰è¨­å®š (ã“ã“ã¯å¤‰æ›´ãªã—)
    setupImageUpload('inv-file', 'inv-preview', 'inv-image-path');
    setupImageUpload('inv-edit-file', 'inv-edit-preview', 'inv-edit-image-path');
};

function setupImageUpload(inputId, previewId, pathInputId) {
    const input = document.getElementById(inputId);
    const preview = document.getElementById(previewId);
    const pathInput = document.getElementById(pathInputId);

    if(!input) return;

    input.addEventListener('change', () => {
        const file = input.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('photo', file);

        const reader = new FileReader();
        reader.onload = (e) => {
            preview.src = e.target.result;
            preview.classList.add('active');
        };
        reader.readAsDataURL(file);

        fetch('/api/upload', {
            method: 'POST',
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                pathInput.value = data.filename;
            } else {
                alert('ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        })
        .catch(err => {
            console.error(err);
            alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼');
        });
    });
}

----- C:\Users\wasab\OneDrive\ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—\kimichan2\static\js\inventory.js -----
let inventoryData = [];
let catalogListForInv = [];

function initInventory() {
    if (window.fetchLocations) window.fetchLocations();
    
    // å†™çœŸã¨åœ¨åº«ã®ä¸¡æ–¹ã‚’å–å¾—ã—çµ‚ãˆã¦ã‹ã‚‰æç”»ã—ãªã„ã¨ã€å†™çœŸã‚¨ãƒªã‚¢ã«æ—¢å­˜å†™çœŸãŒè¡¨ç¤ºã•ã‚Œãªã„å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚
    // Promise.all ã§ä¸¦åˆ—å–å¾—å¾…ã¡åˆã‚ã›ã‚’è¡Œã†å½¢ã«ä¿®æ­£æ¨å¥¨ã§ã™ãŒã€
    // ã¾ãšã¯ã€Œãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œãªã„ã€ä¸å…·åˆã‚’è§£æ¶ˆã™ã‚‹ãŸã‚ã€å‘¼ã³å‡ºã—é †åºã¯ç¶­æŒã—ã¤ã¤æç”»ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä¿®æ­£ã—ã¾ã™ã€‚
    if (window.fetchFridgePhotos) window.fetchFridgePhotos();

    // åˆå›: åœ¨åº«å–å¾— -> ã‚«ã‚¿ãƒ­ã‚°å–å¾—(ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°) ã®é †ã§å®Ÿè¡Œ
    window.fetchInventory().then(fetchCatalogForInv);
    
    setupInventoryUI();
    if (window.setupLocationUI) window.setupLocationUI();
    if (window.setupPhotoUI) window.setupPhotoUI();
}

window.fetchInventory = function() {
    return fetch('/api/ingredients')
        .then(res => res.json())
        .then(data => {
            inventoryData = data;
            renderInventory(inventoryData);
        })
        .catch(err => console.error(err));
};

function fetchCatalogForInv() {
    fetch('/api/catalog')
        .then(res => res.json())
        .then(data => {
            // 1. åœ¨åº«ã«å«ã¾ã‚Œã‚‹ catalog_id ã®ã‚»ãƒƒãƒˆã‚’ä½œæˆ
            const inventoryCatalogIds = new Set(
                inventoryData.map(item => item.catalog_id)
            );

            // 2. èª¿å‘³æ–™ã‚’é™¤å¤–ã—ã€ã‹ã¤åœ¨åº«ã«ãªã„ã‚‚ã®ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            let filteredData = data.filter(item => {
                const isSeasoning = item.classification === 'èª¿å‘³æ–™';
                const isInInventory = inventoryCatalogIds.has(item.id);
                return !isSeasoning && !isInInventory;
            });

            // 3. ã‚½ãƒ¼ãƒˆ (åˆ†é¡ -> ã‚«ãƒ†ã‚´ãƒª -> åå‰/ã‚ˆã¿ãŒãª)
            filteredData.sort((a, b) => {
                const compare = (keyA, keyB) => keyA.localeCompare(keyB, 'ja');
                let result = compare(a.classification || '', b.classification || '');
                if (result !== 0) return result;
                result = compare(a.category || '', b.category || '');
                if (result !== 0) return result;
                const ka = a.kana || a.name;
                const kb = b.kana || b.name;
                return compare(ka, kb);
            });
            
            catalogListForInv = filteredData;
            updateCatalogSelect();
        });
}

function updateCatalogSelect() {
    const select = document.getElementById('inv-select-catalog');
    if (!select) return;
    select.innerHTML = '<option value="">ã‚«ã‚¿ãƒ­ã‚°ã‹ã‚‰é¸æŠ...</option>';
    catalogListForInv.forEach(item => {
        const opt = document.createElement('option');
        const classification = item.classification || 'åˆ†é¡ãªã—';
        const category = item.category || 'ã‚«ãƒ†ã‚´ãƒªãªã—';
        const kana = item.kana ? ` (${item.kana})` : '';

        // è¡¨ç¤ºå½¢å¼: åˆ†é¡ / ã‚«ãƒ†ã‚´ãƒª - åå‰ (ã‚ˆã¿ãŒãª)
        opt.value = item.id;
        opt.textContent = `${classification} / ${category} - ${item.name}${kana}`;
        opt.dataset.unit = item.default_unit;
        select.appendChild(opt);
    });
}

function renderInventory(items) {
    const listEl = document.getElementById('inventory-list');
    if (!listEl) return;
    listEl.innerHTML = '';
    let currentLocation = null;
    items.forEach(item => {
        if (item.location !== currentLocation) {
            currentLocation = item.location;
            const header = document.createElement('div');
            header.className = 'loc-header-badge';
            header.textContent = currentLocation || 'ãã®ä»–';
            if (listEl.children.length > 0) header.style.marginTop = '15px';
         
            listEl.appendChild(header);

            // â˜…è¿½åŠ ä¿®æ­£: ã“ã“ã«å†™çœŸã‚¨ãƒªã‚¢ã‚’æŒ¿å…¥ã™ã‚‹å‡¦ç†ãŒæŠœã‘ã¦ã„ã¾ã—ãŸ 
            if (window.renderLocationPhotos) {
                // ãã®å ´æ‰€ç”¨ã®å†™çœŸã‚¹ãƒˆãƒªãƒƒãƒ—ã‚’ç”Ÿæˆã—ã¦è¿½åŠ 
                const photoStrip = window.renderLocationPhotos(currentLocation || 'ãã®ä»–');
                listEl.appendChild(photoStrip);
            }
        }

        const div = document.createElement('div');
        div.className = 'card';
        div.onclick = (e) => {
            if (!e.target.classList.contains('recipe-badge')) {
                openInventoryEdit(item);
            }
        };
      
        let badgeHtml = '';
        if (item.recipe_count > 0) {
            badgeHtml = `
            <span class="recipe-badge" onclick="goToFilteredRecipes(${item.catalog_id}, '${item.name}')" 
                  style="background:#e67e22; color:white; padding:4px 10px; border-radius:20px; font-size:11px; font-weight:bold;
margin-left:10px; cursor:pointer;">
                ğŸ³ ${item.recipe_count}
            </span>`;
        }

        let thumbHtml = '';
        if (item.image_path) {
            thumbHtml = `<img src="/images/${item.image_path}" class="list-thumbnail">`;
        }

        let amountDisplay = '';
      
        if (item.amount === -1) {
            amountDisplay = '<span style="color:#27ae60;ont-weight:bold;">åœ¨åº«ã‚ã‚Š</span>';
        } else {
            amountDisplay = `${item.amount} ${item.unit}`;
        }

        div.innerHTML = `
            <div style="display:flex;
align-items:center;">
                ${thumbHtml}
                <div class="card-content" style="flex:1;">
                    <div style="display:flex;
align-items:center;">
                        <span class="tag">æœŸé™: ${item.expiration_date.split('T')[0]}</span>
                    </div>
                    <div style="display:flex;
align-items:center; margin-top:4px;">
                        <span class="item-name">${item.name}</span>
                        ${badgeHtml}
                    </div>
                </div>
            </div>
  
           <div class="item-unit">${amountDisplay}</div>
        `;
        listEl.appendChild(div);
    });
}

window.goToFilteredRecipes = function(catalogId, itemName) {
    sessionStorage.setItem('recipe_filter_id', catalogId);
    sessionStorage.setItem('recipe_filter_name', itemName);
    const recipeTab = document.querySelector('a[data-view="recipes"]');
    if(recipeTab) recipeTab.click();
};

function openInventoryEdit(item) {
    const overlay = document.getElementById('modal-inv-edit');
    document.getElementById('inv-edit-title').textContent = item.name + ' ã®ç®¡ç†';
    document.getElementById('inv-edit-id').value = item.id;
    document.getElementById('inv-edit-amount').value = item.amount;
    document.getElementById('inv-edit-unit').textContent = item.unit;
    document.getElementById('inv-edit-date').value = item.expiration_date.split('T')[0];

    const locSelect = document.getElementById('inv-edit-location');
    if(item.location) {
        locSelect.value = item.location;
    }
    overlay.classList.add('active');
}

window.addAmount = function(val) {
    const input = document.getElementById('inv-amount');
    let current = parseFloat(input.value) || 0;
    let nextVal = current + val;
    
    if (nextVal < 0) nextVal = 0;
    
    input.value = Math.round(nextVal * 10) / 10;
};

function setupInventoryUI() {
    const fab = document.getElementById('fab-add-inventory');
    const overlay = document.getElementById('modal-inventory');
    const editOverlay = document.getElementById('modal-inv-edit');
    const btnCancel = document.getElementById('btn-inv-cancel');
    const btnSave = document.getElementById('btn-inv-save');
    const btnEditCancel = document.getElementById('btn-inv-edit-cancel');
    const btnUpdate = document.getElementById('btn-inv-update');
    const btnDelete = document.getElementById('btn-inv-delete');
    const select = document.getElementById('inv-select-catalog');
    const unitInput = document.getElementById('inv-unit');

    // è©³ç´°ã‚¹ã‚¤ãƒƒãƒåˆ¶å¾¡
    const detailToggle = document.getElementById('inv-detail-toggle');
    const detailArea = document.getElementById('inv-detail-area');
    if (detailToggle) {
        detailToggle.addEventListener('change', (e) => {
            if (e.target.checked) {
                detailArea.style.display = 'block';
            } else {
                detailArea.style.display = 'none';
            }
       
        });
    }

    if (!fab) return;

    fab.addEventListener('click', () => {
        document.getElementById('inv-detail-toggle').checked = false;
        document.getElementById('inv-detail-area').style.display = 'none';
        document.getElementById('inv-amount').value = 1; 
        
        overlay.classList.add('active');
    });
    btnCancel.addEventListener('click', () => overlay.classList.remove('active'));
    btnEditCancel.addEventListener('click', (e) => {
        e.preventDefault();
        editOverlay.classList.remove('active');
    });
    select.addEventListener('change', () => {
        const selected = select.options[select.selectedIndex];
        const u = selected.dataset.unit || '';
        unitInput.value = u;
    });

    // ä¿å­˜å‡¦ç†
    btnSave.addEventListener('click', () => {
        const catalogId = parseInt(select.value);
        const location = document.getElementById('inv-location').value;

        let amount = -1;
        let date = "";
        
        if (document.getElementById('inv-detail-toggle').checked) {
            amount = parseFloat(document.getElementById('inv-amount').value);
            if (isNaN(amount)) amount = 1; 
            date = document.getElementById('inv-date').value;
        }

        let expirationDate = "";
        if (date) {
            expirationDate = date + "T00:00:00Z";
        }

        if (!catalogId) return alert('é£Ÿæã‚’é¸ã‚“ã§ãã ã•ã„');

        const data = {
            catalog_id: catalogId,
            amount: amount,
            unit: unitInput.value,
            expiration_date: expirationDate,
            location: location
        };

        fetch('/api/ingredients', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        })
        .then(res => {
            if (!res.ok) throw new Error('Failed');
            overlay.classList.remove('active');
            
            // åœ¨åº«æ›´æ–°å¾Œã«ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚‚æ›´æ–°
            window.fetchInventory().then(() => fetchCatalogForInv());
        })
        .catch(err => alert('ã‚¨ãƒ©ãƒ¼: ' + err));
    });

    // æ›´æ–°å‡¦ç†
    btnUpdate.addEventListener('click', () => {
        const id = document.getElementById('inv-edit-id').value;
        const amount = parseFloat(document.getElementById('inv-edit-amount').value);
        const date = document.getElementById('inv-edit-date').value;
        const location = document.getElementById('inv-edit-location').value;

        if (isNaN(amount)) return alert('æ•°é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');

        let expirationDate = "";
        if (date) {
            expirationDate = date.includes('T') ? date : date + "T00:00:00Z";
        }

        const data = {
            id: parseInt(id),
            amount: amount,
            expiration_date: expirationDate,
            location: location
        };

        fetch('/api/ingredients', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        })
        .then(res => {
            if (!res.ok) throw new Error('Update failed');
            editOverlay.classList.remove('active');

            // åœ¨åº«æ›´æ–°å¾Œã«ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚‚æ›´æ–°
            window.fetchInventory().then(() => fetchCatalogForInv());
        })
        .catch(err => alert('æ›´æ–°ã‚¨ãƒ©ãƒ¼: ' + err));
    });

    // å‰Šé™¤å‡¦ç†
    btnDelete.addEventListener('click', () => {
        if (!confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆä½¿ã„åˆ‡ã£ãŸã“ã¨ã«ãªã‚Šã¾ã™ï¼‰')) return;
        const id = document.getElementById('inv-edit-id').value;
        fetch(`/api/ingredients?id=${id}`, { method: 'DELETE' })
        .then(res => {
            if (!res.ok) throw new Error('Delete failed');
            editOverlay.classList.remove('active');

            // åœ¨åº«æ›´æ–°å¾Œã«ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚‚æ›´æ–°
            window.fetchInventory().then(() => fetchCatalogForInv());
        })
        .catch(err => alert('å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ' + err));
    });
}

----- C:\Users\wasab\OneDrive\ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—\kimichan2\static\js\recipe_edit.js -----
// --- ç·¨é›†ç”»é¢ ---

function openRecipeEditModal() {
    // è©³ç´°ç”»é¢ã‚’é–‰ã˜ã‚‹
    document.getElementById('modal-recipe-detail').classList.remove('active');
    
    // ã‚¿ã‚¤ãƒˆãƒ«å¤‰æ›´
    document.getElementById('modal-recipe-title').textContent = 'ãƒ¬ã‚·ãƒ”ç·¨é›†';
    
    // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«ã‚»ãƒƒãƒˆ
    document.getElementById('rec-id').value = currentRecipeDetail.id;
    document.getElementById('rec-name').value = currentRecipeDetail.name;
    document.getElementById('rec-yield').value = currentRecipeDetail.yield || '';
    document.getElementById('rec-url').value = currentRecipeDetail.url;
    document.getElementById('rec-process').value = currentRecipeDetail.process;

    // ææ–™ãƒªã‚¹ãƒˆã‚’CSVãƒ†ã‚­ã‚¹ãƒˆã«å¤‰æ›ã—ã¦ã‚»ãƒƒãƒˆ
    let csvText = "";
    if (currentIngredients && currentIngredients.length > 0) {
        csvText = currentIngredients.map(ing => {
            // å½¢å¼: åå‰,åˆ†é‡,å˜ä½
            return `${ing.name},${ing.amount},${ing.unit}`;
        }).join('\n');
    }
    document.getElementById('rec-csv').value = csvText;

    // ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    document.getElementById('modal-recipe').classList.add('active');
}

// --- UIã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š ---

function setupRecipeUI() {
    const fab = document.getElementById('fab-add-recipe');
    const overlay = document.getElementById('modal-recipe');
    const detailOverlay = document.getElementById('modal-recipe-detail');
    const missingOverlay = document.getElementById('modal-missing-ing');

    const btnCancel = document.getElementById('btn-rec-cancel');
    const btnSave = document.getElementById('btn-rec-save');
    const btnDetailClose = document.getElementById('btn-detail-close');
    const btnDetailEdit = document.getElementById('btn-detail-edit');
    
    const btnMissingCancel = document.getElementById('btn-missing-cancel');
    const btnMissingRegister = document.getElementById('btn-missing-register');

    if (!fab) return;

    // æ–°è¦ç™»éŒ²ãƒœã‚¿ãƒ³
    fab.addEventListener('click', () => {
        document.getElementById('modal-recipe-title').textContent = 'ãƒ¬ã‚·ãƒ”ç™»éŒ²';
        document.getElementById('rec-id').value = ''; 
        document.getElementById('rec-name').value = '';
        document.getElementById('rec-yield').value = '';
        document.getElementById('rec-url').value = '';
        document.getElementById('rec-process').value = '';
        document.getElementById('rec-csv').value = '';
        overlay.classList.add('active');
    });
    
    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ»é–‰ã˜ã‚‹
    btnCancel.addEventListener('click', () => overlay.classList.remove('active'));
    btnDetailClose.addEventListener('click', () => detailOverlay.classList.remove('active'));
    
    // ç·¨é›†ãƒœã‚¿ãƒ³
    btnDetailEdit.addEventListener('click', () => openRecipeEditModal());

    // ä¿å­˜å®Ÿè¡Œ
    btnSave.addEventListener('click', () => saveRecipe());

    // ä¸è¶³é£Ÿæãƒ¢ãƒ¼ãƒ€ãƒ«
    btnMissingCancel.addEventListener('click', () => missingOverlay.classList.remove('active'));
    btnMissingRegister.addEventListener('click', () => registerMissingItemsAndRetry());
}

// --- ä¿å­˜å‡¦ç† ---

function saveRecipe() {
    const id = document.getElementById('rec-id').value;
    const name = document.getElementById('rec-name').value;
    const yieldVal = document.getElementById('rec-yield').value;
    const url = document.getElementById('rec-url').value;
    const process = document.getElementById('rec-process').value;
    const csvData = document.getElementById('rec-csv').value;

    if (!name) return alert('ãƒ¬ã‚·ãƒ”åã¯å¿…é ˆã§ã™');
    if (!csvData) return alert('ææ–™CSVã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');

    const payload = {
        name: name,
        yield: yieldVal,
        url: url,
        process: process,
        csv_data: csvData
    };

    let method = 'POST';
    let endpoint = '/api/recipes';
    if (id) {
        method = 'PUT';
        endpoint = `/api/recipes?id=${id}`;
    }

    fetch(endpoint, {
        method: method,
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
    })
    .then(async res => {
        const data = await res.json();
        
        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°: ä¸è¶³é£ŸæãŒã‚ã‚‹å ´åˆ
        if (!res.ok && data.error_code === 'missing_ingredients') {
            showMissingIngredientsModal(data.items);
            throw new Error('missing_ingredients');
        }

        if (!res.ok) throw new Error(data.error || 'ç™»éŒ²ã‚¨ãƒ©ãƒ¼');
        return data;
    })
    .then(() => {
        alert(id ? 'ãƒ¬ã‚·ãƒ”ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼' : 'ãƒ¬ã‚·ãƒ”ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼');
        document.getElementById('modal-recipe').classList.remove('active');
        fetchRecipes();
    })
    .catch(err => {
        if (err.message !== 'missing_ingredients') {
            alert(err.message);
        }
    });
}

// --- ä¸è¶³é£Ÿæã®ã‚¯ã‚¤ãƒƒã‚¯ç™»éŒ² ---

function showMissingIngredientsModal(items) {
    const overlay = document.getElementById('modal-missing-ing');
    const listArea = document.getElementById('missing-list-area');
    listArea.innerHTML = '';

    items.forEach((name, index) => {
        const div = document.createElement('div');
        div.className = 'form-group';
        div.style.background = '#f9f9f9';
        div.style.padding = '10px';
        div.style.borderRadius = '8px';
        
        div.innerHTML = `
            <div style="font-weight:bold; margin-bottom:5px;">${name}</div>
            <div style="display:flex; gap:10px;">
                <select id="missing-class-${index}" class="input-field" style="padding:8px; font-size:12px;">
                    <option value="é£Ÿæ">é£Ÿæ</option>
                    <option value="èª¿å‘³æ–™">èª¿å‘³æ–™</option>
                </select>
                <input type="hidden" id="missing-name-${index}" value="${name}">
            </div>
        `;
        listArea.appendChild(div);
    });

    overlay.classList.add('active');
}

function registerMissingItemsAndRetry() {
    const listArea = document.getElementById('missing-list-area');
    const itemsToRegister = [];
    
    const divs = listArea.querySelectorAll('.form-group');
    divs.forEach((div, index) => {
        const name = document.getElementById(`missing-name-${index}`).value;
        const cls = document.getElementById(`missing-class-${index}`).value;
        
        itemsToRegister.push({
            name: name,
            classification: cls,
            category: cls === 'èª¿å‘³æ–™' ? '' : 'ãã®ä»–',
            default_unit: cls === 'èª¿å‘³æ–™' ? '' : 'å€‹'
        });
    });

    // ã‚«ã‚¿ãƒ­ã‚°ã¸ã®ä¸€æ‹¬ç™»éŒ²
    fetch('/api/catalog', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(itemsToRegister)
    })
    .then(res => {
        if (!res.ok) throw new Error('ã‚«ã‚¿ãƒ­ã‚°ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
        return res.json();
    })
    .then(() => {
        // æˆåŠŸã—ãŸã‚‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¦ã€ãƒ¬ã‚·ãƒ”ä¿å­˜ã‚’å†è©¦è¡Œ
        document.getElementById('modal-missing-ing').classList.remove('active');
        saveRecipe(); 
    })
    .catch(err => alert(err.message));
}

----- C:\Users\wasab\OneDrive\ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—\kimichan2\static\js\recipe_list.js -----
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼ˆedit.jsã§ã‚‚ä½¿ç”¨ï¼‰
let recipeData = [];
let currentRecipeDetail = null;
let currentIngredients = [];

// --- åˆæœŸåŒ–ã¨ãƒ‡ãƒ¼ã‚¿å–å¾— ---

function initRecipes() {
    // ãƒ•ã‚£ãƒ«ã‚¿æƒ…å ±ï¼ˆå†·è”µåº«ã‹ã‚‰ã®é·ç§»ãªã©ï¼‰ãŒã‚ã‚‹ã‹ç¢ºèª
    const filterId = sessionStorage.getItem('recipe_filter_id');
    const filterName = sessionStorage.getItem('recipe_filter_name');
    
    if (filterId) {
        fetchFilteredRecipes(filterId, filterName);
    } else {
        fetchRecipes();
    }
    
    // ç·¨é›†æ©Ÿèƒ½ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆrecipe_edit.jsã®é–¢æ•°ï¼‰
    if (typeof setupRecipeUI === 'function') {
        setupRecipeUI();
    }
}

function fetchRecipes() {
    showFilterHeader(null); // ãƒ•ã‚£ãƒ«ã‚¿è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
    fetch('/api/recipes')
        .then(res => res.json())
        .then(data => {
            recipeData = data;
            renderRecipes(recipeData);
        })
        .catch(err => console.error(err));
}

function fetchFilteredRecipes(catalogId, itemName) {
    showFilterHeader(itemName); // ã€Œã€‡ã€‡ã®ãƒ¬ã‚·ãƒ”ã€ãƒ˜ãƒƒãƒ€ãƒ¼è¡¨ç¤º
    fetch(`/api/recipes?ingredient_id=${catalogId}`)
        .then(res => res.json())
        .then(data => {
            recipeData = data;
            renderRecipes(recipeData);
        })
        .catch(err => console.error(err));
}

// ãƒ•ã‚£ãƒ«ã‚¿è§£é™¤ãƒãƒ¼ã®è¡¨ç¤º
function showFilterHeader(itemName) {
    const listEl = document.getElementById('recipe-list');
    const existing = document.getElementById('filter-status-bar');
    if (existing) existing.remove();

    if (!itemName) return;

    const bar = document.createElement('div');
    bar.id = 'filter-status-bar';
    bar.style.cssText = 'background:#fff3e0; padding:10px 15px; margin-bottom:15px; border-radius:8px; display:flex; justify-content:space-between; align-items:center; color:#e67e22; font-weight:bold; font-size:14px;';
    bar.innerHTML = `
        <span>ğŸ” ${itemName} ã®ãƒ¬ã‚·ãƒ”</span>
        <button id="btn-clear-filter" style="background:#ddd; border:none; padding:5px 10px; border-radius:15px; font-size:12px; cursor:pointer;">è§£é™¤</button>
    `;
    listEl.parentNode.insertBefore(bar, listEl);

    document.getElementById('btn-clear-filter').addEventListener('click', () => {
        sessionStorage.removeItem('recipe_filter_id');
        sessionStorage.removeItem('recipe_filter_name');
        fetchRecipes(); // å…¨ä»¶å†å–å¾—
    });
}

// --- ãƒªã‚¹ãƒˆæç”» ---

function renderRecipes(items) {
    const listEl = document.getElementById('recipe-list');
    if (!listEl) return;
    listEl.innerHTML = '';

    if (items.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color:#999; margin-top:20px;">ãƒ¬ã‚·ãƒ”ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>';
        return;
    }

    items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'card';
        div.onclick = () => openRecipeDetail(item);
        
        // åœ¨åº«çŠ¶æ³ã‚¢ã‚¤ã‚³ãƒ³ (ã‚¯ãƒ©ã‚¹ã‚’ä½¿ã£ã¦è¦–èªæ€§ã‚’åˆ¶å¾¡)
        const ingIcon = item.has_ingredients ? '<span class="icon-strong">ğŸ¥¦</span>' : '<span class="icon-faint">ğŸ¥¦</span>';
        const seasIcon = item.has_seasonings ? '<span class="icon-strong">ğŸ§‚</span>' : '<span class="icon-faint">ğŸ§‚</span>';

        div.innerHTML = `
            <div class="card-content">
                <div style="display:flex; align-items:center; gap:8px;">
                    <span class="item-name">${item.name}</span>
                    <span>${ingIcon} ${seasIcon}</span>
                </div>
                <div style="font-size:11px; color:#666;">${item.yield || ''}</div>
            </div>
            <div style="font-size:20px; color:#ccc;">â€º</div>
        `;
        listEl.appendChild(div);
    });
}

// --- è©³ç´°ç”»é¢è¡¨ç¤º ---

function openRecipeDetail(recipe) {
    currentRecipeDetail = recipe;
    
    const modal = document.getElementById('modal-recipe-detail');
    const title = document.getElementById('detail-title');
    const yieldDisplay = document.getElementById('detail-yield');
    const link = document.getElementById('detail-link');
    const process = document.getElementById('detail-process');
    const ingArea = document.getElementById('detail-ingredients');
    const missingAlert = document.getElementById('detail-missing-alert');
    
    title.textContent = recipe.name;
    yieldDisplay.textContent = recipe.yield ? `(${recipe.yield})` : '';
    process.textContent = recipe.process || 'ï¼ˆä½œã‚Šæ–¹ã®ç™»éŒ²ãªã—ï¼‰';
    
    if (recipe.url) {
        link.style.display = 'inline-block';
        link.href = recipe.url;
    } else {
        link.style.display = 'none';
    }

    ingArea.innerHTML = '<div style="text-align:center; color:#999;">èª­ã¿è¾¼ã¿ä¸­...</div>';
    if (missingAlert) missingAlert.style.display = 'none';

    // ææ–™APIã‚’å©ã„ã¦è©³ç´°æƒ…å ±ã‚’å–å¾—
    fetch(`/api/recipes/ingredients?id=${recipe.id}`)
        .then(res => res.json())
        .then(ingredients => {
            currentIngredients = ingredients || [];

            if (!ingredients || ingredients.length === 0) {
                ingArea.innerHTML = '<div style="color:#999;">ææ–™ç™»éŒ²ãªã—</div>';
                return;
            }

            let html = '<ul style="list-style:none; padding:0;">';
            let missingItems = [];
            let currentGroup = "";

            ingredients.forEach(ing => {
                // åœ¨åº«ãƒã‚§ãƒƒã‚¯
                const statusIcon = ing.in_stock ? 'âœ…' : 'âŒ';
                const statusClass = ing.in_stock ? 'ing-status-ok' : 'ing-status-missing';
                
                if (!ing.in_stock) {
                    missingItems.push(ing.name);
                }

                // ã‚°ãƒ«ãƒ¼ãƒ—è¦‹å‡ºã—ã®æŒ¿å…¥ (ï¼ã‚½ãƒ¼ã‚¹ï¼ ãªã©)
                if (ing.group_name && ing.group_name !== currentGroup) {
                    currentGroup = ing.group_name;
                    html += `<li class="recipe-group-header">${currentGroup}</li>`;
                } else if (!ing.group_name && currentGroup !== "") {
                    currentGroup = ""; // ã‚°ãƒ«ãƒ¼ãƒ—çµ‚äº†
                }

                html += `
                <li style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px dashed #eee; padding:8px 0;">
                    <span class="${statusClass}">
                        ${statusIcon} ${ing.name}
                    </span>
                    <span style="font-weight:bold; font-size:13px;">${ing.amount}${ing.unit}</span>
                </li>`;
            });
            html += '</ul>';
            ingArea.innerHTML = html;

            // è¶³ã‚Šãªã„ã‚‚ã®ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
            if (missingItems.length > 0 && missingAlert) {
                missingAlert.style.display = 'block';
                missingAlert.innerHTML = `
                    <strong>âš ï¸ è¶³ã‚Šãªã„ã‚‚ã® (${missingItems.length})</strong><br>
                    ${missingItems.join('ã€')}
                `;
            }
        })
        .catch(err => {
            console.error(err);
            ingArea.innerHTML = '<div style="color:red;">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</div>';
        });

    modal.classList.add('active');
}

----- C:\Users\wasab\OneDrive\ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—\kimichan2\static\js\seasoning_fetch.js -----
let seasoningData = [];
let catalogListForSeas = [];

function initSeasoning() {
    // åˆå›: åœ¨åº«å–å¾— -> ã‚«ã‚¿ãƒ­ã‚°å–å¾—(ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°) ã®é †ã§å®Ÿè¡Œ
    window.fetchSeasoning().then(() => window.fetchCatalogForSeas());
    
    if (typeof setupSeasoningUI === 'function') {
        setupSeasoningUI();
    }
}

window.fetchSeasoning = function() {
    return fetch('/api/seasonings')
        .then(res => res.json())
        .then(data => {
            seasoningData = data;
            if (typeof renderSeasoning === 'function') {
                renderSeasoning(seasoningData);
            }
        })
        .catch(err => console.error(err));
};

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‹ã‚‰å‘¼ã¹ã‚‹ã‚ˆã†ã«windowã«ç™»éŒ²
window.fetchCatalogForSeas = function() {
    return fetch('/api/catalog')
        .then(res => res.json())
        .then(data => {
            // 1. åœ¨åº«ã«å«ã¾ã‚Œã‚‹ catalog_id ã®ã‚»ãƒƒãƒˆã‚’ä½œæˆ
            const inventoryCatalogIds = new Set(
                seasoningData.map(item => item.catalog_id)
            );
            
            // 2. èª¿å‘³æ–™ã§ã‚ã‚Šã€ã‹ã¤åœ¨åº«ã«ãªã„ã‚‚ã®ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            let filteredData = data.filter(item => {
                const isSeasoning = item.classification === 'èª¿å‘³æ–™';
                const isInInventory = inventoryCatalogIds.has(item.id);
                return isSeasoning && !isInInventory;
            });

            // 3. åˆ†é¡ -> ã‚«ãƒ†ã‚´ãƒª -> åå‰/ã‚ˆã¿ãŒãª é †ã§ã‚½ãƒ¼ãƒˆ
            filteredData.sort((a, b) => {
                const compare = (keyA, keyB) => keyA.localeCompare(keyB, 'ja');

                let result = compare(a.classification || '', b.classification || '');
                if (result !== 0) return result;

                result = compare(a.category || '', b.category || '');
                if (result !== 0) return result;

                const ka = a.kana || a.name;
                const kb = b.kana || b.name;
                return compare(ka, kb);
            });
            
            catalogListForSeas = filteredData;
            
            // UIå´ã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³æ›´æ–°é–¢æ•°ã‚’å‘¼ã³å‡ºã—
            if (typeof updateSeasSelect === 'function') {
                updateSeasSelect();
            }
        });
};

----- C:\Users\wasab\OneDrive\ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—\kimichan2\static\js\seasoning_ui.js -----
function updateSeasSelect() {
    const select = document.getElementById('seas-select-catalog');
    if (!select) return;
    
    select.innerHTML = '<option value="">ã‚«ã‚¿ãƒ­ã‚°ã‹ã‚‰é¸æŠ...</option>';
    catalogListForSeas.forEach(item => {
        const opt = document.createElement('option');
        const classification = item.classification || 'åˆ†é¡ãªã—';
        const category = item.category || 'ã‚«ãƒ†ã‚´ãƒªãªã—';
        const kana = item.kana ? ` (${item.kana})` : '';
        
        // è¡¨ç¤ºå½¢å¼: åˆ†é¡ / ã‚«ãƒ†ã‚´ãƒª - åå‰ (ã‚ˆã¿ãŒãª)
        opt.value = item.id;
        opt.textContent = `${classification} / ${category} - ${item.name}${kana}`;
        select.appendChild(opt);
    });
}

function renderSeasoning(items) {
    const listEl = document.getElementById('seasoning-list');
    if (!listEl) return;
    listEl.innerHTML = '';
    items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'card';
        div.onclick = () => openSeasoningEdit(item);
        
        let statusColor = '#2ecc71'; // ç·‘
        if (item.status === 'å°‘ãªã‚') statusColor = '#f1c40f';
        if (item.status === 'ãªã—') statusColor = '#e74c3c';

        div.innerHTML = `
            <div class="card-content">
                <span class="item-name">${item.name}</span>
            </div>
            <div class="item-unit" style="font-weight:bold; color:${statusColor};">
                ${item.status}
            </div>
        `;
        listEl.appendChild(div);
    });
}

function openSeasoningEdit(item) {
    const overlay = document.getElementById('modal-seasoning-edit');
    document.getElementById('seas-edit-title').textContent = item.name;
    document.getElementById('seas-edit-id').value = item.id;
    overlay.classList.add('active');
}

function setupSeasoningUI() {
    const fab = document.getElementById('fab-add-seasoning');
    const overlay = document.getElementById('modal-seasoning');
    const editOverlay = document.getElementById('modal-seasoning-edit');
    const btnCancel = document.getElementById('btn-seas-cancel');
    const btnSave = document.getElementById('btn-seas-save');
    const select = document.getElementById('seas-select-catalog');

    const btnEditCancel = document.getElementById('btn-seas-edit-cancel');
    const btnDelete = document.getElementById('btn-seas-delete');
    if (!fab) return;

    fab.addEventListener('click', () => overlay.classList.add('active'));
    btnCancel.addEventListener('click', () => overlay.classList.remove('active'));
    if (btnEditCancel) {
        btnEditCancel.addEventListener('click', (e) => {
            e.preventDefault();
            editOverlay.classList.remove('active');
        });
    }

    // è¿½åŠ å‡¦ç†
    btnSave.addEventListener('click', () => {
        const catalogId = parseInt(select.value);
        const status = document.getElementById('seas-status').value;

        if (!catalogId) return alert('èª¿å‘³æ–™ã‚’é¸ã‚“ã§ãã ã•ã„');

        const data = {
            catalog_id: catalogId,
            status: status
        };

        fetch('/api/seasonings', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        })
        .then(res => {
            if (!res.ok) throw new Error('Failed');
            overlay.classList.remove('active');
            
            // â˜…ä¿®æ­£: åœ¨åº«æ›´æ–°å¾Œã«ã€ã‚«ã‚¿ãƒ­ã‚°(ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³)ã‚‚æ›´æ–°ã™ã‚‹
            return window.fetchSeasoning().then(() => window.fetchCatalogForSeas());
        })
        .catch(err => alert('ã‚¨ãƒ©ãƒ¼: ' + err));
    });

    // å‰Šé™¤å‡¦ç†
    if (btnDelete) {
        btnDelete.addEventListener('click', () => {
            const id = document.getElementById('seas-edit-id').value;
            if(!confirm('ã‚¹ãƒˆãƒƒã‚¯ã‹ã‚‰å¤–ã—ã¾ã™ã‹ï¼Ÿ')) return;

            fetch(`/api/seasonings?id=${id}`, {
                method: 'DELETE'
            })
            .then(res => {
                if (!res.ok) throw new Error('Delete failed');
                editOverlay.classList.remove('active');
                
                // â˜…ä¿®æ­£: åœ¨åº«æ›´æ–°å¾Œã«ã€ã‚«ã‚¿ãƒ­ã‚°(ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³)ã‚‚æ›´æ–°ã™ã‚‹
                return window.fetchSeasoning().then(() => window.fetchCatalogForSeas());
            })
            .catch(err => alert('å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ' + err));
        });
    }
}

