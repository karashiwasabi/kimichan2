----- C:\Users\wasab\OneDrive\ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—\kimichan2\static\js\app.js -----
document.addEventListener('DOMContentLoaded', () => {
    const appContainer = document.getElementById('app-container');
    const navItems = document.querySelectorAll('.nav-item');

    function loadView(viewName) {
        navItems.forEach(nav => {
            if (nav.dataset.view === viewName) {
                nav.classList.add('active');
            } else {
                nav.classList.remove('active');
            }
        });

        fetch(`views/${viewName}_view.html`)
            .then(response => {
                if (!response.ok) throw new Error('View not found');
                return response.text();
            })
            .then(html => {
                appContainer.innerHTML = html;
                
                if (viewName === 'catalog' && typeof initCatalog === 'function') {
                    initCatalog();
                } else if (viewName === 'inventory' && typeof initInventory === 'function') {
                    initInventory();
                } else if (viewName === 'recipes' && typeof initRecipes === 'function') {
                    initRecipes();
                }
                // èª¿å‘³æ–™(seasoning)ã¯å‰Šé™¤
            })
            .catch(err => {
                appContainer.innerHTML = '<p style="text-align:center; margin-top:50px;">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</p>';
                console.error(err);
            });
    }

    navItems.forEach(item => {
        item.addEventListener('click', (e) => {
            e.preventDefault();
            const viewName = item.dataset.view;
            loadView(viewName);
        });
    });

    loadView('inventory');
});

----- C:\Users\wasab\OneDrive\ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—\kimichan2\static\js\catalog_edit.js -----
// catalog_list.js ã§å®šç¾©ã—ãŸ FIXED_CATEGORIES ã‚’å‚ç…§ã—ãŸã„ãŒã€
// ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆ†å‰²ã•ã‚Œã¦ã„ãªã„ãŸã‚å†å®šç¾©ã—ã¦å®‰å…¨ç­–ã‚’å–ã‚Šã¾ã™
// â˜…ä¿®æ­£: ã“ã“ã‹ã‚‰ã€Œèª¿å‘³æ–™ã€ã‚’é™¤å¤–ã—ã¾ã—ãŸï¼ˆé£Ÿæç”¨ã®ãƒªã‚¹ãƒˆã¨ã™ã‚‹ãŸã‚ï¼‰
const FIXED_CATEGORIES_EDIT = [
    "é‡èœ", "è‚‰", "è‚‰åŠ å·¥å“", "é­šä»‹", "ç¼¶è©°", "åµãƒ»ä¹³è£½å“", 
    "å¤§è±†è£½å“", "ä¹¾ç‰©ãƒ»ç²‰é¡", "éººé¡", "ãƒ‘ãƒ³", "ç©€ç‰©", "ãã®ä»–"
];

function setupCatalogUI() {
    const fab = document.getElementById('fab-add');
    const overlay = document.getElementById('modal-overlay');
    const btnCancel = document.getElementById('btn-cancel');
    const btnSave = document.getElementById('btn-save');
    const btnDelete = document.getElementById('btn-delete-catalog');
    
    const tabSingle = document.getElementById('tab-single');
    const tabCsv = document.getElementById('tab-csv');
    const singleContainer = document.getElementById('form-single');
    const csvContainer = document.getElementById('form-csv');
    
    const searchInput = document.getElementById('catalog-search');
    const sortSelect = document.getElementById('sort-order');
    const noKanaCheck = document.getElementById('filter-no-kana');
    const nameInput = document.getElementById('input-name');
    
    // â˜…è¿½åŠ : åˆ†é¡ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®åˆ¶å¾¡
    const classSelect = document.getElementById('input-classification');
    if (classSelect) {
        classSelect.addEventListener('change', () => {
            toggleCategorySelect(classSelect.value);
        });
    }

    if (!fab) return;

    // æ–°è¦ç™»éŒ²
    fab.addEventListener('click', () => {
        resetModal('ã‚¢ã‚¤ãƒ†ãƒ ç™»éŒ²');
        document.getElementById('edit-id').value = '';
        document.getElementById('original-name').value = '';
        if(btnDelete) btnDelete.style.display = 'none';
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯é£Ÿæ
        if(classSelect) {
            classSelect.value = 'é£Ÿæ';
            toggleCategorySelect('é£Ÿæ');
        }

        // ã‚«ãƒ†ã‚´ãƒªãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’åˆæœŸåŒ–
        updateCategorySelectEdit('');
        overlay.classList.add('active');
    });

    btnCancel.addEventListener('click', () => {
        overlay.classList.remove('active');
        removeConflictUI();
    });

    if (btnDelete) {
        btnDelete.addEventListener('click', () => {
            const id = document.getElementById('edit-id').value;
            const name = document.getElementById('input-name').value;
            if(id) deleteCatalogItem(id, name);
        });
    }

    if (typeof filterAndRender === 'function') {
        searchInput.addEventListener('input', filterAndRender);
        sortSelect.addEventListener('change', filterAndRender);
        noKanaCheck.addEventListener('change', filterAndRender);
    }

    nameInput.addEventListener('input', (e) => {
        updateReferenceList(e.target.value);
    });

    tabSingle.addEventListener('click', () => switchTab('single'));
    tabCsv.addEventListener('click', () => switchTab('csv'));

    btnSave.addEventListener('click', () => {
        if (singleContainer.style.display !== 'none') {
            saveSingleItem();
        } else {
            saveCsvItem();
        }
    });
}

// --- ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---

// â˜…è¿½åŠ : åˆ†é¡ã«ã‚ˆã£ã¦ã‚«ãƒ†ã‚´ãƒªæ¬„ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
function toggleCategorySelect(classification) {
    const group = document.getElementById('form-group-category'); // HTMLå´ã§IDä»˜ä¸ãŒå¿…è¦
    if (!group) return;

    if (classification === 'èª¿å‘³æ–™') {
        group.style.display = 'none';
    } else {
        group.style.display = 'block';
    }
}

function switchTab(mode) {
    const tabSingle = document.getElementById('tab-single');
    const tabCsv = document.getElementById('tab-csv');
    const singleContainer = document.getElementById('form-single');
    const csvContainer = document.getElementById('form-csv');

    if (mode === 'single') {
        tabSingle.classList.add('active');
        tabCsv.classList.remove('active');
        singleContainer.style.display = 'block';
        csvContainer.style.display = 'none';
    } else {
        tabCsv.classList.add('active');
        tabSingle.classList.remove('active');
        singleContainer.style.display = 'none';
        csvContainer.style.display = 'block';
    }
    removeConflictUI();
    document.getElementById('csv-result-area').style.display = 'none';
}

function resetModal(titleText) {
    document.getElementById('modal-title').textContent = titleText;
    document.getElementById('original-unit').value = '';
    document.getElementById('input-name').value = '';
    document.getElementById('input-kana').value = '';
    document.getElementById('input-unit').value = '';
    document.getElementById('input-csv-text').value = '';
    document.getElementById('reference-area').style.display = 'none';
    document.getElementById('csv-result-area').style.display = 'none';
    switchTab('single');
}

async function openCatalogEditModal(item) {
    resetModal('ã‚¢ã‚¤ãƒ†ãƒ ç·¨é›†');
    const overlay = document.getElementById('modal-overlay');
    const btnDelete = document.getElementById('btn-delete-catalog');
    
    document.getElementById('edit-id').value = item.id;
    document.getElementById('original-unit').value = item.default_unit || '';
    document.getElementById('original-name').value = item.name || ''; 
    
    const classSelect = document.getElementById('input-classification');
    classSelect.value = item.classification;
    // â˜…è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆå®Ÿè¡Œ
    toggleCategorySelect(item.classification);

    document.getElementById('input-name').value = item.name;
    document.getElementById('input-kana').value = item.kana || '';
    document.getElementById('input-unit').value = item.default_unit;

    // ã‚«ãƒ†ã‚´ãƒªãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’ã‚»ãƒƒãƒˆ
    updateCategorySelectEdit(item.category);

    if (btnDelete) {
        btnDelete.style.display = 'none';
        try {
            const res = await fetch(`/api/catalog/usage?id=${item.id}`);
            const usage = await res.json();
            if (usage.recipe_count === 0) {
                btnDelete.style.display = 'inline-block';
            }
        } catch(e) { console.error(e); }
    }

    if (item.name) updateReferenceList(item.name);
    overlay.classList.add('active');
}

function removeConflictUI() {
    const conflictDiv = document.getElementById('conflict-resolution-area');
    if (conflictDiv) conflictDiv.remove();
    const btnSave = document.getElementById('btn-save');
    if (btnSave) {
        btnSave.style.display = 'block';
        btnSave.textContent = 'ä¿å­˜';
    }
}

// å›ºå®šãƒªã‚¹ãƒˆã‚’ä½¿ã£ã¦ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’ä½œã‚‹
function updateCategorySelectEdit(selectedCategory) {
    const select = document.getElementById('select-category');
    
    // æ‰‹å…¥åŠ›æ¬„ã¯å»ƒæ­¢ï¼ˆHTMLã«æ®‹ã£ã¦ã„ã¦ã‚‚éè¡¨ç¤ºã«ã™ã‚‹ï¼‰
    const input = document.getElementById('input-category');
    if(input) input.style.display = 'none'; 

    select.innerHTML = '';
    // å›ºå®šãƒªã‚¹ãƒˆã‚’å±•é–‹
    FIXED_CATEGORIES_EDIT.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        select.appendChild(opt);
    });

    // é¸æŠ
    if (selectedCategory && FIXED_CATEGORIES_EDIT.includes(selectedCategory)) {
        select.value = selectedCategory;
    } else {
        select.value = "ãã®ä»–";
    }
}

function updateReferenceList(name) {
    const refArea = document.getElementById('reference-area');
    const refList = document.getElementById('reference-list');
    if (!name || name.length < 1) {
        refArea.style.display = 'none';
        return;
    }
    if (typeof catalogData === 'undefined') return;
    const term = name.toLowerCase();
    const hits = catalogData.filter(d => {
        const n = d.name.toLowerCase();
        const k = d.kana ? d.kana.toLowerCase() : '';
        return n.includes(term) || k.includes(term) || term.includes(n);
    }).slice(0, 8);
    if (hits.length === 0) {
        refArea.style.display = 'none';
        return;
    }

    refList.innerHTML = '';
    hits.forEach(hit => {
        const chip = document.createElement('div');
        chip.className = 'preset-chip'; 
        chip.innerHTML = `<strong>${hit.name}</strong>`;
        chip.onclick = () => applyReferenceItem(hit);
        refList.appendChild(chip);
    });
    refArea.style.display = 'block';
}

function applyReferenceItem(item) {
    if (!confirm(`ã“ã®é£Ÿæã‚’ã€Œ${item.name}ã€ã¨ã—ã¦è¨­å®šï¼ˆçµ±åˆï¼‰ã—ã¾ã™ã‹ï¼Ÿ`)) return;
    document.getElementById('input-name').value = item.name;
    document.getElementById('input-kana').value = item.kana || '';
    document.getElementById('input-classification').value = item.classification;
    toggleCategorySelect(item.classification); // â˜…è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
    document.getElementById('input-unit').value = item.default_unit || '';
    updateCategorySelectEdit(item.category);
}

async function saveSingleItem() {
    const id = document.getElementById('edit-id').value;
    const name = document.getElementById('input-name').value;
    const originalName = document.getElementById('original-name').value;
    const classification = document.getElementById('input-classification').value;
    
    // â˜…ä¿®æ­£: èª¿å‘³æ–™ãªã‚‰ã‚«ãƒ†ã‚´ãƒªã‚‚ã€Œèª¿å‘³æ–™ã€ã€ãã†ã§ãªã‘ã‚Œã°ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‹ã‚‰å–å¾—
    let category = 'èª¿å‘³æ–™';
    if (classification !== 'èª¿å‘³æ–™') {
        category = document.getElementById('select-category').value;
    }

    if (!name) return alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');

    if (id && name !== originalName) {
        try {
            const res = await fetch(`/api/catalog/usage?id=${id}`);
            const usage = await res.json();
            if (usage.recipe_count > 0) {
                 if (!confirm(`ã“ã®é£Ÿæã¯ ${usage.recipe_count} ä»¶ã®ãƒ¬ã‚·ãƒ”ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚\nåå‰ã‚’å¤‰æ›´ã™ã‚‹ã¨å…¨ã¦ã«å½±éŸ¿ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;
            }
        } catch(e) {}
    }

    const item = {
        id: id ? parseInt(id) : 0,
        classification: classification,
        category: category,
        name: name,
        kana: document.getElementById('input-kana').value,
        default_unit: document.getElementById('input-unit').value,
        force_merge: false
    };

    let method = 'POST';
    if (id) method = 'PUT';

    fetch('/api/catalog', {
        method: method,
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(id ? item : [item])
    })
    .then(async res => {
        const data = await res.json();
        if (res.status === 409 && data.error_code === 'merge_confirmation_required') {
             if (confirm(`${data.message}\n\nã€ŒOKã€ã‚’æŠ¼ã™ã¨ãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆã—ã¾ã™ã€‚`)) {
                item.force_merge = true;
                return fetch('/api/catalog', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(item)
                }).then(r => r.json());
            } else {
                throw new Error('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
            }
        }
        if (!res.ok) throw new Error(data.error || 'Save failed');
        return data;
    })
    .then(() => {
        document.getElementById('modal-overlay').classList.remove('active');
        if (typeof fetchCatalog === 'function') fetchCatalog();
        alert('ä¿å­˜ã—ã¾ã—ãŸ');
    })
    .catch(err => {
        if (err.message !== 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ') alert('ã‚¨ãƒ©ãƒ¼: ' + err.message);
    });
}

function deleteCatalogItem(id, name) {
    if (!confirm(`æœ¬å½“ã«ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
    fetch(`/api/catalog?id=${id}`, { method: 'DELETE' })
    .then(async res => {
        if (!res.ok) throw new Error(await res.text());
        return res.json();
    })
    .then(() => {
        alert('å‰Šé™¤ã—ã¾ã—ãŸ');
        document.getElementById('modal-overlay').classList.remove('active');
        if (typeof fetchCatalog === 'function') fetchCatalog();
    })
    .catch(err => alert('å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ' + err.message));
}

// CSVä¸€æ‹¬ç™»éŒ²
function saveCsvItem() {
    const text = document.getElementById('input-csv-text').value;
    if (!text) return alert('CSVã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    fetch('/import/catalog', {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: text
    })
    .then(async res => {
        if (!res.ok) {
             const data = await res.json().catch(() => ({ error: res.statusText }));
             throw new Error(data.error || res.statusText);
        }
        return res.json();
    })
    .then(result => {
        const area = document.getElementById('csv-result-area');
        area.style.display = 'block';
        area.innerHTML = `
            <p>æˆåŠŸ: <strong>${result.added}</strong> / é‡è¤‡: <strong>${result.skipped}</strong></p>
        `;
        if (result.errors && result.errors.length > 0) {
            area.innerHTML += `<div style="color:red;font-size:11px;margin-top:5px;">${result.errors.join('<br>')}</div>`;
        }
        if (typeof fetchCatalog === 'function') fetchCatalog();
        document.getElementById('input-csv-text').value = '';
    })
    .catch(err => alert('ã‚¨ãƒ©ãƒ¼: ' + err.message));
}

----- C:\Users\wasab\OneDrive\ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—\kimichan2\static\js\catalog_list.js -----
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let catalogData = [];

// â˜…ä¿®æ­£: å›ºå®šã‚«ãƒ†ã‚´ãƒªãƒªã‚¹ãƒˆã‹ã‚‰ã€Œèª¿å‘³æ–™ã€ã‚’å‰Šé™¤
const FIXED_CATEGORIES = [
    "é‡èœ", "è‚‰", "è‚‰åŠ å·¥å“", "é­šä»‹", "ç¼¶è©°", "åµãƒ»ä¹³è£½å“", 
    "å¤§è±†è£½å“", "ä¹¾ç‰©ãƒ»ç²‰é¡", "éººé¡", "ãƒ‘ãƒ³", "ç©€ç‰©", "ãã®ä»–"
];

function initCatalog() {
    fetchCatalog();
    if (typeof setupCatalogUI === 'function') {
        setupCatalogUI();
    }
}

// ãƒ‡ãƒ¼ã‚¿å–å¾—
function fetchCatalog() {
    fetch('/api/catalog')
        .then(res => res.json())
        .then(data => {
            catalogData = data;
            setupCategoryFilter(); 
            filterAndRender();     
        })
        .catch(err => console.error('Fetch error:', err));
}

function setupCategoryFilter() {
    const select = document.getElementById('catalog-category-filter');
    const classSelect = document.getElementById('catalog-classification-filter'); // â˜…è¿½åŠ 

    if (!select) return;

    select.innerHTML = '<option value="ã™ã¹ã¦">ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒª</option>';

    FIXED_CATEGORIES.forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat;
        opt.textContent = cat;
        select.appendChild(opt);
    });
    
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    select.addEventListener('change', () => {
        filterAndRender();
    });

    // â˜…è¿½åŠ : åˆ†é¡ãƒ•ã‚£ãƒ«ã‚¿ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    if (classSelect) {
        classSelect.addEventListener('change', () => {
            // åˆ†é¡ã§ã€Œèª¿å‘³æ–™ã€ã‚’é¸ã‚“ã ã‚‰ã€ã‚«ãƒ†ã‚´ãƒªã¯æ„å‘³ã‚’ãªã•ãªã„ã®ã§ãƒªã‚»ãƒƒãƒˆã™ã‚‹ç­‰ã®æŒ™å‹•ã‚‚å¯èƒ½ã ãŒ
            // ã“ã“ã§ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ãƒ•ã‚£ãƒ«ã‚¿å®Ÿè¡Œã®ã¿è¡Œã†
            filterAndRender();
        });
    }
}

// ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã¨ã‚½ãƒ¼ãƒˆã®å®Ÿè¡Œ
function filterAndRender() {
    const term = document.getElementById('catalog-search').value.toLowerCase();
    const sortOrder = document.getElementById('sort-order').value;
    const filterNoKana = document.getElementById('filter-no-kana').checked;
    
    // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®å€¤ã‚’å–å¾—
    const selectedCategory = document.getElementById('catalog-category-filter').value;
    const selectedClassification = document.getElementById('catalog-classification-filter').value; // â˜…è¿½åŠ 
    
    let displayData = [...catalogData];

    // ã‚½ãƒ¼ãƒˆå‡¦ç†
    if (sortOrder === 'id_desc') {
        displayData.sort((a, b) => b.id - a.id);
    } else {
        displayData.sort((a, b) => {
            const ka = a.kana || a.name;
            const kb = b.kana || b.name;
            return ka.localeCompare(kb, 'ja');
        });
    }

    // ãƒ•ã‚£ãƒ«ã‚¿å‡¦ç†
    const filtered = displayData.filter(item => {
        // â˜…è¿½åŠ : åˆ†é¡ãƒ•ã‚£ãƒ«ã‚¿
        let classMatch = true;
        if (selectedClassification !== 'ã™ã¹ã¦') {
            classMatch = (item.classification === selectedClassification);
        }

        // ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿
        let catMatch = true;
        if (selectedCategory !== 'ã™ã¹ã¦') {
            // ã‚¢ã‚¤ãƒ†ãƒ ã®ã‚«ãƒ†ã‚´ãƒªãŒç©ºãªã‚‰ã€Œãã®ä»–ã€
            const itemCat = item.category || 'ãã®ä»–';
            catMatch = (itemCat === selectedCategory);
        }

        // æ¤œç´¢èªå¥
        let termMatch = true;
        if (term) {
            termMatch = 
                item.name.toLowerCase().includes(term) || 
                (item.kana && item.kana.toLowerCase().includes(term));
        }

        // ã‚ˆã¿ãŒãªæœªç™»éŒ²
        let noKanaMatch = true;
        if (filterNoKana) {
            noKanaMatch = !item.kana || item.kana.trim() === '';
        }

        return classMatch && catMatch && termMatch && noKanaMatch;
    });

    renderCatalog(filtered);
}

// ä¸€è¦§ã®æç”»
function renderCatalog(items) {
    const listEl = document.getElementById('catalog-list');
    if (!listEl) return;
    
    listEl.innerHTML = '';
    if (items.length === 0) {
        listEl.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">è©²å½“ãªã—</div>';
        return;
    }

    items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'card';
        div.onclick = () => {
            if (typeof openCatalogEditModal === 'function') {
                openCatalogEditModal(item);
            }
        };
        
        // è¡¨ç¤ºç”¨ã‚¿ã‚°: åˆ†é¡ãŒèª¿å‘³æ–™ãªã‚‰ã€Œèª¿å‘³æ–™ã€ã®ã¿è¡¨ç¤ºã€é£Ÿæãªã‚‰ã€Œé£Ÿæ / ã‚«ãƒ†ã‚´ãƒªã€
        let tagText = "";
        if (item.classification === 'èª¿å‘³æ–™') {
            tagText = "èª¿å‘³æ–™";
        } else {
            tagText = `${item.classification} / ${item.category || 'æœªåˆ†é¡'}`;
        }
        
        const kanaHtml = item.kana 
            ? `<span style="font-size:11px; color:#999; font-weight:normal; margin-left:5px;">(${item.kana})</span>` 
            : `<span style="font-size:10px; color:#e74c3c; background:#ffebee; padding:1px 4px; border-radius:4px; margin-left:5px;">æœªç™»éŒ²</span>`;

        div.innerHTML = `
            <div class="card-content">
                <span class="tag">${tagText}</span>
                <div class="item-name">
                    ${item.name}
                    ${kanaHtml}
                </div>
            </div>
            <div class="item-unit">${item.default_unit || ''}</div>
        `;
        listEl.appendChild(div);
    });
}

----- C:\Users\wasab\OneDrive\ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—\kimichan2\static\js\catalog.js -----
let catalogData = [];
let currentCategory = 'ã™ã¹ã¦';

function initCatalog() {
    fetchCatalog();
    setupCatalogUI();
}

function fetchCatalog() {
    fetch('/api/catalog')
        .then(res => res.json())
        .then(data => {
            catalogData = data;
            renderCategoryButtons(catalogData);
            filterAndRender();
        })
        .catch(err => console.error('Fetch error:', err));
}

function renderCategoryButtons(items) {
    const container = document.getElementById('category-filters');
    if (!container) return;

    const categories = new Set(['ã™ã¹ã¦']);
    items.forEach(item => {
        if (item.category) categories.add(item.category);
        else if (item.classification === 'èª¿å‘³æ–™') categories.add('èª¿å‘³æ–™');
        else categories.add('æœªåˆ†é¡');
    });

    container.innerHTML = '';
    categories.forEach(cat => {
        const displayCat = cat === 'æœªåˆ†é¡' ? 'ãã®ä»–' : cat;
        const btn = document.createElement('div');
        btn.className = `cat-chip ${cat === currentCategory ? 'active' : ''}`;
        btn.textContent = displayCat;
        btn.onclick = () => {
            currentCategory = cat;
            document.querySelectorAll('.cat-chip').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            filterAndRender();
        };
        container.appendChild(btn);
    });
}

function filterAndRender() {
    const term = document.getElementById('catalog-search').value.toLowerCase();
    const sortOrder = document.getElementById('sort-order').value;
    const filterNoKana = document.getElementById('filter-no-kana').checked;
    
    let displayData = [...catalogData];
    
    if (sortOrder === 'id_desc') {
        displayData.sort((a, b) => b.id - a.id);
    } else {
        displayData.sort((a, b) => {
            const ka = a.kana || a.name;
            const kb = b.kana || b.name;
            return ka.localeCompare(kb, 'ja');
        });
    }

    const filtered = displayData.filter(item => {
        let catMatch = true;
        if (currentCategory !== 'ã™ã¹ã¦') {
            const itemCat = item.category || (item.classification === 'èª¿å‘³æ–™' ? 'èª¿å‘³æ–™' : 'æœªåˆ†é¡');
            catMatch = (itemCat === currentCategory);
        }

        let termMatch = true;
        if (term) {
            termMatch = 
                item.name.toLowerCase().includes(term) || 
                (item.kana && item.kana.toLowerCase().includes(term)) ||
                (item.category && item.category.toLowerCase().includes(term));
        }

        let noKanaMatch = true;
        if (filterNoKana) {
            noKanaMatch = !item.kana || item.kana.trim() === '';
        }

        return catMatch && termMatch && noKanaMatch;
    });

    renderCatalog(filtered);
}

function renderCatalog(items) {
    const listEl = document.getElementById('catalog-list');
    if (!listEl) return;
    
    listEl.innerHTML = '';
    
    if (items.length === 0) {
        listEl.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">è©²å½“ãªã—</div>';
        return;
    }

    items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'card';
        div.onclick = () => openCatalogEditModal(item);
        
        const tagText = `${item.classification} / ${item.category || (item.classification === 'èª¿å‘³æ–™' ? 'ã‚¹ãƒ‘ã‚¤ã‚¹ç­‰' : 'æœªåˆ†é¡')}`;
        
        const kanaHtml = item.kana 
            ? `<span style="font-size:11px; color:#999; font-weight:normal; margin-left:5px;">(${item.kana})</span>` 
            : `<span style="font-size:10px; color:#e74c3c; background:#ffebee; padding:1px 4px; border-radius:4px; margin-left:5px;">æœªç™»éŒ²</span>`;

        div.innerHTML = `
            <div class="card-content">
                <span class="tag">${tagText}</span>
                <div class="item-name">
                    ${item.name}
                    ${kanaHtml}
                </div>
            </div>
            <div class="item-unit">${item.default_unit || ''}</div>
        `;
        listEl.appendChild(div);
    });
}

function openCatalogEditModal(item) {
    const overlay = document.getElementById('modal-overlay');
    const title = document.getElementById('modal-title');
    const tabSingle = document.getElementById('tab-single');
    const tabCsv = document.getElementById('tab-csv');
    const singleContainer = document.getElementById('form-single');
    const csvContainer = document.getElementById('form-csv');
    
    tabSingle.classList.add('active');
    tabCsv.classList.remove('active');
    singleContainer.style.display = 'block';
    csvContainer.style.display = 'none';
    document.getElementById('csv-result-area').style.display = 'none';
    document.getElementById('reference-area').style.display = 'none'; 
    
    title.textContent = 'ã‚¢ã‚¤ãƒ†ãƒ ç·¨é›†';

    document.getElementById('edit-id').value = item.id;
    document.getElementById('original-unit').value = item.default_unit || '';
    document.getElementById('original-name').value = item.name || ''; 

    document.getElementById('input-classification').value = item.classification;
    
    updateCategorySelect(item.category);

    document.getElementById('input-name').value = item.name;
    document.getElementById('input-kana').value = item.kana || '';
    document.getElementById('input-unit').value = item.default_unit;

    if (item.name) {
        updateReferenceList(item.name);
    }

    overlay.classList.add('active');
}

function updateCategorySelect(selectedCategory) {
    const select = document.getElementById('select-category');
    const input = document.getElementById('input-category');
    
    const categories = new Set();
    catalogData.forEach(d => {
        if(d.category) categories.add(d.category);
    });

    select.innerHTML = '<option value="">(æ–°è¦å…¥åŠ›)</option>';
    categories.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        select.appendChild(opt);
    });

    if (categories.has(selectedCategory)) {
        select.value = selectedCategory;
        input.style.display = 'none';
        input.value = selectedCategory;
    } else {
        select.value = "";
        input.style.display = 'block';
        input.value = selectedCategory || "";
    }

    select.onchange = () => {
        if (select.value === "") {
            input.style.display = 'block';
            input.value = "";
        } else {
            input.style.display = 'none';
            input.value = select.value;
        }
    };
}

function updateReferenceList(name) {
    const refArea = document.getElementById('reference-area');
    const refList = document.getElementById('reference-list');
    
    if (!name || name.length < 1) {
        refArea.style.display = 'none';
        return;
    }

    const term = name.toLowerCase();
    
    // åŒæ–¹å‘ã®éƒ¨åˆ†ä¸€è‡´æ¤œç´¢ (DBãŒå…¥åŠ›ã‚’å«ã‚€ OR å…¥åŠ›ãŒDBã‚’å«ã‚€)
    const hits = catalogData.filter(d => {
        const targetName = d.name.toLowerCase();
        const targetKana = d.kana ? d.kana.toLowerCase() : '';

        // DBã®åå‰ãŒã€å…¥åŠ›æ–‡å­—ã‚’å«ã‚“ã§ã„ã‚‹
        const dbContainsInput = targetName.includes(term) || (targetKana && targetKana.includes(term));
        
        // å…¥åŠ›æ–‡å­—ãŒã€DBã®åå‰ã‚’å«ã‚“ã§ã„ã‚‹
        const inputContainsDb = term.includes(targetName) || (targetKana && term.includes(targetKana));

        return dbContainsInput || inputContainsDb;
    }).slice(0, 8); 

    if (hits.length === 0) {
        refArea.style.display = 'none';
        return;
    }

    refList.innerHTML = '';
    hits.forEach(hit => {
        const chip = document.createElement('div');
        chip.style.cssText = 'background:white; border:1px solid #ccc; padding:4px 8px; border-radius:12px; font-size:11px; cursor:pointer; display:flex; align-items:center; gap:5px;';
        chip.innerHTML = `
            <span style="color:#888;">[${hit.classification}/${hit.category||'-'}]</span>
            <strong>${hit.name}</strong>
        `;
        chip.onclick = () => applyReferenceItem(hit);
        refList.appendChild(chip);
    });
    refArea.style.display = 'block';
}

function applyReferenceItem(item) {
    if (!confirm(`ã“ã®é£Ÿæã‚’ã€Œ${item.name}ã€ã¨ã—ã¦è¨­å®šï¼ˆçµ±åˆï¼‰ã—ã¾ã™ã‹ï¼Ÿ\n\nâ€»ä¿å­˜æ™‚ã«çµ±åˆã®ç¢ºèªãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚`)) return;

    document.getElementById('input-name').value = item.name;
    document.getElementById('input-kana').value = item.kana || '';
    document.getElementById('input-classification').value = item.classification;
    
    updateCategorySelect(item.category);
    document.getElementById('input-unit').value = item.default_unit || '';
}

function setupCatalogUI() {
    const fab = document.getElementById('fab-add');
    const overlay = document.getElementById('modal-overlay');
    const btnCancel = document.getElementById('btn-cancel');
    const btnSave = document.getElementById('btn-save');
    const tabSingle = document.getElementById('tab-single');
    const tabCsv = document.getElementById('tab-csv');
    const singleContainer = document.getElementById('form-single');
    const csvContainer = document.getElementById('form-csv');
    const searchInput = document.getElementById('catalog-search');

    const sortSelect = document.getElementById('sort-order');
    const noKanaCheck = document.getElementById('filter-no-kana');
    const nameInput = document.getElementById('input-name');

    const scrollLeft = document.getElementById('scroll-left');
    const scrollRight = document.getElementById('scroll-right');
    const scrollContainer = document.getElementById('category-filters');

    if(scrollLeft && scrollContainer) {
        scrollLeft.onclick = () => scrollContainer.scrollBy({ left: -100, behavior: 'smooth' });
        scrollRight.onclick = () => scrollContainer.scrollBy({ left: 100, behavior: 'smooth' });
    }

    if (!fab) return;

    fab.addEventListener('click', () => {
        document.getElementById('modal-title').textContent = 'ã‚¢ã‚¤ãƒ†ãƒ ç™»éŒ²';
        document.getElementById('edit-id').value = '';
        document.getElementById('original-unit').value = '';
        document.getElementById('original-name').value = '';
        document.getElementById('input-name').value = '';
        document.getElementById('input-kana').value = '';
        document.getElementById('input-unit').value = '';
        document.getElementById('input-csv-text').value = '';
        document.getElementById('reference-area').style.display = 'none';
        
        updateCategorySelect(currentCategory !== 'ã™ã¹ã¦' && currentCategory !== 'æœªåˆ†é¡' ? currentCategory : '');

        document.getElementById('csv-result-area').style.display = 'none';
        
        tabCsv.classList.remove('active');
        tabSingle.classList.add('active');
        singleContainer.style.display = 'block';
        csvContainer.style.display = 'none';
        
        overlay.classList.add('active');
    });

    btnCancel.addEventListener('click', () => {
        overlay.classList.remove('active');
        removeConflictUI();
    });

    searchInput.addEventListener('input', filterAndRender);
    sortSelect.addEventListener('change', filterAndRender);
    noKanaCheck.addEventListener('change', filterAndRender);

    nameInput.addEventListener('input', (e) => {
        updateReferenceList(e.target.value);
    });

    tabSingle.addEventListener('click', () => {
        tabSingle.classList.add('active');
        tabCsv.classList.remove('active');
        singleContainer.style.display = 'block';
        csvContainer.style.display = 'none';
        removeConflictUI();
        document.getElementById('csv-result-area').style.display = 'none';
    });

    tabCsv.addEventListener('click', () => {
        tabCsv.classList.add('active');
        tabSingle.classList.remove('active');
        singleContainer.style.display = 'none';
        csvContainer.style.display = 'block';
        removeConflictUI();
    });

    btnSave.addEventListener('click', () => {
        if (singleContainer.style.display !== 'none') {
            saveSingleItem();
        } else {
            saveCsvItem();
        }
    });
}

function removeConflictUI() {
    const conflictDiv = document.getElementById('conflict-resolution-area');
    if (conflictDiv) conflictDiv.remove();
    const btnSave = document.getElementById('btn-save');
    if (btnSave) {
        btnSave.style.display = 'block';
        btnSave.textContent = 'ä¿å­˜';
    }
}

async function saveSingleItem() {
    const id = document.getElementById('edit-id').value;
    const name = document.getElementById('input-name').value;
    const originalUnit = document.getElementById('original-unit').value;
    const originalName = document.getElementById('original-name').value;
    const newUnit = document.getElementById('input-unit').value;

    if (!name) return alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');

    // åå‰ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã€å½±éŸ¿ç¯„å›²ï¼ˆãƒ¬ã‚·ãƒ”ï¼‰ã‚’ç¢ºèªã™ã‚‹
    if (id && name !== originalName) {
        try {
            const usageRes = await fetch(`/api/catalog/usage?id=${id}`);
            const usage = await usageRes.json();
            
            if (usage.recipe_count > 0) {
                const examples = usage.recipe_names.join('ã€') + (usage.recipe_count > 3 ? '...' : '');
                const msg = `âš ï¸ ã“ã®é£Ÿæã¯ ${usage.recipe_count} ä»¶ã®ãƒ¬ã‚·ãƒ”ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚\n` +
                            `ï¼ˆä½¿ç”¨ä¾‹: ${examples}ï¼‰\n\n` +
                            `åå‰ã‚’ã€Œ${originalName}ã€ã‹ã‚‰ã€Œ${name}ã€ã«å¤‰æ›´ã™ã‚‹ã¨ã€ãã‚Œã‚‰ã®ãƒ¬ã‚·ãƒ”ã®è¡¨ç¤ºã‚‚å…¨ã¦å¤‰ã‚ã‚Šã¾ã™ã€‚\n\n` +
                            `å¤‰æ›´ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`;
                
                if (!confirm(msg)) return;
            }
        } catch(e) {
            console.error('Usage check failed', e);
        }
    }

    if (id && originalUnit !== newUnit) {
        if (!confirm(`å˜ä½ãŒã€Œ${originalUnit || '(ãªã—)'}ã€ã‹ã‚‰ã€Œ${newUnit || '(ãªã—)'}ã€ã«å¤‰æ›´ã•ã‚Œã¦ã„ã¾ã™ã€‚\nåœ¨åº«ã®æ•°å€¤ï¼ˆä¾‹: 3å€‹ â†’ 3${newUnit}ï¼‰ã®æ„å‘³ãŒå¤‰ã‚ã£ã¦ã—ã¾ã„ã¾ã™ãŒã€ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
            return;
        }
    }

    const item = {
        id: id ? parseInt(id) : 0,
        classification: document.getElementById('input-classification').value,
        category: document.getElementById('input-category').value,
        name: name,
        kana: document.getElementById('input-kana').value,
        default_unit: newUnit,
        force_merge: false
    };

    let method = 'POST';
    if (id) method = 'PUT';

    fetch('/api/catalog', {
        method: method,
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(id ? item : [item])
    })
    .then(async res => {
        const data = await res.json();
        
        if (res.status === 409 && data.error_code === 'merge_confirmation_required') {
            if (confirm(`${data.message}\n\nã€ŒOKã€ã‚’æŠ¼ã™ã¨ãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆã—ã¾ã™ï¼ˆå…ƒã®ãƒ‡ãƒ¼ã‚¿ã¯å‰Šé™¤ã•ã‚Œã€é–¢é€£ãƒ‡ãƒ¼ã‚¿ã¯ç§»å‹•ã—ã¾ã™ï¼‰ã€‚`)) {
                item.force_merge = true;
                return fetch('/api/catalog', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(item)
                }).then(r => r.json());
            } else {
                throw new Error('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
            }
        }

        if (!res.ok) throw new Error(data.error || 'Save failed');
        return data;
    })
    .then(() => {
        document.getElementById('modal-overlay').classList.remove('active');
        fetchCatalog();
        alert('ä¿å­˜ã—ã¾ã—ãŸ');
    })
    .catch(err => {
        if (err.message !== 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ') alert('ã‚¨ãƒ©ãƒ¼: ' + err.message);
    });
}

function saveCsvItem() {
    const text = document.getElementById('input-csv-text').value;
    const resultArea = document.getElementById('csv-result-area');
    
    if (!text) return alert('CSVã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');

    fetch('/import/catalog', {
        method: 'POST',
        headers: {
            'Content-Type': 'text/plain'
        },
        body: text
    })
    .then(async res => {
        if (!res.ok) {
             const errorData = await res.json().catch(() => ({ error: `ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ${res.status}` }));
             throw new Error(errorData.error || `ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ${res.status}`);
        }
        return res.json();
    })
    .then(result => {
        resultArea.style.display = 'block';
        resultArea.innerHTML = `
            <h3>å‡¦ç†çµæœ</h3>
            <p>ç™»éŒ²æˆåŠŸ: <strong>${result.added}</strong> ä»¶</p>
            <p>é‡è¤‡ã‚¹ã‚­ãƒƒãƒ—: <strong>${result.skipped}</strong> ä»¶</p>
        `;

        if (result.errors && result.errors.length > 0) {
            resultArea.innerHTML += `
                <div style="color: red; margin-top:10px; border: 1px solid red; padding: 5px; border-radius: 4px;">
                    <h4>ã‚¨ãƒ©ãƒ¼è©³ç´°:</h4>
                    <ul>${result.errors.map(e => `<li>${e}</li>`).join('')}</ul>
                </div>
            `;
        }

        fetchCatalog();
        document.getElementById('input-csv-text').value = '';
    })
    .catch(err => alert('ã‚¨ãƒ©ãƒ¼: ' + err.message));
}

----- C:\Users\wasab\OneDrive\ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—\kimichan2\static\js\inventory_edit.js -----
var catalogListForInv = [];
var currentSelectorCategory = 'ã™ã¹ã¦';
// â˜…ã€Œãƒ‰ã‚¢ãƒã‚±ãƒƒãƒˆã€ã‚’è¿½åŠ 
var FIXED_LOCATIONS_EDIT = ["å†·è”µå®¤", "ãƒãƒ«ãƒ‰", "å†·å‡å®¤", "é‡èœå®¤", "ãƒ‰ã‚¢ãƒã‚±ãƒƒãƒˆ", "ãã®ä»–"];

function initInventoryEdit() {
    setupLocationSelects();
    fetchCatalogForInv();
    setupEditEventListeners();
}

function fetchCatalogForInv() {
    fetch('/api/catalog')
        .then(res => res.json())
        .then(data => {
            // â˜…ä¿®æ­£: ãƒ•ã‚£ãƒ«ã‚¿ãªã—ï¼ˆèª¿å‘³æ–™ã‚‚å«ã‚€ï¼‰
            let filteredData = data;
            filteredData.sort((a, b) => {
                const ka = a.kana || a.name;
                const kb = b.kana || b.name;
                return ka.localeCompare(kb, 'ja');
            });
            catalogListForInv = filteredData;
        });
}

function setupLocationSelects() {
    const ids = ['inv-location', 'inv-edit-location'];
    ids.forEach(id => {
        const select = document.getElementById(id);
        if (!select) return;
        const current = select.value;
        select.innerHTML = '';
        FIXED_LOCATIONS_EDIT.forEach(loc => {
            const opt = document.createElement('option');
            opt.value = loc;
            opt.textContent = loc;
            select.appendChild(opt);
        });
        if (current && FIXED_LOCATIONS_EDIT.includes(current)) select.value = current;
        else select.value = FIXED_LOCATIONS_EDIT[0];
    });
}

function setupEditEventListeners() {
    const fab = document.getElementById('fab-add-inventory');
    const overlay = document.getElementById('modal-inventory');
    const editOverlay = document.getElementById('modal-inv-edit');
    const btnCancel = document.getElementById('btn-inv-cancel');
    const btnSave = document.getElementById('btn-inv-save');
    const btnEditCancel = document.getElementById('btn-inv-edit-cancel');
    const btnUpdate = document.getElementById('btn-inv-update');
    const btnDelete = document.getElementById('btn-inv-delete');

    if (fab) {
        fab.onclick = () => {
            document.getElementById('inv-detail-toggle').checked = false;
            document.getElementById('inv-detail-area').style.display = 'none';
            document.getElementById('inv-amount').value = 1; 
            
            const idInput = document.getElementById('inv-select-catalog-id');
            if(idInput) idInput.value = "";
            
            const btn = document.getElementById('btn-open-selector');
            if(btn) {
                btn.textContent = "é£Ÿæã‚’é¸æŠã—ã¦ãã ã•ã„...";
                btn.style.fontWeight = 'normal';
                btn.style.color = '#333';
            }
            setupLocationSelects();
            overlay.classList.add('active');
        };
    }

    if (btnCancel) btnCancel.onclick = () => overlay.classList.remove('active');
    if (btnEditCancel) btnEditCancel.onclick = () => editOverlay.classList.remove('active');

    if (btnSave) {
        btnSave.onclick = () => {
            const idInput = document.getElementById('inv-select-catalog-id');
            const val = idInput ? idInput.value : "";
            
            if (!val) {
                alert('é£Ÿæã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            const catalogId = parseInt(val, 10);
            if (isNaN(catalogId)) {
                alert('IDã‚¨ãƒ©ãƒ¼');
                return;
            }

            const location = document.getElementById('inv-location').value;
            const unit = document.getElementById('inv-unit').value;
            let amount = -1;
            let date = "";
            
            if (document.getElementById('inv-detail-toggle').checked) {
                amount = parseFloat(document.getElementById('inv-amount').value) || 1;
                date = document.getElementById('inv-date').value;
            }
            let expirationDate = date ? date + "T00:00:00Z" : "";

            const data = {
                catalog_id: catalogId,
                amount: amount,
                unit: unit,
                expiration_date: expirationDate,
                location: location
            };

            // åœ¨åº«ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ä¿å­˜
            fetch('/api/ingredients', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(async res => {
                if (!res.ok) throw new Error(await res.text());
                overlay.classList.remove('active');
                if(window.fetchInventory) window.fetchInventory();
            })
            .catch(err => alert('ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + err));
        };
    }

    if (btnUpdate) {
        btnUpdate.onclick = () => {
            const id = document.getElementById('inv-edit-id').value;
            const amount = parseFloat(document.getElementById('inv-edit-amount').value);
            const date = document.getElementById('inv-edit-date').value;
            const location = document.getElementById('inv-edit-location').value;

            const data = {
                id: parseInt(id),
                amount: amount,
                expiration_date: date ? date + "T00:00:00Z" : "",
                location: location
            };

            fetch('/api/ingredients', {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            }).then(async res => {
                if(!res.ok) throw new Error(await res.text());
                editOverlay.classList.remove('active');
                if(window.fetchInventory) window.fetchInventory();
            }).catch(err => alert('æ›´æ–°ã‚¨ãƒ©ãƒ¼: ' + err));
        };
    }

    if (btnDelete) {
        btnDelete.onclick = () => {
            if(!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            const id = document.getElementById('inv-edit-id').value;
            fetch(`/api/ingredients?id=${id}`, { method: 'DELETE' })
            .then(async res => {
                if(!res.ok) throw new Error(await res.text());
                editOverlay.classList.remove('active');
                if(window.fetchInventory) window.fetchInventory();
            }).catch(err => alert('å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ' + err));
        };
    }

    setupItemSelector();
}

function setupItemSelector() {
    const btnOpen = document.getElementById('btn-open-selector');
    const modal = document.getElementById('modal-item-selector');
    const btnClose = document.getElementById('btn-selector-close');
    const searchInput = document.getElementById('selector-search');

    if(!btnOpen) return;

    btnOpen.onclick = () => {
        modal.classList.add('active');
        renderSelectorCategories();
        renderSelectorList();
    };
    if(btnClose) btnClose.onclick = () => modal.classList.remove('active');
    if(searchInput) searchInput.oninput = () => renderSelectorList();
}

function renderSelectorCategories() {
    const container = document.getElementById('selector-tabs');
    if (!container) return;
    container.innerHTML = '';
    const categories = new Set(['ã™ã¹ã¦']);
    catalogListForInv.forEach(item => {
        if(item.category) categories.add(item.category);
        else categories.add('æœªåˆ†é¡');
    });
    categories.forEach(cat => {
        const div = document.createElement('div');
        div.className = `selector-tab ${cat === currentSelectorCategory ? 'active' : ''}`;
        div.textContent = cat;
        div.onclick = () => {
            currentSelectorCategory = cat;
            renderSelectorCategories();
            renderSelectorList();
        };
        container.appendChild(div);
    });
}

function renderSelectorList() {
    const container = document.getElementById('selector-list');
    const term = document.getElementById('selector-search').value.toLowerCase();
    container.innerHTML = '';

    const filtered = catalogListForInv.filter(item => {
        let catMatch = (currentSelectorCategory === 'ã™ã¹ã¦') || (item.category === currentSelectorCategory);
        let termMatch = true;
        if(term) {
            termMatch = item.name.toLowerCase().includes(term) || (item.kana && item.kana.toLowerCase().includes(term));
        }
        return catMatch && termMatch;
    });

    if (filtered.length === 0) {
        container.innerHTML = '<div style="padding:10px; color:#999;">è©²å½“ãªã—</div>';
        return;
    }

    filtered.forEach(item => {
        const div = document.createElement('div');
        div.className = 'selector-item';
        // ã‚¢ã‚¤ã‚³ãƒ³åˆ†ã‘
        const icon = item.classification === 'èª¿å‘³æ–™' ? 'ğŸ§‚' : 'ğŸ¥¬';
        div.innerHTML = `${icon} ${item.name} <span class="selector-item-kana">${item.kana || ''}</span>`;
        
        div.onclick = () => {
            document.getElementById('inv-select-catalog-id').value = item.id;
            const btn = document.getElementById('btn-open-selector');
            btn.textContent = item.name;
            btn.style.fontWeight = 'bold';
            btn.style.color = '#000';
            document.getElementById('inv-unit').value = item.default_unit || '';
            document.getElementById('modal-item-selector').classList.remove('active');
        };
        container.appendChild(div);
    });
}

window.openInventoryEdit = function(item) {
    const modal = document.getElementById('modal-inv-edit');
    if (!modal) return;
    document.getElementById('inv-edit-title').textContent = item.name;
    document.getElementById('inv-edit-id').value = item.id;
    document.getElementById('inv-edit-amount').value = item.amount;
    document.getElementById('inv-edit-unit').textContent = item.unit;
    document.getElementById('inv-edit-date').value = item.expiration_date.split('T')[0];

    setupLocationSelects();
    const locSelect = document.getElementById('inv-edit-location');
    let loc = item.location;
    if (!FIXED_LOCATIONS_EDIT.includes(loc)) loc = 'ãã®ä»–';
    locSelect.value = loc;
    
    modal.classList.add('active');
};

window.addAmount = function(val) {
    const input = document.getElementById('inv-amount');
    let current = parseFloat(input.value) || 0;
    let nextVal = current + val;
    if (nextVal < 0) nextVal = 0;
    input.value = Math.round(nextVal * 10) / 10;
};

----- C:\Users\wasab\OneDrive\ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—\kimichan2\static\js\inventory_list.js -----
var inventoryData = [];
// â˜…ãƒ‰ã‚¢ãƒã‚±ãƒƒãƒˆè¿½åŠ 
var FIXED_LOCATIONS = ["å†·è”µå®¤", "ãƒãƒ«ãƒ‰", "å†·å‡å®¤", "é‡èœå®¤", "ãƒ‰ã‚¢ãƒã‚±ãƒƒãƒˆ", "ãã®ä»–"];

function initInventory() {
    if (window.fetchFridgePhotos) window.fetchFridgePhotos();
    fetchInventory();
    if (typeof initInventoryEdit === 'function') initInventoryEdit();
    if (typeof setupPhotoUI === 'function') setupPhotoUI();
}

window.fetchInventory = function() {
    return fetch('/api/ingredients')
        .then(res => res.json())
        .then(data => {
            inventoryData = data;
            const searchInput = document.getElementById('inventory-search');
            if (searchInput && searchInput.value) {
                const term = searchInput.value.toLowerCase().trim();
                const filtered = inventoryData.filter(item => 
                    item.name.toLowerCase().includes(term) || 
                    (item.kana && item.kana.toLowerCase().includes(term))
                );
                renderInventory(filtered);
            } else {
                renderInventory(inventoryData);
            }
        })
        .catch(err => console.error(err));
};

function renderInventory(items) {
    const listEl = document.getElementById('inventory-list');
    if (!listEl) return;
    listEl.innerHTML = '';

    const itemsByLoc = {};
    FIXED_LOCATIONS.forEach(loc => itemsByLoc[loc] = []);
    
    items.forEach(item => {
        let loc = item.location || 'ãã®ä»–';
        if (!FIXED_LOCATIONS.includes(loc)) loc = 'ãã®ä»–';
        itemsByLoc[loc].push(item);
    });

    FIXED_LOCATIONS.forEach(loc => {
        const locItems = itemsByLoc[loc] || [];
        const header = document.createElement('div');
        header.className = 'loc-header-badge';
        header.textContent = loc;
        listEl.appendChild(header);

        if (typeof window.renderLocationPhotos === 'function') {
            const photoStrip = window.renderLocationPhotos(loc);
            listEl.appendChild(photoStrip);
        }

        if (locItems.length === 0) {
            const emptyMsg = document.createElement('div');
            emptyMsg.className = 'inventory-empty-msg';
            emptyMsg.textContent = 'ï¼ˆåœ¨åº«ãªã—ï¼‰';
            listEl.appendChild(emptyMsg);
        } else {
            locItems.forEach(item => {
                const div = document.createElement('div');
                div.className = 'card';
                div.onclick = (e) => {
                    if (!e.target.closest('.recipe-badge-btn')) {
                        if (typeof openInventoryEdit === 'function') openInventoryEdit(item);
                    }
                };
            
                const today = new Date();
                today.setHours(0,0,0,0);
                const expDate = new Date(item.expiration_date);
                expDate.setHours(0,0,0,0);
                const diffTime = expDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

                let dateClass = 'status-normal';
                let dateText = item.expiration_date.split('T')[0];
                if (diffDays < 0) { dateClass = 'status-expired'; dateText += ' (æœŸé™åˆ‡ã‚Œ)'; }
                else if (diffDays <= 2) { dateClass = 'status-soon'; dateText += (diffDays===0?' (ä»Šæ—¥)':` (ã‚ã¨${diffDays}æ—¥)`); }

                let badgeHtml = '';
                if (item.recipe_count > 0) {
                    badgeHtml = `<button class="recipe-badge-btn" onclick="goToFilteredRecipes(${item.catalog_id}, '${item.name}')">ğŸ³ ${item.recipe_count}</button>`;
                }
                let thumbHtml = item.image_path ? `<img src="/images/${item.image_path}" class="list-thumbnail">` : '';
                let amountDisplay = item.amount === -1 ? '<span class="stock-status-ok">åœ¨åº«ã‚ã‚Š</span>' : `${item.amount} ${item.unit}`;

                div.innerHTML = `
                    <div class="card-content-wrapper">
                        ${thumbHtml}
                        <div class="card-text-area">
                            <div class="card-tag-row">
                                <span class="tag date-tag ${dateClass}">æœŸé™: ${dateText}</span>
                            </div>
                            <div class="card-name-row">
                                <span class="item-name">${item.name}</span>
                                ${badgeHtml}
                            </div>
                        </div>
                    </div>
                    <div class="item-unit">${amountDisplay}</div>
                `;
                listEl.appendChild(div);
            });
        }
    });
}

document.addEventListener('input', (e) => {
    if (e.target.id === 'inventory-search') {
        const term = e.target.value.toLowerCase().trim();
        if (!term) { renderInventory(inventoryData); return; }
        const filtered = inventoryData.filter(item => {
            const nameMatch = item.name.toLowerCase().includes(term);
            const kanaMatch = item.kana && item.kana.toLowerCase().includes(term);
            return nameMatch || kanaMatch;
        });
        renderInventory(filtered);
    }
});

window.goToFilteredRecipes = function(catalogId, itemName) {
    sessionStorage.setItem('recipe_filter_id', catalogId);
    sessionStorage.setItem('recipe_filter_name', itemName);
    const recipeTab = document.querySelector('a[data-view="recipes"]');
    if(recipeTab) recipeTab.click();
};

----- C:\Users\wasab\OneDrive\ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—\kimichan2\static\js\inventory_locations.js -----
let locations = []; 
// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‹ã‚‰å‘¼ã¹ã‚‹ã‚ˆã†ã«windowã«ç™»éŒ²
window.fetchLocations = function() {
    return fetch('/api/locations')
        .then(res => res.json())
        .then(data => {
            locations = data;
            // èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã«ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
            renderLocationSelects(); 
        })
        .catch(err => console.error(err));
};

window.renderLocationSelects = function() {
    const selects = [document.getElementById('inv-location'), document.getElementById('inv-edit-location')]; 
    selects.forEach(sel => {
        if (!sel) return;
        const currentVal = sel.value;
        sel.innerHTML = '';
        locations.forEach(loc => {
            const opt = document.createElement('option');
            opt.value = loc.name;
            opt.textContent = loc.name;
            sel.appendChild(opt);
  
        }); 
        if (currentVal && locations.some(l => l.name === currentVal)) {
            sel.value = currentVal;
        } else if (locations.length > 0) {
            const other = locations.find(l => l.name === 'ãã®ä»–');
            sel.value = other ? other.name : locations[0].name;
        }
    });
};

window.setupLocationUI = function() {
    const btnManageLoc = document.getElementById('btn-manage-loc');
    const btnLocClose = document.getElementById('btn-loc-close');
    const btnAddLoc = document.getElementById('btn-add-loc'); 
    const locManageOverlay = document.getElementById('modal-loc-manage');

    if(btnManageLoc) {
        btnManageLoc.addEventListener('click', () => {
            renderLocationManageList(); 
            locManageOverlay.classList.add('active');
        });
    }
    if(btnLocClose) {
        btnLocClose.addEventListener('click', () => {
            locManageOverlay.classList.remove('active');
            renderLocationSelects(); 
            // åœ¨åº«ãƒªã‚¹ãƒˆå†æç”»ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã‚’å‘¼ã¶ï¼‰
            if(typeof fetchInventory === 'function') fetchInventory();
        });
    }
    if(btnAddLoc) {
        btnAddLoc.addEventListener('click', () => {
            const name = document.getElementById('new-loc-name').value;
            if(!name) return;
            fetch('/api/locations', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
        
                body: JSON.stringify({name: name}) 
            })
            .then(res => res.json())
            .then(() => {
                document.getElementById('new-loc-name').value = '';
                window.fetchLocations().then(renderLocationManageList); 
            });
    
        });
    }
};

function renderLocationManageList() {
    const ul = document.getElementById('loc-manage-list');
    ul.innerHTML = ''; 
    locations.forEach((loc, index) => {
        const li = document.createElement('li');
        li.className = 'location-manage-item';
        li.innerHTML = `
            <span>${loc.name}</span>
            <div class="loc-actions">
                ${index > 0 ? `<button onclick="moveLocation(${loc.id}, -1)">â†‘</button>` : ''}
                ${index 
< locations.length - 1 ? `<button onclick="moveLocation(${loc.id}, 1)">â†“</button>` : ''} 
                <button onclick="deleteLocation(${loc.id})" style="color:red;">Ã—</button>
            </div>
        `;
        ul.appendChild(li); 
    });
}

window.moveLocation = function(id, direction) {
    const idx = locations.findIndex(l => l.id === id); 
    if (idx < 0) return;
    const newIdx = idx + direction;
    if (newIdx < 0 || newIdx >= locations.length) return; 
    const temp = locations[idx];
    locations[idx] = locations[newIdx];
    locations[newIdx] = temp; 
    fetch('/api/locations', {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(locations) 
    }).then(() => {
        window.fetchLocations().then(renderLocationManageList); 
    });
};

window.deleteLocation = function(id) {
    if(!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return; 
    fetch(`/api/locations?id=${id}`, { method: 'DELETE' }) 
    .then(() => {
        window.fetchLocations().then(renderLocationManageList); 
    });
};

----- C:\Users\wasab\OneDrive\ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—\kimichan2\static\js\inventory_photos.js -----
let fridgePhotos = [];
let uploadTargetLocation = 'ãã®ä»–';

// å†™çœŸãƒ‡ãƒ¼ã‚¿ã®å–å¾—
window.fetchFridgePhotos = function() {
    return fetch('/api/fridge_photos')
        .then(res => res.json())
        .then(data => {
            fridgePhotos = data;
        })
        .catch(err => console.error(err));
};

// å ´æ‰€ã”ã¨ã®å†™çœŸã‚¨ãƒªã‚¢ç”Ÿæˆ (inventory_list.jsã‹ã‚‰å‘¼ã°ã‚Œã‚‹)
window.renderLocationPhotos = function(locationName) {
    const photos = fridgePhotos.filter(p => {
        const pLoc = p.location || 'ãã®ä»–';
        return pLoc === locationName;
    });

    const container = document.createElement('div');
    container.className = 'fridge-snapshot-area';

    // æ’®ã‚‹ãƒœã‚¿ãƒ³
    const addBtn = document.createElement('div');
    addBtn.className = 'btn-add-snapshot';
    addBtn.innerHTML = '<span style="font-size:20px;">ğŸ“·</span><br>æ’®ã‚‹';
    addBtn.onclick = () => {
        uploadTargetLocation = locationName;
        const fileInput = document.getElementById('snapshot-file');
        if (fileInput) {
            fileInput.value = ''; 
            fileInput.click();
        } else {
            console.error("snapshot-file element not found");
        }
    };
    container.appendChild(addBtn);

    // å†™çœŸãƒªã‚¹ãƒˆ
    photos.forEach(photo => {
        const div = document.createElement('div');
        div.className = 'snapshot-card';
        
        const img = document.createElement('img');
        img.src = `/images/${photo.image_path}`;
        img.className = 'snapshot-img';
        img.onclick = () => openPhotoView(photo.image_path);
        
        const delBtn = document.createElement('button');
        delBtn.className = 'btn-delete-snapshot';
        delBtn.textContent = 'Ã—';
        delBtn.onclick = (e) => deleteFridgePhoto(photo.id, e);

        div.appendChild(img);
        div.appendChild(delBtn);
        container.appendChild(div);
    });

    return container;
};

function openPhotoView(path) {
    const modal = document.getElementById('modal-photo-view');
    const img = document.getElementById('photo-view-img');
    if (modal && img) {
        img.src = `/images/${path}`;
        modal.classList.add('active');
    }
}

window.deleteFridgePhoto = function(id, e) {
    e.stopPropagation();
    if (!confirm('ã“ã®å†™çœŸã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    fetch(`/api/fridge_photos?id=${id}`, { method: 'DELETE' })
    .then(() => {
        return window.fetchFridgePhotos();
    })
    .then(() => {
        if (typeof renderInventory === 'function') {
             // ãƒ‡ãƒ¼ã‚¿ã‚’å†æç”»ï¼ˆinventory_list.jsã®é–¢æ•°ï¼‰
             // å¼•æ•°ãŒãªã„ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹å ´åˆãŒã‚ã‚‹ã®ã§ã€ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™ã‹ãƒªãƒ­ãƒ¼ãƒ‰
             // ã“ã“ã§ã¯ç°¡æ˜“çš„ã« window.fetchInventory ã‚’å‘¼ã¶
             if(window.fetchInventory) window.fetchInventory();
        }
    });
};

// UIã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— (app.js ã¾ãŸã¯ initInventory ã‹ã‚‰å‘¼ã°ã‚Œã‚‹)
window.setupPhotoUI = function() {
    const snapshotFile = document.getElementById('snapshot-file');
    const btnPhotoClose = document.getElementById('btn-photo-close');
    const photoViewOverlay = document.getElementById('modal-photo-view');

    if (snapshotFile) {
        snapshotFile.addEventListener('change', async () => {
            const files = snapshotFile.files;
            if (!files || files.length === 0) return;

            // è¤‡æ•°æšå¯¾å¿œï¼ˆæœ€å¤§2æšã¾ã§å‡¦ç†ï¼‰
            const filesToUpload = Array.from(files).slice(0, 2);

            for (const file of filesToUpload) {
                try {
                    // ãƒªã‚µã‚¤ã‚º (æœ€å¤§800px, å“è³ª0.7)
                    const resizedBlob = await resizeImage(file, 800, 0.7);
                    
                    const formData = new FormData();
                    formData.append('photo', resizedBlob, file.name);

                    const uploadRes = await fetch('/api/upload', { method: 'POST', body: formData });
                    const uploadData = await uploadRes.json();
                    
                    if (uploadData.status === 'success') {
                        await fetch('/api/fridge_photos', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ 
                                image_path: uploadData.filename,
                                location: uploadTargetLocation
                            })
                        });
                    }
                } catch(e) {
                    console.error("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—", e);
                    alert(`å†™çœŸ ${file.name} ã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`);
                }
            }

            // æ›´æ–°
            window.fetchFridgePhotos().then(() => {
                if(window.fetchInventory) window.fetchInventory();
            });
        });
    }

    if(btnPhotoClose) {
        btnPhotoClose.addEventListener('click', () => photoViewOverlay.classList.remove('active'));
    }
    if(photoViewOverlay) {
        photoViewOverlay.addEventListener('click', (e) => {
            if(e.target === photoViewOverlay) photoViewOverlay.classList.remove('active');
        });
    }
    
    // ã‚¢ã‚¤ãƒ†ãƒ ç·¨é›†ç”¨ãªã©ã‚‚ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    setupImageUpload('inv-file', 'inv-preview', 'inv-image-path');
    setupImageUpload('inv-edit-file', 'inv-edit-preview', 'inv-edit-image-path');
};

// ç”»åƒãƒªã‚µã‚¤ã‚ºé–¢æ•° (å…±é€šã§ä½¿ç”¨)
function resizeImage(file, maxWidth, quality) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                let width = img.width;
                let height = img.height;

                if (width > maxWidth) {
                    height = Math.round(height * (maxWidth / width));
                    width = maxWidth;
                }

                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                canvas.toBlob((blob) => {
                    resolve(blob);
                }, 'image/jpeg', quality);
            };
            img.onerror = reject;
            img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

function setupImageUpload(inputId, previewId, pathInputId) {
    const input = document.getElementById(inputId);
    const preview = document.getElementById(previewId);
    const pathInput = document.getElementById(pathInputId);

    if(!input) return;

    input.addEventListener('change', async () => {
        const file = input.files[0];
        if (!file) return;

        try {
            const resizedBlob = await resizeImage(file, 600, 0.7);
            const formData = new FormData();
            formData.append('photo', resizedBlob, file.name);

            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å³æ™‚è¡¨ç¤º
            const reader = new FileReader();
            reader.onload = (e) => {
                if(preview) {
                    preview.src = e.target.result;
                    preview.style.display = 'block'; // activeã‚¯ãƒ©ã‚¹ã§ã¯ãªãdisplayåˆ¶å¾¡ã®æ–¹ãŒç¢ºå®Ÿ
                }
            };
            reader.readAsDataURL(resizedBlob);

            fetch('/api/upload', { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    if(pathInput) pathInput.value = data.filename;
                } else {
                    alert('ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            })
            .catch(err => {
                console.error(err);
                alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼');
            });
        } catch(e) {
            console.error(e);
        }
    });
}

----- C:\Users\wasab\OneDrive\ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—\kimichan2\static\js\recipe_edit.js -----
function openRecipeEditModal() {
    const detailModal = document.getElementById('modal-recipe-detail');
    if(detailModal) detailModal.classList.remove('active');
    
    document.getElementById('modal-recipe-title').textContent = 'ãƒ¬ã‚·ãƒ”ç·¨é›†';
    
    if (typeof currentRecipeDetail === 'undefined' || !currentRecipeDetail) return;

    document.getElementById('rec-id').value = currentRecipeDetail.id;
    document.getElementById('rec-name').value = currentRecipeDetail.name;
    document.getElementById('rec-yield').value = currentRecipeDetail.yield || '';
    document.getElementById('rec-url').value = currentRecipeDetail.url;
    
    document.getElementById('rec-process').value = currentRecipeDetail.process;
    document.getElementById('rec-original-process').value = currentRecipeDetail.original_process || '';

    let csvLines = [];
    let lastGroup = null;

    if (typeof currentIngredients !== 'undefined' && currentIngredients && currentIngredients.length > 0) {
        currentIngredients.forEach(ing => {
            if (ing.group_name && ing.group_name !== lastGroup) {
                csvLines.push(`=${ing.group_name}=`);
                lastGroup = ing.group_name;
            } else if (!ing.group_name && lastGroup !== null) {
                lastGroup = null;
            }
            
            const details = ing.details || '';
            const combinedAmount = ing.unit ? `${ing.amount}${ing.unit}` : ing.amount;
            
            csvLines.push(`${ing.name},${combinedAmount},${details}`);
        });
    }
    document.getElementById('rec-csv').value = csvLines.join('\n');
    
    document.getElementById('rec-original-ingredients').value = currentRecipeDetail.original_ingredients || '';

    document.getElementById('modal-recipe').classList.add('active');
}

function setupRecipeUI() {
    const fab = document.getElementById('fab-add-recipe');
    const overlay = document.getElementById('modal-recipe');
    const detailOverlay = document.getElementById('modal-recipe-detail');
    const missingOverlay = document.getElementById('modal-missing-ing');

    const btnCancel = document.getElementById('btn-rec-cancel');
    const btnSave = document.getElementById('btn-rec-save');
    const btnDetailClose = document.getElementById('btn-detail-close');
    const btnDetailEdit = document.getElementById('btn-detail-edit');
    
    const btnMissingCancel = document.getElementById('btn-missing-cancel');
    const btnMissingRegister = document.getElementById('btn-missing-register');

    if (!fab) return;

    fab.addEventListener('click', () => {
        document.getElementById('modal-recipe-title').textContent = 'ãƒ¬ã‚·ãƒ”ç™»éŒ²';
        document.getElementById('rec-id').value = ''; 
        document.getElementById('rec-name').value = '';
        document.getElementById('rec-yield').value = '';
        document.getElementById('rec-url').value = '';
        
        document.getElementById('rec-process').value = '';
        document.getElementById('rec-original-process').value = '';
        
        document.getElementById('rec-csv').value = '';
        document.getElementById('rec-original-ingredients').value = '';
        
        overlay.classList.add('active');
    });

    if(btnCancel) btnCancel.addEventListener('click', () => overlay.classList.remove('active'));
    if(btnDetailClose) btnDetailClose.addEventListener('click', () => detailOverlay.classList.remove('active'));
    if(btnDetailEdit) btnDetailEdit.addEventListener('click', () => openRecipeEditModal());

    if(btnSave) btnSave.addEventListener('click', () => saveRecipe());
    if(btnMissingCancel) btnMissingCancel.addEventListener('click', () => missingOverlay.classList.remove('active'));
    if(btnMissingRegister) btnMissingRegister.addEventListener('click', () => registerMissingItemsAndRetry());
}

function saveRecipe() {
    const id = document.getElementById('rec-id').value;
    const name = document.getElementById('rec-name').value;
    const yieldVal = document.getElementById('rec-yield').value;
    const url = document.getElementById('rec-url').value;
    
    const process = document.getElementById('rec-process').value;
    const origProcess = document.getElementById('rec-original-process').value;
    
    const csvData = document.getElementById('rec-csv').value;
    const origIng = document.getElementById('rec-original-ingredients').value;

    if (!name) return alert('ãƒ¬ã‚·ãƒ”åã¯å¿…é ˆã§ã™');
    if (!csvData) return alert('ææ–™CSVã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');

    const payload = {
        name: name,
        yield: yieldVal,
        url: url,
        process: process,
        original_process: origProcess,
        csv_data: csvData,
        original_ingredients: origIng
    };

    let method = 'POST';
    let endpoint = '/api/recipes';
    if (id) {
        method = 'PUT';
        endpoint = `/api/recipes?id=${id}`;
    }

    fetch(endpoint, {
        method: method,
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
    })
    .then(async res => {
        const data = await res.json();
        
        if (!res.ok && data.error_code === 'missing_ingredients') {
            showMissingIngredientsModal(data.items);
            throw new Error('missing_ingredients');
        }

        if (!res.ok) throw new Error(data.error || 'ç™»éŒ²ã‚¨ãƒ©ãƒ¼');
        return data;
    })
    .then(() => {
        alert(id ? 'ãƒ¬ã‚·ãƒ”ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼' : 'ãƒ¬ã‚·ãƒ”ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼');
        document.getElementById('modal-recipe').classList.remove('active');
        if (typeof fetchRecipes === 'function') fetchRecipes();
    })
    .catch(err => {
        if (err.message !== 'missing_ingredients') {
            alert(err.message);
        }
    });
}

function showMissingIngredientsModal(items) {
    const overlay = document.getElementById('modal-missing-ing');
    const listArea = document.getElementById('missing-list-area');
    listArea.innerHTML = '';
    items.forEach((name, index) => {
        const div = document.createElement('div');
        div.className = 'form-group';
        div.style.background = '#f9f9f9';
        div.style.padding = '10px';
        div.style.borderRadius = '8px';
        div.innerHTML = `
            <div style="font-weight:bold; margin-bottom:5px;">${name}</div>
            <div style="display:flex; gap:10px;">
                <select id="missing-class-${index}" class="input-field" style="padding:8px; font-size:12px;">
                    <option value="é£Ÿæ">é£Ÿæ</option>
                    <option value="èª¿å‘³æ–™">èª¿å‘³æ–™</option>
                </select>
                <input type="hidden" id="missing-name-${index}" value="${name}">
            </div>
        `;
        listArea.appendChild(div);
    });
    overlay.classList.add('active');
}

function registerMissingItemsAndRetry() {
    const listArea = document.getElementById('missing-list-area');
    const itemsToRegister = [];
    const divs = listArea.querySelectorAll('.form-group');
    divs.forEach((div, index) => {
        const name = document.getElementById(`missing-name-${index}`).value;
        const cls = document.getElementById(`missing-class-${index}`).value;
        itemsToRegister.push({
            name: name,
            classification: cls,
            category: cls === 'èª¿å‘³æ–™' ? '' : 'ãã®ä»–',
            default_unit: cls === 'èª¿å‘³æ–™' ? '' : 'å€‹'
        });
    });

    fetch('/api/catalog', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(itemsToRegister)
    })
    .then(res => {
        if (!res.ok) throw new Error('ã‚«ã‚¿ãƒ­ã‚°ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
        return res.json();
    })
    .then(() => {
        document.getElementById('modal-missing-ing').classList.remove('active');
        saveRecipe(); 
    })
    .catch(err => alert(err.message));
}

----- C:\Users\wasab\OneDrive\ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—\kimichan2\static\js\recipe_list.js -----
var recipeData = [];
var currentRecipeDetail = null;
var currentIngredients = [];
var currentMissingItems = []; // â˜…è¿½åŠ : ä¸€æ‹¬è¿½åŠ ç”¨ã«ä¸è¶³ãƒªã‚¹ãƒˆã‚’ä¿æŒ

function initRecipes() {
    const filterId = sessionStorage.getItem('recipe_filter_id');
    const filterName = sessionStorage.getItem('recipe_filter_name');
    
    const searchInput = document.getElementById('recipe-search');
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase().trim();
            if (!term) {
                renderRecipes(recipeData);
                return;
            }
            const filtered = recipeData.filter(item => 
                item.name.toLowerCase().includes(term)
            );
            renderRecipes(filtered);
        });
    }
    
    if (filterId) {
        fetchFilteredRecipes(filterId, filterName);
    } else {
        fetchRecipes();
    }
    
    if (typeof setupRecipeUI === 'function') {
        setupRecipeUI();
    }
}

function fetchRecipes() {
    showFilterHeader(null);
    fetch('/api/recipes?all=true')
        .then(res => res.json())
        .then(data => {
            recipeData = data;
            renderRecipes(recipeData);
        })
        .catch(err => console.error(err));
}

function fetchFilteredRecipes(catalogId, itemName) {
    showFilterHeader(itemName);
    fetch(`/api/recipes?ingredient_id=${catalogId}`)
        .then(res => res.json())
        .then(data => {
            recipeData = data;
            renderRecipes(recipeData);
        })
        .catch(err => console.error(err));
}

function showFilterHeader(itemName) {
    const listEl = document.getElementById('recipe-list');
    const existing = document.getElementById('filter-status-bar');
    if (existing) existing.remove();
    if (!itemName) return;

    const bar = document.createElement('div');
    bar.id = 'filter-status-bar';
    bar.className = 'recipe-group-header';
    bar.style.display = 'flex';
    bar.style.justifyContent = 'space-between';
    bar.style.alignItems = 'center';
    
    bar.innerHTML = `
        <span>ğŸ” ${itemName} ã®ãƒ¬ã‚·ãƒ”</span>
        <button id="btn-clear-filter" style="background:#ddd; border:none; padding:4px 10px; border-radius:15px; font-size:11px; cursor:pointer;">è§£é™¤</button>
    `;
    listEl.parentNode.insertBefore(bar, listEl);

    document.getElementById('btn-clear-filter').addEventListener('click', () => {
        sessionStorage.removeItem('recipe_filter_id');
        sessionStorage.removeItem('recipe_filter_name');
        fetchRecipes();
    });
}

function renderRecipes(items) {
    const listEl = document.getElementById('recipe-list');
    if (!listEl) return;
    listEl.innerHTML = '';
    if (!items || items.length === 0) {
        listEl.innerHTML = '<p class="inventory-empty-msg">ãƒ¬ã‚·ãƒ”ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>';
        return;
    }

    items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'card';
        div.onclick = () => openRecipeDetail(item);
        
        const ingIcon = item.has_ingredients ? '<span class="icon-strong">ğŸ¥¦</span>' : '<span class="icon-faint">ğŸ¥¦</span>';
        const seasIcon = item.has_seasonings ? '<span class="icon-strong">ğŸ§‚</span>' : '<span class="icon-faint">ğŸ§‚</span>';

        div.innerHTML = `
            <div class="card-content">
                <div style="display:flex; align-items:center; gap:8px;">
                    <span class="item-name">${item.name}</span>
                    <span>${ingIcon} ${seasIcon}</span>
                </div>
                <div style="font-size:11px; color:#666;">${item.yield || ''}</div>
            </div>
            <div style="font-size:20px; color:#ccc;">â€º</div>
        `;
        listEl.appendChild(div);
    });
}

function openRecipeDetail(recipe) {
    currentRecipeDetail = recipe;
    
    const modal = document.getElementById('modal-recipe-detail');
    const title = document.getElementById('detail-title');
    const yieldDisplay = document.getElementById('detail-yield');
    const link = document.getElementById('detail-link');
    const process = document.getElementById('detail-process');
    const ingArea = document.getElementById('detail-ingredients');
    const missingAlert = document.getElementById('detail-missing-alert');

    title.textContent = recipe.name;
    yieldDisplay.textContent = recipe.yield ? `(${recipe.yield})` : '';
    process.textContent = recipe.process || 'ï¼ˆä½œã‚Šæ–¹ã®ç™»éŒ²ãªã—ï¼‰';

    if (recipe.url) {
        link.style.display = 'inline-block';
        link.href = recipe.url;
    } else {
        link.style.display = 'none';
    }

    ingArea.innerHTML = '<div style="text-align:center; color:#999;">èª­ã¿è¾¼ã¿ä¸­...</div>';
    if (missingAlert) missingAlert.style.display = 'none';

    fetch(`/api/recipes/ingredients?id=${recipe.id}`)
        .then(res => res.json())
        .then(ingredients => {
            currentIngredients = ingredients || [];
            currentMissingItems = []; // â˜…ãƒªã‚»ãƒƒãƒˆ

            if (!ingredients || ingredients.length === 0) {
                ingArea.innerHTML = '<div style="color:#999;">ææ–™ç™»éŒ²ãªã—</div>';
                return;
            }

            let html = '<ul style="list-style:none; padding:0;">';
            let missingItemsNames = [];
            let currentGroup = "";

            ingredients.forEach(ing => {
                const statusIcon = ing.in_stock ? 'âœ…' : 'âŒ';
                const statusClass = ing.in_stock ? 'ing-status-ok' : 'ing-status-missing';
                
                let addBtnHtml = '';
                if (!ing.in_stock) {
                    missingItemsNames.push(ing.name);
                    // â˜…ä¸€æ‹¬è¿½åŠ ç”¨ã«ä¿æŒ
                    currentMissingItems.push({ id: ing.catalog_id, name: ing.name });

                    // å€‹åˆ¥è¿½åŠ ãƒœã‚¿ãƒ³ã‚‚æ®‹ã™
                    addBtnHtml = `<button class="btn-quick-add" onclick="quickAddToInventory(${ing.catalog_id}, '${ing.name}')">ï¼‹åœ¨åº«ã¸</button>`;
                }

                if (ing.group_name && ing.group_name !== currentGroup) {
                    currentGroup = ing.group_name;
                    html += `<li class="recipe-group-header">${currentGroup}</li>`;
                } else if (!ing.group_name && currentGroup !== "") {
                    currentGroup = "";
                }

                const detailsHtml = ing.details ? `<span style="font-size:11px; color:#666; margin-left:4px;">(${ing.details})</span>` : '';
                const combinedAmount = ing.unit ? `${ing.amount}${ing.unit}` : ing.amount;

                html += `
                <li style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px dashed #eee; padding:8px 0;">
                    <div style="display:flex; align-items:center;">
                        <span class="${statusClass}">
                             ${statusIcon} ${ing.name}${detailsHtml}
                        </span>
                        ${addBtnHtml}
                    </div>
                    <span style="font-weight:bold; font-size:13px;">${combinedAmount}</span>
                </li>`;
            });
            html += '</ul>';
            ingArea.innerHTML = html;

            if (missingItemsNames.length > 0 && missingAlert) {
                missingAlert.style.display = 'block';
                // â˜…ä¸€æ‹¬è¿½åŠ ãƒœã‚¿ãƒ³ã‚’å«ã‚ãŸHTMLã«å¤‰æ›´
                missingAlert.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                        <strong>âš ï¸ è¶³ã‚Šãªã„ã‚‚ã® (${missingItemsNames.length})</strong>
                        <button class="btn-save" style="padding:4px 12px; font-size:11px; background:#27ae60;" onclick="bulkAddMissingToInventory()">ã¾ã¨ã‚ã¦åœ¨åº«ã¸</button>
                    </div>
                    <div style="font-size:12px;">${missingItemsNames.join('ã€')}</div>
                `;
            }
        })
        .catch(err => {
            console.error(err);
            ingArea.innerHTML = '<div style="color:red;">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</div>';
        });

    modal.classList.add('active');
}

// å€‹åˆ¥è¿½åŠ 
window.quickAddToInventory = function(catalogId, name) {
    if (!confirm(`ã€Œ${name}ã€ã‚’åœ¨åº«(ãã®ä»–)ã«è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ`)) return;
    postIngredientToInventory(catalogId, name).then(() => {
        alert(`ã€Œ${name}ã€ã«è¿½åŠ ã—ã¾ã—ãŸï¼`);
        document.getElementById('modal-recipe-detail').classList.remove('active');
        if (typeof fetchInventory === 'function') fetchInventory();
    });
};

// â˜…ä¸€æ‹¬è¿½åŠ 
window.bulkAddMissingToInventory = function() {
    if (currentMissingItems.length === 0) return;
    if (!confirm(`ä¸è¶³ã—ã¦ã„ã‚‹é£Ÿæ ${currentMissingItems.length} ç‚¹ã‚’å…¨ã¦åœ¨åº«ã«è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ`)) return;

    // Promise.allã§ä¸¦åˆ—å®Ÿè¡Œ
    const promises = currentMissingItems.map(item => postIngredientToInventory(item.id, item.name));

    Promise.all(promises)
        .then(() => {
            alert('å…¨ã¦ã®ä¸è¶³é£Ÿæã‚’è¿½åŠ ã—ã¾ã—ãŸï¼');
            document.getElementById('modal-recipe-detail').classList.remove('active');
            if (typeof fetchInventory === 'function') fetchInventory();
        })
        .catch(err => alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + err));
};

// å…±é€šã®è¿½åŠ APIå‘¼ã³å‡ºã—
function postIngredientToInventory(catalogId, name) {
    const catId = parseInt(catalogId, 10);
    if (isNaN(catId) || catId <= 0) {
        return Promise.reject("IDä¸æ­£");
    }

    const data = {
        catalog_id: catId,
        amount: -1, 
        unit: "",
        expiration_date: "",
        location: "ãã®ä»–"
    };

    return fetch('/api/ingredients', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    }).then(async res => {
        if (!res.ok) throw new Error(await res.text());
        return res.json();
    });
}

----- C:\Users\wasab\OneDrive\ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—\kimichan2\static\js\seasoning_fetch.js -----
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦ window ã«å…¬é–‹
window.seasoningData = [];
let catalogListForSeas = [];

function initSeasoning() {
    // åˆå›: åœ¨åº«å–å¾— -> ã‚«ã‚¿ãƒ­ã‚°å–å¾—(ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°) ã®é †ã§å®Ÿè¡Œ
    window.fetchSeasoning().then(() => window.fetchCatalogForSeas());
    if (typeof setupSeasoningUI === 'function') {
        setupSeasoningUI();
    }
}

window.fetchSeasoning = function() {
    return fetch('/api/seasonings')
        .then(res => res.json())
        .then(data => {
            window.seasoningData = data; // windowã«ä¿å­˜
            if (typeof renderSeasoning === 'function') {
                renderSeasoning(window.seasoningData);
            }
        })
        .catch(err => console.error(err));
};

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‹ã‚‰å‘¼ã¹ã‚‹ã‚ˆã†ã«windowã«ç™»éŒ²
window.fetchCatalogForSeas = function() {
    return fetch('/api/catalog')
        .then(res => res.json())
        .then(data => {
            // 1. åœ¨åº«ã«å«ã¾ã‚Œã‚‹ catalog_id ã®ã‚»ãƒƒãƒˆã‚’ä½œæˆ
            const inventoryCatalogIds = new Set(
                window.seasoningData.map(item => item.catalog_id)
            );
            
            // 2. èª¿å‘³æ–™ã§ã‚ã‚Šã€ã‹ã¤åœ¨åº«ã«ãªã„ã‚‚ã®ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            let filteredData = data.filter(item => {
                const isSeasoning = item.classification === 'èª¿å‘³æ–™';
                const isInInventory = inventoryCatalogIds.has(item.id);
                return isSeasoning && !isInInventory;
            });

            // 3. åˆ†é¡ -> ã‚«ãƒ†ã‚´ãƒª -> åå‰/ã‚ˆã¿ãŒãª é †ã§ã‚½ãƒ¼ãƒˆ
            filteredData.sort((a, b) => {
                const compare = (keyA, keyB) => keyA.localeCompare(keyB, 'ja');

                let result = compare(a.classification || '', b.classification || '');
                if (result !== 0) return result;

                result = compare(a.category || '', b.category || '');
                if (result !== 0) return result;

                const ka = a.kana || a.name;
                const kb = b.kana || b.name;
                return compare(ka, kb);
            });
            
            catalogListForSeas = filteredData;
            
            // UIå´ã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³æ›´æ–°é–¢æ•°ã‚’å‘¼ã³å‡ºã—
            if (typeof updateSeasSelect === 'function') {
                updateSeasSelect();
            }
        });
};

----- C:\Users\wasab\OneDrive\ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—\kimichan2\static\js\seasoning_ui.js -----
function updateSeasSelect() {
    const select = document.getElementById('seas-select-catalog');
    if (!select) return;
    
    select.innerHTML = '<option value="">ã‚«ã‚¿ãƒ­ã‚°ã‹ã‚‰é¸æŠ...</option>';
    // catalogListForSeas ã¯ seasoning_fetch.js å†…ã®å¤‰æ•°ã§ã™ãŒã€
    // ã“ã“ã§ã¯å˜ç´”åŒ–ã®ãŸã‚ window.fetchCatalogForSeas å†…ã§ä»£å…¥ã•ã‚ŒãŸå¤‰æ•°ã‚’åˆ©ç”¨ã™ã‚‹å‰æ
    // ã‚‚ã—ãã¯ window.catalogListForSeas ã«ã™ã‚‹ã‹ã€fetchCatalogForSeas å†…ã§æç”»ã¾ã§ã‚„ã‚‹ã®ãŒå®‰å…¨ã§ã™ãŒã€
    // æ—¢å­˜æ§‹é€ ã‚’ç¶­æŒã—ã¤ã¤ã€catalogListForSeasã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒå¿…è¦ãªã‚‰
    // seasoning_fetch.js å´ã§ window.catalogListForSeas = ... ã¨ã—ã¦ã„ã‚‹ã¨ä»®å®šã€
    // ã‚ã‚‹ã„ã¯ã‚¹ã‚³ãƒ¼ãƒ—ãŒå…±æœ‰ã•ã‚Œã¦ã„ã‚‹(é€£çµãƒ•ã‚¡ã‚¤ãƒ«)å‰æãªã‚‰ãã®ã¾ã¾ã§OKã€‚
    // â€»ä»Šå›ã¯å®‰å…¨ç­–ã¨ã—ã¦ã€å‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§å¤‰æ•°ã¯é–‰ã˜ã¦ã„ãŸãŸã‚ã€
    // seasoning_fetch.js ã§ `window.catalogListForSeas` ã«æ›¸ãæ›ãˆã‚‹ã‹ã€
    // UIæ›´æ–°ã‚’ã‚ã¡ã‚‰ã§å‘¼ã‚“ã§ã„ã‚‹ã®ã§ã€DOMæ“ä½œã ã‘ã“ã“ã«æ›¸ãã¾ã™ã€‚
    
    // å‰å›ã®ä¿®æ­£ã§ catalogListForSeas ã¯ seasoning_fetch.js ã®ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã§ã—ãŸã€‚
    // ãŸã  updateSeasSelect ã¯ seasoning_fetch.js ã‹ã‚‰å‘¼ã°ã‚Œã‚‹ã®ã§ã€
    // ãƒ‡ãƒ¼ã‚¿å¼•æ•°ã‚’å—ã‘å–ã‚‹å½¢ã«ã™ã‚‹ã®ãŒãƒ™ã‚¹ãƒˆã§ã™ãŒã€
    // ã“ã“ã§ã¯ `seasoning_fetch.js` ã® `catalogListForSeas` ãŒå‚ç…§ã§ããªã„å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚
    // æœ¬æ¥ã¯å¼•æ•°ã§æ¸¡ã™ã¹ãã§ã™ã€‚
    // ãŸã ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æ§˜ã®ç’°å¢ƒï¼ˆé€£çµã•ã‚Œã‚‹ã‹å€‹åˆ¥ã‹ï¼‰ã«ã‚ˆã‚Šã¾ã™ã€‚
    // â˜…ä¿®æ­£: seasoning_fetch.js ã®å¤‰æ•°ãŒå‚ç…§ã§ããªã„å ´åˆã‚’è€ƒæ…®ã—ã€
    // updateSeasSelect ã¯ DOMç”Ÿæˆã®ã¿ã«å¾¹ã—ã€ãƒ‡ãƒ¼ã‚¿ã¯å¼•æ•°ã¾ãŸã¯windowã‹ã‚‰å–ã‚Œã‚‹ã‚ˆã†ã«ã™ã¹ãã§ã™ãŒ
    // ä¸€æ—¦ã€seasoning_fetch.js å†…ã®å¤‰æ•°ãŒã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«ã‚ã‚‹ï¼ˆscriptã‚¿ã‚°ä¸¦åˆ—ï¼‰ã¨ä»®å®šã—ã¾ã™ã€‚
    // ã‚‚ã—ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹å ´åˆã¯ seasoning_fetch.js ã§ window.catalogListForSeas = ... ã¨ã—ã¦ãã ã•ã„ã€‚
    
    // (è£œè¶³: ä»Šå›ã®æç¤ºã§ã¯ seasoning_fetch.js å†…ã® catalogListForSeas ã¯ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã®ã¾ã¾ã§ã™ãŒ
    //  åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆã¯ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚fetchCatalogForSeaså†…ã§ updateSeasSelect(catalogListForSeas) ã¨å‘¼ã¶ã‚ˆã†å¤‰æ›´ã™ã‚‹ã®ãŒæ­£ã—ã„ã§ã™ã€‚
    //  ã—ã‹ã—å¤‰æ›´ç¯„å›²ã‚’æœ€å°ã«ã™ã‚‹ãŸã‚ã€å‰å›æç¤ºã®æ§‹é€ ã«å¾“ã„ã¾ã™)

    // â˜…ä¿®æ­£: ãƒªã‚¹ãƒˆæ§‹ç¯‰ãƒ­ã‚¸ãƒƒã‚¯
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ãŒå‚ç…§ã§ããªã„ãƒªã‚¹ã‚¯ã‚’å›é¿ã™ã‚‹ãŸã‚ã€
    // æœ¬æ¥ãªã‚‰ fetchCatalogForSeas ã§ updateSeasSelect(list) ã¨å‘¼ã¶ã¹ãã€‚
    // ã“ã“ã§ã¯ã€Œæ—¢å­˜ã‚³ãƒ¼ãƒ‰ãŒå‹•ãå‰æã€ã§è¨˜è¿°ã—ã¾ã™ãŒã€
    // ã‚‚ã—å‹•ã‹ãªã„å ´åˆã¯ seasoning_fetch.js ã®æœ€å¾Œã§ window.catalogListForSeas = catalogListForSeas; ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
    
    if (typeof catalogListForSeas !== 'undefined') {
        catalogListForSeas.forEach(item => {
            const opt = document.createElement('option');
            const classification = item.classification || 'åˆ†é¡ãªã—';
            const category = item.category || 'ã‚«ãƒ†ã‚´ãƒªãªã—';
            const kana = item.kana ? ` (${item.kana})` : '';
            
            opt.value = item.id;
            opt.textContent = `${classification} / ${category} - ${item.name}${kana}`;
            select.appendChild(opt);
        });
    }
}

function renderSeasoning(items) {
    const listEl = document.getElementById('seasoning-list');
    if (!listEl) return;
    listEl.innerHTML = '';
    
    if (items.length === 0) {
        listEl.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">è©²å½“ãªã—</div>';
        return;
    }

    items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'card';
        div.onclick = () => openSeasoningEdit(item);
        
        let statusColor = '#2ecc71'; // ç·‘
        if (item.status === 'å°‘ãªã‚') statusColor = '#f1c40f';
        if (item.status === 'ãªã—') statusColor = '#e74c3c';

        div.innerHTML = `
            <div class="card-content">
                <span class="item-name">${item.name}</span>
            </div>
            <div class="item-unit" style="font-weight:bold; color:${statusColor};">
                ${item.status}
            </div>
        `;
        listEl.appendChild(div);
    });
}

function openSeasoningEdit(item) {
    const overlay = document.getElementById('modal-seasoning-edit');
    document.getElementById('seas-edit-title').textContent = item.name;
    document.getElementById('seas-edit-id').value = item.id;
    overlay.classList.add('active');
}

function setupSeasoningUI() {
    const fab = document.getElementById('fab-add-seasoning');
    const overlay = document.getElementById('modal-seasoning');
    const editOverlay = document.getElementById('modal-seasoning-edit');
    const btnCancel = document.getElementById('btn-seas-cancel');
    const btnSave = document.getElementById('btn-seas-save');
    const select = document.getElementById('seas-select-catalog');
    const searchInput = document.getElementById('seasoning-search'); // â˜…è¿½åŠ 

    // â˜…èª¿å‘³æ–™æ¤œç´¢ãƒ­ã‚¸ãƒƒã‚¯
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase().trim();
            if (!window.seasoningData) return;
            
            if (!term) {
                renderSeasoning(window.seasoningData);
                return;
            }
            const filtered = window.seasoningData.filter(item => 
                item.name.toLowerCase().includes(term)
            );
            renderSeasoning(filtered);
        });
    }

    const btnEditCancel = document.getElementById('btn-seas-edit-cancel');
    const btnDelete = document.getElementById('btn-seas-delete');
    if (!fab) return;

    fab.addEventListener('click', () => overlay.classList.add('active'));
    btnCancel.addEventListener('click', () => overlay.classList.remove('active'));
    if (btnEditCancel) {
        btnEditCancel.addEventListener('click', (e) => {
            e.preventDefault();
            editOverlay.classList.remove('active');
        });
    }

    // è¿½åŠ å‡¦ç†
    btnSave.addEventListener('click', () => {
        const catalogId = parseInt(select.value);
        const status = document.getElementById('seas-status').value;

        if (!catalogId) return alert('èª¿å‘³æ–™ã‚’é¸ã‚“ã§ãã ã•ã„');

        const data = {
            catalog_id: catalogId,
            status: status
        };

        fetch('/api/seasonings', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        })
        .then(res => {
            if (!res.ok) throw new Error('Failed');
            overlay.classList.remove('active');
            
            // åœ¨åº«æ›´æ–°å¾Œã«ã€ã‚«ã‚¿ãƒ­ã‚°(ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³)ã‚‚æ›´æ–°ã™ã‚‹
            return window.fetchSeasoning().then(() => window.fetchCatalogForSeas());
        })
        .catch(err => alert('ã‚¨ãƒ©ãƒ¼: ' + err));
    });

    // å‰Šé™¤å‡¦ç†
    if (btnDelete) {
        btnDelete.addEventListener('click', () => {
            const id = document.getElementById('seas-edit-id').value;
            if(!confirm('ã‚¹ãƒˆãƒƒã‚¯ã‹ã‚‰å¤–ã—ã¾ã™ã‹ï¼Ÿ')) return;

            fetch(`/api/seasonings?id=${id}`, {
                method: 'DELETE'
            })
            .then(res => {
                if (!res.ok) throw new Error('Delete failed');
                editOverlay.classList.remove('active');
                
                // åœ¨åº«æ›´æ–°å¾Œã«ã€ã‚«ã‚¿ãƒ­ã‚°(ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³)ã‚‚æ›´æ–°ã™ã‚‹
                return window.fetchSeasoning().then(() => window.fetchCatalogForSeas());
            })
            .catch(err => alert('å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ' + err));
        });
    }
}

